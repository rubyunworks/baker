#!/usr/bin/ruby -w

# LICENSE
#
# Go for it. Whatever.
# But NEVER FEED THE LAWYERS.
#
# Originally coded by Andrew Walrond
#

require 'net/ftp'
require 'net/http'
require 'base64'
require 'digest/md5'
require 'ftools'
require 'open-uri'
require 'strfile'

RUBYX_VERSION="0.1"
SOLID  = "-"*60+"\n"
DOTTED = "."*60+"\n"
THIS_FILE = IO.readlines(File.expand_path(__FILE__))
SRCDIR = '/home/rubyx/src'
BK_AUTHORITY='/etc/bk-authority'

StandardLocations = %w{bin sbin etc fonts include man info lib kernel opt/bin pkg www usr}

#===============================================================================
# Useful global functions
#===============================================================================

#-------------------------------------------------------------------------------
def data(label) # |line|   Retrieve lines from the data section
#-------------------------------------------------------------------------------
  start=0
	THIS_FILE.each { |line|
		if start==0
			start=1 if line =~ %r{^=begin #{Regexp.escape(label)} -*}
		else
			break if line =~ %r{^=end -*}
			yield line if block_given?
		end
	}
	end

#-----------------------------------------------------------------------------
def getdata(dest,name,mode)
#-----------------------------------------------------------------------------
	User.asroot {
		start=0
		File.makedirs(dest) unless dest.directory?
		fn = path(dest,name)
		File.open(fn,File::CREAT|File::WRONLY,mode) { |file|
			data(name) { |line|
				yield line if block_given?
				file.puts line
			}
		}
	}
end

#===============================================================================
module User
#===============================================================================

  private

  @@unprivilegedUID=nil
  @@unprivilegedGID=nil

  public

	def set(user,group); @@unprivilegedUID,@@unprivilegedGID = user,group; end

  #-----------------------------------------------------------------------------
	def uid(); return @@unprivilegedUID; end
  #-----------------------------------------------------------------------------

  #-----------------------------------------------------------------------------
  def User.create(user)  # user - String
	#-----------------------------------------------------------------------------		
		unless system('id -u rubyx > /dev/null 2>&1')
			puts "Creating an unprivileged 'rubyx' user..."
			raise "Unable to create user '#{user}'" unless system('useradd','-s/bin/false',user)
		end
		@@unprivilegedUID = `id -u #{user}`.chomp.to_i
		@@unprivilegedGID = `id -g #{user}`.chomp.to_i
  end

  #-----------------------------------------------------------------------------
  def User.asroot()
	#-----------------------------------------------------------------------------
		egid, euid = Process.egid, Process.euid
		Process.egid, Process.euid = 0,0
		home,ENV['HOME'] = ENV['HOME'],'/home/root'
		begin
			return yield
		ensure
			Process.egid,Process.euid=egid,euid
			ENV['HOME'] = home
		end if block_given?
  end

  #-----------------------------------------------------------------------------
  def User.aseuid(u=nil,g=nil) #Pretend to be a user, but can become root again
	#-----------------------------------------------------------------------------
		egid,euid = Process.egid,Process.euid
		Process.egid,Process.euid = 0,0
		Process.egid = (g ? g.to_i : @@unprivilegedGID)
		Process.euid = (u ? u.to_i : @@unprivilegedUID)
		home,ENV['HOME'] = ENV['HOME'],'/home/rubyx'
		begin
			return yield
		ensure
			Process.egid,Process.euid = 0,0
			Process.egid,Process.euid = egid,euid
			ENV['HOME'] = home	  
		end if block_given?
  end

  #-----------------------------------------------------------------------------
  def User.asuid(u=nil,g=nil) #Become user. Cannot become root again
	#-----------------------------------------------------------------------------
		Process.gid = (g ? g : @@unprivilegedGID)
		Process.uid = (u ? u : @@unprivilegedUID)
  end

end


#===============================================================================
class Link
#===============================================================================

  #:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
  protected
  #:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

  #-----------------------------------------------------------------------------
  def initialize()
	#-----------------------------------------------------------------------------
		@givers={} #oref=>TOOL|NEED|WANT|SYNC
		@takers={} #oref=>TOOL|NEED|WANT|SYNC
		@name = self.class.to_s.downcase[4..99].gsub('_','-')
		@@all[@name]=self
		@task=TASK_NONE
  end

  #:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
  protected
  #:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

  WANT,TOOL,NEED,SYNC=0,1,2,3
  @@all={}    # name=>oref
  @@groups={} # name=>[orefs]

  #-----------------------------------------------------------------------------
  def    tools(*names); names.each { |p| givers[p]=TOOL }; end
  def    needs(*names); names.each { |p| givers[p]=NEED }; end
  def    wants(*names); names.each { |p| givers[p]=WANT }; end
  def syncwith(*names); names.each { |p| givers[p]=SYNC }; end
  #-----------------------------------------------------------------------------

  #-----------------------------------------------------------------------------
  def join(*grps)
	#-----------------------------------------------------------------------------
		grps.each { |g|
			if @@groups[g] then @@groups[g].push(self); else @@groups[g]=[self]; end
		}
  end

  #:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
  public
  #:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

  TASK_UNDO,TASK_NONE,TASK_DO,TASK_DO_FORCED = -1, 0, 1, 2

  attr_reader :task, :givers, :takers
  attr_writer :task, :givers, :takers

  #-----------------------------------------------------------------------------
  def to_s(); return @name; end
  #-----------------------------------------------------------------------------

  #-----------------------------------------------------------------------------
	def Link.all(); return @@all; end
  def Link.each(); @@all.each { |name,link| yield name,link }; end
  def Link.find(name); return @@all[name]; end
  #-----------------------------------------------------------------------------

  #-----------------------------------------------------------------------------
  def Link.findGrps(pattern)
	#-----------------------------------------------------------------------------
		return @@groups.keys.delete_if { |name| pattern and !name.index(pattern) }
  end

  #-----------------------------------------------------------------------------
  def Link.findPkgs(pattern)
	#-----------------------------------------------------------------------------
		return @@all.keys.delete_if { |name| pattern and !name.index(pattern) }
  end

  #-----------------------------------------------------------------------------
  def Link.fixup()
	#-----------------------------------------------------------------------------
		@@all.each_value { |link|
			newgivers={}
			link.givers.each { |name,level|
				Link.expand(name).each { |giver|
					newgivers[giver] = level
					giver.takers[link] = level #Let the giver know we are a taker
				}
			}
			link.givers = newgivers
		}
  end

  #-----------------------------------------------------------------------------
  def Link.expand(names) # input [strings], output [Objects]
	#-----------------------------------------------------------------------------
		links=[]
		names.each { |n|
			if @@groups[n]
				links.concat(@@groups[n])
			elsif @@all[n]
				links.push(@@all[n])
			elsif n=='all'
				return @@all.values
			else
				raise "Unknown name "+n
			end
		}
		return links.uniq
  end

  #-----------------------------------------------------------------------------
  def tag(task)
	#-----------------------------------------------------------------------------
		if task>=TASK_DO and @task==TASK_NONE  # Don't override TASK_UNDO
			@task = TASK_DO
			takers.each { |taker,need|
				taker.tag(TASK_DO) if taker.home and (need==SYNC or (need==WANT and !home))
			}
			givers.each { |giver,need|
				next if giver.home()
				giver.tag(TASK_DO) if need==NEED or need==SYNC or (need==TOOL and $root=='/')
			}
		elsif task==TASK_UNDO and @task != TASK_UNDO
			@task = TASK_UNDO
			takers.each { |taker,need| 
				next unless taker.home()
				taker.tag(TASK_UNDO) if need==NEED or NEED==SYNC
				taker.tag(TASK_DO) if need==WANT
			}
		end
  end
  
  #-----------------------------------------------------------------------------
  def Link.orderJobs(names,task)
	#-----------------------------------------------------------------------------
		links = expand(names)
		links.delete_if { |l|
			$upgrade ? (!l.installed or (l.installed[0] == l.select[0])) : l.installed
		} if task==TASK_DO
		links.delete_if { |l| !l.installed } if task==TASK_UNDO
		links.each { |l| l.tag(task) }

		#Now get the tasks in order of execution
		order=[] 
		loop {
			batch={}
			@@all.each_value { |link|
				next if link.task==TASK_NONE
				ready=true
				link.givers.each_key { |giver|
					ready=false unless giver.task==TASK_NONE
					break unless ready
				}
				batch[link]=link.task if ready
			}
			break if batch.empty?
			batch.each_key { |link| link.task=TASK_NONE }
			order.push(batch)
		}
		return order
  end

end

#===============================================================================
class Package < Link
#===============================================================================

  #:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
  private
  #:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

  #-----------------------------------------------------------------------------
  def initialize(description,*defaults)
	#-----------------------------------------------------------------------------
		super()
		@stable      = defaults  #This is an array
		@select      = nil       #This is an array
		@installed   = nil
		@description = description
		@versions    = {}
		@inferiors   = {}
		@ipri        = 9
		@libdirs     = []
  end

  #-----------------------------------------------------------------------------
  def override(*names); @inferiors=names; end
  #-----------------------------------------------------------------------------

  #-----------------------------------------------------------------------------
  def extralibs(*dirs); @libdirs.push(*dirs); end
  #-----------------------------------------------------------------------------

	#-------------------------------------------------------------------------------
	def extractCvsTags(dir,repo)
	#-------------------------------------------------------------------------------
		tags=Hash.new #Use hash because array could get huge with repeated tags
		path(dir,repo).lsd { |fn| next unless fn[-2,2]==',v'
			started=false
			IO.foreach(fn) { |line|
				if !started
					started=true if line[0..6] == 'symbols'
				else
					break unless (line =~ /(?:\s+)(\S+)(?::)/)
					tags[$1]=1
				end
			}
		}
		path(dir,repo.split('/')[0]+'.tags').fwrite(tags.keys.sort.uniq.join("\n"))
	end

	#-------------------------------------------------------------------------------
	def extractBkTags(dir,repo)
	#-------------------------------------------------------------------------------
		tags=Array.new
		path(dir,repo).cd {
			tags = `bk changes -t | grep TAG:`.gsub(/ *TAG: */,'').split.uniq
		} if path(dir,repo).exists?
		path(dir,repo+'.tags').fwrite(tags.join("\n"))
	end

  #-----------------------------------------------------------------------------
	def readAnyTags(dir)
  #-----------------------------------------------------------------------------
		dir.cd {
			Dir.glob('*.tags').each { |tagfile|
				tagfile.fread().each { |tag|
					@versions[tag]=[tagfile[0..-6]] unless @versions[tag] }
			}
		} if dir.exists?
	end

  #-----------------------------------------------------------------------------
	ASROOT=true
  def bash(cmd,root=false)
	#-----------------------------------------------------------------------------
		pid = Process.fork {
			#The process cannot regain superuser status after User.asuid
			if root then User.asroot; else User.asuid; end
			puts cmd
			exit 0 if system(cmd)
			puts(("*"*24)+" FAILED "+("*"*24))
			exit 1
		}
		raise cmd unless Process.waitpid2(pid)[1] == 0
  end

  #-----------------------------------------------------------------------------
  def popen(cmd,str,root=false)
	#-----------------------------------------------------------------------------
		pid = Process.fork {
			#The process cannot regain superuser status after User.asuid
			if root then User.asroot; else User.asuid; end
			begin
				IO.popen(cmd,"w+") { |f|
					f<<str
					while s=f.gets(nil); puts s; end
				}
			rescue
				puts(("*"*24)+" FAILED "+("*"*24))
				exit 1
			end
			exit 0
		}
		raise cmd unless Process.waitpid2(pid)[1] == 0
  end

  #-----------------------------------------------------------------------------
  def globaledit(pattern,replacement)
	#-----------------------------------------------------------------------------
		Dir.getwd.lsd { |fn|
			if !fn.symlink? and fn.file?
				fn.fedit { |l| puts "  #{fn}: "+l if l.gsub!(pattern,replacement) }
			end
		}
  end
  
  #:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
  public
  #:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

  attr_reader :versions, :select, :stable, :installed, :desc, :inferiors,
							:ipri, :libdirs
  attr_writer :select, :installed, :ipri

  #-----------------------------------------------------------------------------
  def checkout(repo,mod,tag)
	#-----------------------------------------------------------------------------
		repository = path($root,SRCDIR,@name,repo)
		options = ( tag[0,5] == 'date:' ? "-D"+tag[5,99] : '-r'+tag )
		bash "cvs -Q -d "+repository+" co "+options+" "+mod
  end
  
  #-----------------------------------------------------------------------------
  def patch(pname,level=1)
	#-----------------------------------------------------------------------------
		raise unless system("patch -E -p#{level} -i #{path($root,SRCDIR,@name,pname)}")
  end

  #-----------------------------------------------------------------------------
	def home() #Returns nil if not installed
  #-----------------------------------------------------------------------------
		highest = 0
		Dir.glob(path($root,'pkg',@name+'.*')).each { |e|
			i=e.slice(/\d+$/).to_i
			if i > highest then highest = i; end
		}
		return ( highest>0 ? path('/','pkg',@name+'.'+highest.to_s) : nil )
	end

  #-----------------------------------------------------------------------------
	def newhome()
	#-----------------------------------------------------------------------------
		highest = 0
		Dir.glob(path($root,'pkg',@name+'.*')).each { |e|
			i=e.slice(/\d+$/).to_i
			if i > highest then highest = i; end
		}
		return path('/','pkg',@name+'.'+(highest+1).to_s)
	end

  #-----------------------------------------------------------------------------
	def list(); @versions.each { |v| puts(v[0]+'  ('+v[1..99].join(',')+')') }; end
  #-----------------------------------------------------------------------------

  #-----------------------------------------------------------------------------
	def unpack(filename,location=path($root,SRCDIR,@name))
  #-----------------------------------------------------------------------------
		case filename
			when /.*gz$/  then bash "tar -xzf "+path(location,filename)
			when /.*bz2$/ then bash "tar -xjf "+path(location,filename)
			when /.zip$/  then bash "unzip    "+path(location,filename)
			else raise "Unpack failed"
		end
	end

  #-----------------------------------------------------------------------------
  def build(extraconfig='',extramake='')
  #-----------------------------------------------------------------------------
		unpack @versions[@select[0]][0]
		Dir.glob('*')[0].cd
		@versions[@select[0]][1..99].each { |p|
			break unless p.class == Array
			puts('Applying patch'+p[0])
			patch(p[0],p[1])
		}
		yield if block_given?
		bash "./configure #{stdconfig} "+extraconfig
		bash "make -j#{$make_jobs} #{extramake}"
		bash "make #{extramake} install"
  end

  def     prefix(*x);    return path(home,              *x); end
  def     bindir(*x);    return path(home,'bin',        *x); end
  def     cmddir(*x);    return path(home,'cmd',        *x); end
  def    sbindir(*x);    return path(home,'sbin',       *x); end
  def     libdir(*x);    return path(home,'lib',        *x); end
  def libexecdir(*x);    return path(home,'libexec',    *x); end
  def     etcdir(*x);    return path(home,'etc',        *x); end
  def     incdir(*x);    return path(home,'include',    *x); end
  def    datadir(*x);    return path(home,'share',      *x); end
  def     mandir(n=nil); return path(home,'man' + (n ? "/man#{n}" : "")); end
  def    infodir(*x);    return path(home,'info',       *x); end
	def     docdir(*x);    return path(home,'doc',        *x); end
	def  configdir(*x);    return path(home,'config',     *x); end
	def   statedir(*x);    return path(home,'state',      *x); end
	def     wwwdir(*x);    return path(home,'www',@name,  *x); end
	def     envdir(*x);    return path(home,'env',        *x); end

	def stdconfig()
		return "--prefix='#{prefix}' "+
			"--libexecdir='#{bindir}/libexec' --datadir='#{datadir}' --includedir='#{incdir}' "+
			"--infodir='#{infodir}' --mandir='#{mandir}' --sysconfdir='#{configdir}' "+
			"--localstatedir='#{statedir}'"
	end

  #-----------------------------------------------------------------------------
  def Package.CalculateInstallPriorities
  #-----------------------------------------------------------------------------
		Link.each() { |name,link|
			link.inferiors.each { |iname|
				iobj = Link.find(iname)
				raise "#{name} has noexistent inferior #{iname}" unless iobj
				raise "Override clash between #{name} and #{iname}" if iobj.inferiors.include?(name)
			}
		}
		change=true
		while change
			change=false
			Link.each() { |name,link|
				link.inferiors.each { |iname|
					iobj = Link.find(iname)
					if link.ipri >= iobj.ipri
						link.ipri = iobj.ipri-1
						change=true
						raise "Install priority has reached zero for #{name}" if link.ipri<=0
					end
				}
			}
		end
	end

end

################################################################################
################################################################################
################################################################################
################################################################################
###                                                                          ###
###                             The Packages                                 ###
###                                                                          ###
################################################################################
################################################################################
################################################################################
################################################################################

#===============================================================================
class Pkg_ < Package   #A template to use as a starting point for new packages
#===============================================================================

  def initialize()
		super('description','default-version')
		@versions={
			'version'=>[]
		}
		join()
		tools()
		needs('base')
		wants()
		syncwith()
  end

  #def build(); end

end; #Pkg_.new()  #REMEMBER TO FILL AND UNCOMMENT THIS DECLARATION

#===============================================================================
class RubyModule < Package
#===============================================================================

  def initialize(description,version)
		super('Ruby module: '+description,version)
		join('ruby-modules')
		syncwith('ruby')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd		
		ENV['DESTDIR']=prefix
		bash "ruby install.rb"
  end

end

#===============================================================================
class PerlModule < Package
#===============================================================================

  def initialize(description,version)
		super('Perl module: '+description,version)
		join('perl-modules')
		syncwith('perl')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "perl Makefile.PL PREFIX=#{prefix}/"
		bash 'make'
		bash 'make test' if $check
		bash 'make install'
	end

end

#===============================================================================
class KdePackage < Package
#===============================================================================

  def initialize(description,version)
		super('Kde: '+description,version)
		needs('bzip2','openssl','lesstif','pcre','libxml2','libxslt','qt','audiofile',
		      'docbook','fam')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		ENV['QTDIR']='/usr/qt'
		ENV['KDEDIR']='/usr/kde'
		ENV['PATH']='/bin/distcc-masquerade:'+ENV['PATH'] if $distcc
		#Some kde packages can't find libstdc++.so.5 without this. Why???
		ENV['LD_LIBRARY_PATH'] = $glibc.configdir('ld.so.conf').fread.join(':')
		#Kde 3.1.3 doesn't expect new Qt 3.2, so fix configure script
		'configure'.freplace('kde_qtsubver=1','kde_qtsubver=2')
		bash "./configure --prefix=/usr/kde"
		bash "make -j#{$make_jobs}"
		bash "make DESTDIR=#{prefix} install"
		envdir('KDEDIR').fwrite('/usr/kde')
		envdir('PATH').fwrite('/usr/kde/bin')
  end

end

#===============================================================================
class GnomePackage < Package
#===============================================================================

  def initialize(description,version)
		super('Gnome: '+description,version)
		needs('pkgconfig','fontconfig','freetype','docbook','libpng','libjpeg','libtiff',
		      'libart-lgpl','xfree86','popt','bzip2','zlib','fam','libxml2','libxslt',
		      'audiofile')
		extralibs('/usr/gnome/lib')
  end

  def build(extraconfig='',extramake='')
		unpack @versions[@select[0]][0]
		Dir.glob('*')[0].cd
		@versions[@select[0]][1..99].each { |p|
			break unless p.class == Array
			puts('Applying patch'+p[0])
			patch(p[0],p[1])
		}
		bash("chown -R rubyx: /usr/gnome/etc",ASROOT)
		ENV['LD_LIBRARY_PATH']=prefix('usr/gnome/lib')
		bash "./configure --prefix=/usr/gnome "+extraconfig
		bash "make -j#{$make_jobs} #{extramake}"
		bash "make DESTDIR=#{prefix} #{extramake} install"
		envdir('PATH').fwrite('/usr/gnome/bin')
		envdir('PKG_CONFIG_PATH').fwrite('/usr/gnome/lib/pkgconfig')
  end
	def post()
		bash("chown -R root: /usr/gnome/etc",ASROOT)
	end
end


#===============================================================================
class Pkg_Acx100 < Package
#===============================================================================

  def initialize()
		super('Driver module for 22Mbps wireless cards based on Texas Instruments ACX100 chipset','0.2.0pre3')
		@versions = {
			'0.2.0pre3'=>['acx100.acx100_0_2_0_pre3','v0903a.zip']
		}
		needs('wireless-tools')
		join('driver')
  end

  def build()
		path($root,SRCDIR,@name,@versions[@select[0]][0]).rcp('.')
		unpack @versions[@select[0]][1]
		File.syscopy('v0903a/acx100_pci.o','firmware')
		'Configure'.freplace('`uname -r`',$linux.select[0][1..9])
		bash "make"
		bash "make extract_firmware"
		File.makedirs(libdir('modules',$linux.select[0][1..9],'net'))
		File.syscopy('src/acx100_pci.o',libdir('modules',$linux.select[0][1..9],'net'))
		prefix('firmware').mkdir
		File.syscopy(Dir.glob('firmware/*.BIN')[0],prefix('firmware'))
		configdir.mkdir
		configdir('module-options').ftouch('debug=0x9b','firmware_dir='+prefix('firmware'))
		configdir('device-name').ftouch('wlan0')
		configdir('wireless-settings').ftouch('rate 11M','#channel 10','#txpower 18',
																					'mode ad-hoc','#key ','essid MyWirelessNet')
		configdir('acx100-enabled').ftouch("# Enable acx100 module, yes/no","yes")
  end

end; Pkg_Acx100.new()

#===============================================================================
class Pkg_Apache < Package
#===============================================================================

  def initialize()
		super('Apache HTTP server','2.0.47')
		@versions={
			'2.0.47'=>['httpd-2.0.47.tar.gz']
		}
		needs('expat')
		join('server')
  end

	def build
		super()
		configdir('apache-enabled').ftouch("# yes/no/on/off","yes")
		configdir('start-cmd').ftouch('#apachectl options to start server',
																	'#Leave blank to disable apache','start')		
		configdir('stop-cmd').ftouch('#apachectl options to stop server','stop')
		datadir('htdocs').rrm
		'/www'.link(datadir('htdocs'))
		configdir('httpd.conf').fcat("\n#Make apache docs available under /apache as well as /manual",
																 "AliasMatch ^/apache(?:/(?:de|en|fr|ja|ko|ru))?(/.*)?$ \"#{datadir('manual')}$1\"")
		prefix('www').mkdir
		datadir('manual').link(wwwdir)
	end

end; Pkg_Apache.new()

#===============================================================================
class Pkg_Autoconf < Package
#===============================================================================

  def initialize()
		super('Programming tool to automate makefile creation','2.57')
		@versions={
			'2.57'=>['autoconf-2.57.tar.bz2']
		}
		join('base')
		needs('perl','sed')
  end

end; Pkg_Autoconf.new()

#===============================================================================
class Pkg_Automake < Package
#===============================================================================

  def initialize()
		super('Programming tool to automate makefile creation','1.7.6')
		@versions={
			'1.7.6'=>['automake-1.7.6.tar.bz2']
		}
		join('base')
		needs('autoconf')
  end

end; Pkg_Automake.new()

#===============================================================================
class Pkg_Bash < Package
#===============================================================================

  def initialize()
		super('The Bourne Again Shell - an enhanced Bourne compatible shell','2.05b')
		@versions={
			'2.05b'=>['bash-2.05b.tar.gz',['bash205b-001',0],['bash205b-002',0],['bash205b-003',0],
			          ['bash205b-004',0],['bash205b-005',0],['bash205b-006',0],['bash205b-007',0]]
		}
		join('base')
		tools('sed')
		needs('ncurses')
		override('busybox')
  end

  def build()
		super('','-j1')
		File.symlink('bash',bindir('sh'))
		getdata(etcdir,'profile',0644)
  end

end; Pkg_Bash.new()

#===============================================================================
class Pkg_Bcm4400 < Package
#===============================================================================

  def initialize()
		super('Broadcom\'s BCM4400/4401 drivers','2.0.5')
		@versions = {'2.0.5'=>['bcm4400-2.0.5.zip']}
		tools('coreutils')
		syncwith('linux')
		join('driver')
  end

  def build()
		unpack @versions[@select[0]][0]
		'linux'.cd
		unpack(Dir.glob('*.tar.gz')[0],'.')
		'src'.cd
		bash "make LINUX=#{$linux.source}"
		File.makedirs(mandir(4))
		bash "make PREFIX=#{prefix} LINUX=#{$linux.source} install"
		configdir('bcm4400-enabled').ftouch("# yes/no/on/off","yes")
		configdir('module-options').ftouch("#Module options. see man bcm4400")
  end

end; Pkg_Bcm4400.new()

#===============================================================================
class Pkg_BerkeleyDB < Package
#===============================================================================

  def initialize()
		super('Berkeley Database','4.1.25')
		@versions={
			'4.1.25'=>['db-4.1.25.tar.gz',['patch.4.1.25.1',1]]
		}
		join('base')
		tools('coreutils','sed')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*/build_unix')[0].cd
		bash "../dist/configure #{stdconfig}"
		bash "make -j#{$make_jobs}"
		bash "make install"
  end

end; Pkg_BerkeleyDB.new()

#===============================================================================
class Pkg_Binutils < Package
#===============================================================================

	def extractTags()
		extractCvsTags(path($root,SRCDIR,@name),'sources.redhat/src/binutils')
	end

	def readTags()
		readAnyTags(path($root,SRCDIR,@name))
	end

  def initialize()
		super('Binary utilities for creating and manipulating executables','binutils-2_14-branch')
		@versions={ 'binutils-2_14'=>['sources.redhat'],
		            'binutils-2_14-branch'=>['sources.redhat'] }
		join('base')
		tools('cvs', 'gettext', 'texinfo')
		override('busybox','gcc')
  end

  def build()
		checkout('sources.redhat','binutils',@select[0])
		'work'.mkdir.cd
		bash "../src/configure #{stdconfig} --host=#{$host.full} --enable-shared --disable-nls"
		bash "make -j#{$make_jobs}"
		bash "make -j#{$make_jobs} check" if $check
		bash "make DESTDIR=#{$root} install"
  end

end; $binutils = Pkg_Binutils.new()

#===============================================================================
class Pkg_Bison < Package
#===============================================================================

  def initialize()
		super('A general purpose parser generator','1.875')
		@versions={
			'1.875'=>['bison-1.875.tar.bz2']
		}
		join('base')
		needs('m4')
  end

end; Pkg_Bison.new()

#===============================================================================
class Pkg_Bitkeeper < Package
#===============================================================================

  def initialize()
		super('Version control tool','3.0.3')
		@versions = {
			'3.0.3'=>['bk-3.0.3-x86-glibc22-linux.bin']
		}
		join('base')
		tools('tar')
  end

  def build()
		cmddir.mkdir
		User.asroot { path($root,SRCDIR,@name,@versions[@select[0]][0]).chmod(0755) }
		bash "echo #{prefix} | "+path($root,SRCDIR,@name,@versions[@select[0]][0])
		%w{ admin get delta unget rmdel prs bk }.each { |f|
			File.symlink(prefix('bitkeeper',f),cmddir(f)) }
		bindir('bkd').fwrite('#!/bin/ruby',"require 'strfile'",
												 '"/etc/environment".fread.each { |v| v =~ /export (.*)=(.*)/; ENV[$1]=$2 }',
												 'exec "bk bkd -C"'
												 ).chmod(0755)
		statedir.mkdir
		configdir('bitkeeper-enabled').ftouch("# yes/on/no/off","no")
		configdir('bkd-root').ftouch('# bkd root directory','/home/bk')
		configdir('bkd-options').ftouch('#bk bkd options. see bk help bkd',
																		'-C','-l'+statedir('access.log'),'-xpush')
  end

end; Pkg_Bitkeeper.new()

#===============================================================================
class Pkg_Busybox < Package
#===============================================================================

  def initialize()
		super('Minimal replacement for a whole host of core tools','1.00-pre2')
		@versions = {
			'1.00-pre2'=>['busybox-1.00-pre2.tar.bz2','busybox-1.00-pre2.config']
		}
		join('base')
		tools('coreutils') #Needs install from coreutils
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		File.syscopy(path($root,SRCDIR,@name,@versions[@select[0]][1]),'.config')
		'.config'.freplace('MYPREFIX',path($root,prefix))
		bash "make oldconfig"
		bash "make -j#{$make_jobs} dep"
		bash "make -j#{$make_jobs}"
		bash "make install"
  end

end; Pkg_Busybox.new()

#===============================================================================
class Pkg_Bzip2 < Package
#===============================================================================

  def initialize()
		super('File compression utility','1.0.2')
		@versions = {'1.0.2'=>['bzip2-1.0.2.tar.gz']}
		join('base')
		override('busybox')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "make"
		bash "make PREFIX=#{prefix} install"
		bash "make -f Makefile-libbz2_so"
		bash "cp -d libbz2.so* #{libdir}"
  end

end; Pkg_Bzip2.new()

#===============================================================================
class Pkg_Cdparanoia < Package
#===============================================================================

  def initialize()
		super('cd audio ripping tools and library','III-alpha9.8')
		@versions = {'III-alpha9.8'=>['cdparanoia-III-alpha9.8.src.tgz']}
		tools('coreutils')
		join('multimedia','workstation')
  end

  def build()
		super('',"-j1 BINDIR=#{bindir} MANDIR=#{mandir} INCLUDEDIR=#{incdir} LIBDIR=#{libdir}")
  end

end; Pkg_Cdparanoia.new()

#===============================================================================
class Pkg_Clamav < Package
#===============================================================================

  def initialize()
		super('Clam AntiVirus toolkit','0.60')
		@versions={
			'0.60'=>['clamav-0.60.tar.gz']
		}
		join('workstation','server')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "./configure #{stdconfig}"
		bash "make -j#{$make_jobs}"
		bash "make install",ASROOT  #Yuk! fix this when I get a minute
		User.asroot { configdir('freshclam-enabled').ftouch("# yes/no/on/off","yes") }
  end

end; Pkg_Clamav.new()

#===============================================================================
class Pkg_Coreutils < Package
#===============================================================================

  def initialize()
		super('The core unix tools','5.0')
		@versions = {'5.0'=>['coreutils-5.0.tar.bz2']}
		join('base')
		override('busybox')
		tools('sed')
  end

end; Pkg_Coreutils.new()

#===============================================================================
class Pkg_Conexant_ADSL < Package
#===============================================================================

  def initialize()
		super('Conexant ADSL drivers','6.1.2.007')
		@versions={
			'6.1.2.007'=>['Tigris_K2_Linux.zip','conexant-6.1.2.007.patch']
		}
		tools('coreutils','unzip')
		syncwith('linux')
		join('driver')
  end

  def build()
		unpack(@versions[@select[0]][0])
		unpack('Tigris_K2.4.3_Driver.zip','.')
		'Tigris_K2.4.3_Driver'.cd
		unpack('CnxADSL-TgrATM_k2.4.3-6.1.2.007.tar.gz','.')
		'CnxADSL-TgrATM_k2.4.3-6.1.2.007'.cd
		patch('conexant-6.1.2.007.patch')
		%w{KernelModule/loadmodule.sh KernelModule/Makefile}.each { |fn|
			fn.freplace('/usr/src/linux',$linux.source) }
		'ConfigLabels.h'.freplace('/etc/Conexant',configdir)
		'DownLoadApp/Makefile'.freplace('etc/Conexant','config')
		bash "make -j#{$make_jobs}"
		bash "make DESTDIR=#{prefix} install"
		configdir.mkdir
		configdir('conexant-adsl-enabled').ftouch("# yes/no/on/off","yes")
  end

end; Pkg_Conexant_ADSL.new()

#===============================================================================
class Pkg_Cups < Package
#===============================================================================

  def initialize()
		super('Common Unix Printing System','1.1.19')
		@versions = {'1.1.19'=>['cups-1.1.19-source.tar.bz2']}
		needs('libjpeg','libpng','libtiff','zlib','ghostscript')
		join('workstation','server','printing')
  end

  def build()
		super('','INITDIR="" INITDDIR=""')
		bindir('lppasswd').chmod(04755)
		getdata(libdir('cups/backend'),'sambafax',0755)
		configdir('cups-enabled').ftouch("# yes/no/on/off","no")
  end

end; Pkg_Cups.new()

#===============================================================================
class Pkg_Curl < Package
#===============================================================================

  def initialize()
		super('A multi-protocol file transfer library','7.10.6')
		@versions={'7.10.6'=>['curl-7.10.6.tar.bz2']}
		wants('openssl')
  end

  def build()
		ENV["PATH"]="/bin/distcc-masquerade:"+ENV["PATH"] if $distcc
		super()
  end

end; Pkg_Curl.new()

#===============================================================================
class Pkg_Cvs < Package
#===============================================================================

  def initialize()
		super('Concurrent version control system','1.11.5')
		@versions={'1.11.5'=>['cvs-1.11.5.tar.bz2']}
		join('base')
  end

  def build()
		super('--with-editor=/bin/e')
		bash "ln -sf #{datadir('cvs/contrib/rcs2log')} #{bindir}"
  end

end; Pkg_Cvs.new()

#===============================================================================
class Pkg_Cvsup < Package
#===============================================================================

  def initialize()
		super('Mirroring tool for cvs archives','16.1h')
		@versions={
			'16.1h'=>['ezm3-1.1-LINUXLIBC6-boot.tar.bz2','ezm3-1.1-src.tar.bz2','cvsup-snap-16.1h.tar.gz']
		}
		needs('zlib','bash')
		wants('xfree86')
		tools('texinfo')
  end

  def build()
		m3 = File.expand_path("./m3")
		m3.mkdir
		unpack(@versions[@select[0]][0])
		unpack(@versions[@select[0]][1])
		Dir.glob('ezm3*')[0].cd {
			'm3config/src/LINUXLIBC6'.freplace('/usr/local',m3)
			Dir.glob('m3config/src/*').each { |f| f.freplace('gmake','make') }
			ENV.delete('CFLAGS')
			ENV.delete('CXXFLAGS')
			ENV['_POSIX2_VERSION']='199209' #Make head -1 etc work
			bash "env"
			bash "make"
		}
		
		unpack(@versions[@select[0]][2])
		Dir.glob('cvsup*')[0].cd
		gui = ( Link.find('xfree86').home ? "" : "-DNOGUI" )
		bash "make -j#{$make_jobs} PREFIX=/ M3=#{m3}/bin/m3build M3FLAGS='-DSTATIC #{gui}'"
		File.makedirs(sbindir,bindir,mandir(1),mandir(8))
		bash "make PREFIX=#{prefix} MANDIR=#{mandir} install"
  end

end; Pkg_Cvsup.new()

#===============================================================================
class Pkg_Dejagnu < Package
#===============================================================================

  def initialize()
		super('Testing tools','1.4.3')
		@versions={'1.4.3'=>['dejagnu-1.4.3.tar.gz']}
		join('base')
		needs('expect')
  end

end; Pkg_Dejagnu.new()

#===============================================================================
class Pkg_Dnotify < Package
#===============================================================================

  def initialize()
		super('A program that makes it possible to execute a command every time the contents of a specific directory change in linux','0.13.0')
		@versions={
			'0.13.0'=>['dnotify-0.13.0.tar.gz']
		}
  end

end; Pkg_Dnotify.new()

#===============================================================================
class Pkg_Isc_dhcp < Package
#===============================================================================

  def initialize()
		super('ISC DHCP implementation','3.0.1rc12')
		@versions={'3.0.1rc12'=>['dhcp-3.0.1rc12.tar.gz']}
		join('server','workstation','net')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		'includes/site.h'.fcat("#define _PATH_DHCPD_CONF \"#{configdir('dhcpd.conf')}\"",
													 "#define _PATH_DHCPD_DB	\"#{statedir('dhcpd.leases')}\"")
		bash "./configure"
		bash "make -j#{$make_jobs} CLIENTBINDIR=/sbin USERBINDIR=/bin BINDIR=/sbin "+
			"LIBDIR=/lib INCDIR=/include VARRUN=#{statedir} VARDB=#{statedir}"
		bash "make CLIENTBINDIR=#{sbindir} USERBINDIR=#{bindir} BINDIR=#{sbindir} "+
			"LIBDIR=#{libdir} INCDIR=#{incdir} ADMMANDIR=#{mandir(8)} FFMANDIR=#{mandir(5)} "+
			"LIBMANDIR=#{mandir(3)} USRMANDIR=#{mandir(1)} VARRUN=#{statedir} VARDB=#{statedir} install"
		File.makedirs(configdir,statedir)
		getdata(configdir,'dhcpd.conf',0644)
		configdir('isc-dhcp-enabled').ftouch("# yes/on/no/off","no")
		configdir('dhcpd-options').ftouch("#Dhcpd commandline options. see man dhcpd")
  end

end; Pkg_Isc_dhcp.new()

#===============================================================================
class Pkg_Diffutils < Package
#===============================================================================

  def initialize()
		super('Utilities for processing file differences','2.8.4')
		@versions={'2.8.4'=>['diffutils-2.8.4.tar.gz']}
		join('base')
		override('busybox')
  end

end; Pkg_Diffutils.new()

#===============================================================================
class Pkg_Distcc < Package
#===============================================================================

  def initialize()
		super('Distributed c/c++ compiler','2.8')
		@versions={'2.8'=>['distcc-2.8.tar.bz2']}
		join('development')
		needs('popt','ruby')
  end

  def build()
		super
		getdata(bindir,'distgcc',0755)
		getdata(bindir,'distg++',0755)
		getdata(bindir,'distmake',0755)
		File.makedirs(prefix('opt/distcc'))
		%w{gcc cc c++ g++}.each { |cc| File.symlink('/bin/distcc',prefix('opt/distcc',cc)) }
  end

end; Pkg_Distcc.new()

#===============================================================================
class Pkg_Djbdns < Package
#===============================================================================

  def initialize()
		super('A BIND replacement by D.J. Bernstein','1.05')
		@versions={'1.05'=>['djbdns-1.05.tar.gz','djbdns-1.05-man.tar.gz','djbdns-1.05.patch']
		}
		needs('ucspi-tcp')
		join('net')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		patch('djbdns-1.05.patch')
		bash "echo #{prefix} > conf-home"
		bash "make -j#{$make_jobs}"
		bash "make setup check"
		bash "install -D -m 0644 dnsroots.global #{configdir('dnsroots.global')}"

		bash "install -d -m755 #{configdir('dnscache')}"
		bash "install -d -m755 #{configdir('dnscache/ip')}"
		bash "install -d -m755 #{configdir('dnscache/servers')}"
		configdir('dnscache/ip/127.0.0.1').ftouch('')
		bash "install -m 0644 dnsroots.global "+configdir('dnscache/servers/@')

		bash "install -d -m755 #{configdir('tinydns')}"
		configdir("tinydns/Makefile").ftouch("data.cdb: data","\t/bin/tinydns-data")
		configdir('tinydns/data').ftouch('')
		configdir('tinydns/add-alias').ftouch('exec /bin/tinydns-edit data data.new add alias ${1+"$@"}')
		configdir('tinydns/add-childns').ftouch('exec /bin/tinydns-edit data data.new add childns ${1+"$@"}')
		configdir('tinydns/add-host').ftouch('exec /bin/tinydns-edit data data.new add host ${1+"$@"}')
		configdir('tinydns/add-mx').ftouch('exec /bin/tinydns-edit data data.new add mx ${1+"$@"}')
		configdir('tinydns/add-ns').ftouch('exec /bin/tinydns-edit data data.new add ns ${1+"$@"}')
		bash "chmod +x #{configdir('tinydns/add-')}*"

		unpack(@versions[@select[0]][1])
		Dir.glob('djbdns-man*')[0].cd
		File.makedirs(mandir(1),mandir(5),mandir(8))
		bash "gzip *.1 *.5 *.8"
		bash "cp *.1.gz #{mandir(1)}"
		bash "cp *.5.gz #{mandir(5)}"
		bash "cp *.8.gz #{mandir(8)}"

		configdir('dnscache','listen-on').ftouch("# The IP address to listen for queries on",
																					 "# Leave blank to disable","127.0.0.1")
		configdir('tinydns','listen-on').ftouch("# The IP address to listen for queries on",
																					"# Leave blank to disable","127.0.0.1",
																					"#This must be different from the dnscache (see djb note's)")
		configdir('dnscache-enabled').ftouch("# yes/no/on/off","no")
		configdir('tinydns-enabled').ftouch("# yes/no/on/off","no")
  end

end; Pkg_Djbdns.new()

#===============================================================================
class Pkg_Docbook_sgml < Package
#===============================================================================

  def initialize()
		super('The Docbook SGML DTD','upto4.2')
		@versions={
			'upto4.2'=>['ISOEnts.zip','docbook-4.2.zip','docbk41.zip','docbk40.zip',
		              'docbk31.zip','docbk30.zip']
		}
		needs('libxml2','libxslt')
		join('docbook')
  end

  def build()
		datadir.mkdir.cd
		'iso8879'.mkdir.cd { unpack(@versions[@select[0]][0]) }
		@versions[@select[0]][1..99].each { |v|
			v =~ /[^\d]*(.*).zip/
			ver = ($1.length==3 ? $1 : $1[0,1]+'.'+$1[1,1])
			ver.mkdir.cd {
				unpack(v)
				'docbook.cat'.freplace(/iso-/,'../iso8879/ISO')
				'docbook.cat'.freplace(/\.gml/,'')
			}
			envdir('SGML_CATALOG_FILES').fcat(datadir(ver,'docbook.cat'))
		}
  end

end; Pkg_Docbook_sgml.new()

#===============================================================================
class Pkg_Docbook_xml < Package
#===============================================================================

  def initialize()
		super('The Docbook SGML DTD','4.2')
		@versions={
			'4.2'=>[['docbook-xml-4.2.zip','4.2'],['docbkx412.zip','4.1.2']]
		}
		needs('libxml2','libxslt')
		join('docbook')
  end

  def build()
		catalog = etcdir('xml/catalog')
		catalog.fcat(
			'<?xml version="1.0"?>',
			'<!DOCTYPE catalog',
   		'    PUBLIC "-//OASIS/DTD Entity Resolution XML Catalog V1.0//EN"',
   		'    "http://www.oasis-open.org/committees/entity/release/1.0/catalog.dtd">',
			'<catalog xmlns="urn:oasis:names:tc:entity:xmlns:xml:catalog">'
		)

		datadir.mkdir
		@versions[@select[0]].each { |file,label|
			dir = datadir(label)
			dir.mkdir.cd { unpack(file) }
			catalog.fcat(
				"  <group  prefer=\"public\"  xml:base=\"file://#{dir}/\" >",
				"    <public publicId=\"-//OASIS//DTD DocBook XML V#{label}//EN\" uri=\"docbookx.dtd\"/>",
				"    <system systemId=\"http://www.oasis-open.org/docbook/xml/#{label}/docbookx.dtd\" uri=\"docbookx.dtd\"/>",
				"    <!-- DocBook modules ...................................................... -->",
				"    <public publicId=\"-//OASIS//DTD DocBook CALS Table Model V#{label}//EN\" uri=\"calstblx.dtd\"/>",
				"    <public publicId=\"-//OASIS//DTD XML Exchange Table Model 19990315//EN\" uri=\"soextblx.dtd\"/>",
				"    <public publicId=\"-//OASIS//ELEMENTS DocBook Information Pool V#{label}//EN\" uri=\"dbpoolx.mod\"/>",
				"    <public publicId=\"-//OASIS//ELEMENTS DocBook Document Hierarchy V#{label}//EN\" uri=\"dbhierx.mod\"/>",
				"    <public publicId=\"-//OASIS//ENTITIES DocBook Additional General Entities V#{label}//EN\" uri=\"dbgenent.mod\"/>",
				"    <public publicId=\"-//OASIS//ENTITIES DocBook Notations V#{label}//EN\" uri=\"dbnotnx.mod\"/>",
				"    <public publicId=\"-//OASIS//ENTITIES DocBook Character Entities V#{label}//EN\" uri=\"dbcentx.mod\"/>",
				"  </group>",
				"  <group  prefer=\"public\"  xml:base=\"file://#{dir}/ent/\" >",
				"    <!-- ISO entity sets ...................................................... -->",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Diacritical Marks//EN//XML\" uri=\"iso-dia.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Numeric and Special Graphic//EN//XML\" uri=\"iso-num.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Publishing//EN//XML\" uri=\"iso-pub.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES General Technical//EN//XML\" uri=\"iso-tech.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Added Latin 1//EN//XML\" uri=\"iso-lat1.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Added Latin 2//EN//XML\" uri=\"iso-lat2.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Greek Letters//EN//XML\" uri=\"iso-grk1.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Monotoniko Greek//EN//XML\" uri=\"iso-grk2.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Greek Symbols//EN//XML\" uri=\"iso-grk3.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Alternative Greek Symbols//EN//XML\" uri=\"iso-grk4.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Added Math Symbols: Arrow Relations//EN//XML\" uri=\"iso-amsa.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Added Math Symbols: Binary Operators//EN//XML\" uri=\"iso-amsb.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Added Math Symbols: Delimiters//EN//XML\" uri=\"iso-amsc.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Added Math Symbols: Negated Relations//EN//XML\" uri=\"iso-amsn.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Added Math Symbols: Ordinary//EN//XML\" uri=\"iso-amso.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Added Math Symbols: Relations//EN//XML\" uri=\"iso-amsr.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Box and Line Drawing//EN//XML\" uri=\"iso-box.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Russian Cyrillic//EN//XML\" uri=\"iso-cyr1.ent\"/>",
				"    <public publicId=\"ISO 8879:1986//ENTITIES Non-Russian Cyrillic//EN//XML\" uri=\"iso-cyr2.ent\"/>",
				"  </group>"
			)
		}
		catalog.fcat('<-- Blank for Docbook-xsl -->','<-- Blank for Docbook-xsl -->','</catalog>')

		envdir('XML_CATALOG_FILES').fwrite(catalog)		
  end

end; Pkg_Docbook_xml.new()

#===============================================================================
class Pkg_Docbook_xsl < Package
#===============================================================================

  def initialize()
		super('XSL stylesheets for the DocBook DTD','1.62.4')
		@versions={
			'1.62.4'=>['docbook-xsl-1.62.4.tar.gz']
		}
		join('docbook')
		syncwith('docbook-xml') #See comment below
  end

  def build()
		datadir.mkdir.cd
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].mv(@select[0])

		#XML_CATALOG_FILES can only actually take one file, not a list, so we'll
		# have to piggy back on docbook-xml's catalog file
		
		catalog = path(Package.find('docbook-xml').home,'etc/xml/catalog')
		lines = IO.readlines(catalog)
		lines[-3] = "  <rewriteSystem systemIdStartString=\"http://docbook.sourceforge.net/release/xsl/current/\"\n"
		lines[-2] = "    rewritePrefix=\"file://#{datadir(select[0])}/\" />\n"
		User.asroot { File.open(catalog,'w') { |f| f << lines } }			
  end

end; Pkg_Docbook_xsl.new()

#===============================================================================
class Pkg_Docbook2x < Package
#===============================================================================

  def initialize()
		super('docbook2X converts DocBook documents into man pages and Texinfo documents','0.8.2')
		@versions={ 
			'0.8.2'=>['docbook2X-0.8.2.tar.gz']
		}
		needs('pm-libxml','htmldoc')
		join('docbook')
  end

  def build()
		ENV.delete('SGML_CATALOG_FILES')
		super()
		datadir('doc').mv(prefix('www'))
  end

end; Pkg_Docbook2x.new()


#===============================================================================
class Pkg_Docbook_dsssl < Package
#===============================================================================

  def initialize()
		super('These are DSSSL stylesheets for the DocBook DTD','1.78')
		@versions={
			'1.78'=>['docbook-dsssl-1.78.tar.gz','docbook-dsssl-doc-1.78.tar.gz']
		}
		join('docbook')
  end

  def build()
		File.makedirs(datadir('sgml'))
		datadir('sgml').cd
		unpack(@versions[@select[0]][0])
		unpack(@versions[@select[0]][1])
		"docbook-dsssl-#{@select[0]}".mv('dsssl')
		envdir('SGML_CATALOG_FILES').fwrite(datadir('sgml/dsssl/catalog'))
  end

end; Pkg_Docbook_dsssl.new()

#===============================================================================
class Pkg_E2fsprogs < Package
#===============================================================================

  def initialize()
		super('Fundamental disk tools','1.32')
		@versions={'1.32'=>['e2fsprogs-1.32.tar.gz']}
		join('disk','workstation','server')
		tools('sed','texinfo')
  end

  def build()
		super("--enable-elf-shlibs")
		bash "make install-libs"
  end

end; Pkg_E2fsprogs.new()

#===============================================================================
class Pkg_Ed < Package
#===============================================================================

  def initialize()
		super('The standard unix editor','0.2')
		@versions={
			'0.2'=>['ed-0.2.tar.gz']
		}
		join('editor')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "./configure --prefix=#{prefix}"
		bash "make -j#{$make_jobs}"
		bash "make install"
  end

end; Pkg_Ed.new()


#===============================================================================
class Pkg_Expat < Package
#===============================================================================

  def initialize()
		super('XML parser','1.95.6')
		@versions={
			'1.95.6'=>['expat-1.95.6.tar.gz']
		}
  end

end; Pkg_Expat.new()

#===============================================================================
class Pkg_Expect < Package
#===============================================================================

  def initialize()
		super('Interactive application automation tools','5.39')
		@versions={
			'5.38'=>['expect-5.38.0.tar.gz'],
			'5.39'=>['expect-5.39.0.tar.gz']
		}
		join('base')
		needs('tcl')
		wants('tk')
  end

  def build()
		Package.find('tcl').configure
		'../..'.cd
		if Package.find('tk').home
			Package.find('tk').configure
			'../..'.cd
		end
		unpack(@versions[@select[0]][0])
		Dir.glob('expect*')[0].cd
		bash "./configure #{stdconfig}"
		bash "make -j#{$make_jobs}"
		bash "make install"
  end

end; Pkg_Expect.new()

#===============================================================================
class Pkg_Fam < Package
#===============================================================================

  def initialize()
		super('File alteration monitor and client library','2.6.10')
		@versions={
			'2.6.10'=>['fam-2.6.10.tar.gz']
		}
  end

end; Pkg_Fam.new()

#===============================================================================
class Pkg_File < Package
#===============================================================================

  def initialize()
		super('file type classification utility','3.41')
		@versions={'3.41'=>['file-3.41.tar.gz']}
		join('base')
  end

end; Pkg_File.new()

#===============================================================================
class Pkg_Findutils < Package
#===============================================================================

  def initialize()
		super('File finding utilities','4.1.20')
		@versions={'4.1.20'=>['findutils-4.1.20.tar.gz']}
		join('base')
		override('busybox')
  end

end; Pkg_Findutils.new()

#===============================================================================
class Pkg_Flex < Package
# Modutils doesn't like newer version of flex (than 2.5.4a)
#===============================================================================

  def initialize()
		super('Lexical analyser','2.5.4a')
		@versions={'2.5.4a'=>['flex-2.5.4a.tar.gz']}
		join('base')
		needs('bison')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		#bash "./configure --prefix=#{prefix}/usr --exec-prefix=#{prefix}"
		bash "./configure --prefix=#{prefix}"
		bash "make -j#{$make_jobs}"
		bash "make install"
  end

end; Pkg_Flex.new()

#===============================================================================
class Pkg_Fontconfig < Package
#===============================================================================

  def initialize()
		super('A library for configuring and customizing font access','2.2.0')
		@versions={
			'2.2.0'=>['fontconfig-2.2.0.tar.gz']
		}
		needs('freetype')
		override('xfree86')
  end

end; Pkg_Fontconfig.new()


#===============================================================================
class Pkg_Freetype1 < Package
#===============================================================================

  def initialize()
		super('a portable and highly efficient TrueType rendering engine','current')
		@versions={
			'1.3.1'=>['freetype-1.3.1.tar.gz'],
			#1.3.1 doesn't build with gcc 3.3, so use current snapshot
			'current'=>['freetype-current.tar.gz']
		}
		join('freetype')
  end

  def build()
		super('','-j1') #Doesn't like parallel make threads
  end

end; Pkg_Freetype1.new()

#===============================================================================
class Pkg_Freetype2 < Package
#===============================================================================

  def initialize()
		super('A software font engine','2.1.5')
		@versions={
			'2.1.5'=>['freetype-2.1.5.tar.bz2','ftdocs-2.1.4.tar.bz2']
		}
		join('freetype')
  end

  def build()
		unpack(@versions[@select[0]][1])
		File.makedirs(prefix('www'))
		Dir.glob('*/docs')[0].mv(wwwdir)
		Dir.glob('*')[0].rrm
		super()
  end

end; Pkg_Freetype2.new()


#===============================================================================
class Pkg_Gawk < Package
#===============================================================================

  def initialize()
		super('Text processing utility','3.1.1')
		@versions={'3.1.1'=>['gawk-3.1.1.tar.gz']}
		join('base')
		override('busybox')
  end

end; Pkg_Gawk.new()

#===============================================================================
class Pkg_Gcc < Package
#===============================================================================

	def extractTags(); extractCvsTags(path($root,SRCDIR,@name),'gcc/gcc'); end
	def readTags(); readAnyTags(path($root,SRCDIR,@name)); end

  def initialize()
		super('Gnu compiler collection','gcc_3_3_2_release','c,c++')
		@versions={'gcc_3_3_2_release'=>['gcc'] }
		join('base')
		tools('sed','gawk','bison','flex','texinfo')
		extralibs('/lib/gcc-lib/*/*')
  end

  def build()
		checkout('gcc','gcc',@select[0])
		ENV['_POSIX2_VERSION']='199209' #Make head -1 etc work
		'work'.mkdir.cd
		bash "../gcc/configure --host=#{$host.full} #{stdconfig} "+
			"--enable-shared --disable-checking --enable-threads=posix "+
			"--enable-languages=#{@select[1]} --with-system-zlib "+
			"--enable-long-long --enable-clocale=generic --enable-__cxa_atexit "+
			"--enable-version-specific-runtime-libs"
		bash "make -j#{$make_jobs} bootstrap"
		bash "make -j#{$make_jobs} -k check" if $check
		bash "make DESTDIR=#{$root} install"
		File.symlink('gcc',path($root,bindir,'cc'))
  end

end; $gcc = Pkg_Gcc.new()

#===============================================================================
class Pkg_Gdb < Package
#===============================================================================

	def extractTags()
		extractCvsTags(path($root,SRCDIR,@name),'sources.redhat/src/gdb')
	end

	def readTags()
		readAnyTags(path($root,SRCDIR,@name))
	end

  def initialize()
		super('The GNU debugger','gdb_6_0-branch')
		@versions={'gdb_6_0-branch'=>['sources.redhat']}
		join('development')
  end

  def build()
		checkout('sources.redhat','gdb',@select[0])
		'work'.mkdir.cd
		bash "../src/configure #{stdconfig}"
		bash "make -j#{$make_jobs}"
		bash "make install"
  end

end; Pkg_Gdb.new()

#===============================================================================
class Pkg_Gdbm < Package
#===============================================================================

  def initialize()
		super('Gnu database library','1.8.3')
		@versions={'1.8.3'=>['gdbm-1.8.3.tar.gz']}
		join('base')
		tools('libtool')
  end

  def build()
		super('','BINOWN=rubyx BINGRP=users')
  end

end; Pkg_Gdbm.new()

#===============================================================================
class Pkg_Gettext < Package
#===============================================================================

  def initialize()
		super('Localisation tools','0.11.5')
		@versions={'0.11.5'=>['gettext-0.11.5.tar.gz']}
		join('base')
		tools('sed')
  end

end; Pkg_Gettext.new()

#===============================================================================
class Pkg_Ghostscript < Package
# If you upgrade this, Update hyla.conf in Hylafax!
#===============================================================================

  def initialize()
		super('Ghostscript postscript document tools','8.11')
		@versions={
			'8.11'=>['ghostscript-8.11.tar.bz2','ghostscript-fonts-std-8.11.tar.gz',
		           'ghostscript-fonts-other-6.0.tar.gz']
		}
		needs('libjpeg','libpng','zlib')
		wants('xfree86')
		join('workstation','printing')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		unpack($libjpeg.versions[$libjpeg.select[0]][0],path(SRCDIR,'libjpeg'))
		File.rename(Dir.glob('jpeg*')[0],'jpeg')
		unpack($libpng.versions[$libpng.select[0]][0],path(SRCDIR,'libpng'))
		File.rename(Dir.glob('libpng*')[0],'libpng')
		unpack($zlib.versions[$zlib.select[0]][0],path(SRCDIR,'zlib'))
		File.rename(Dir.glob('zlib*')[0],'zlib')
		bash "./configure #{stdconfig}"
		bash "make -j#{$make_jobs}"
		bash "make install"
		datadir('ghostscript').mkdir.cd { @versions[@select[0]][1..2].each { |p| unpack p } }
		prefix('fonts').mkdir
		datadir('ghostscript/fonts').link(prefix('fonts/ghostscript'))
  end

end; Pkg_Ghostscript.new()

#===============================================================================
class Pkg_Gimp < Package
#===============================================================================

  def initialize()
		super('The Gnu Image Manipulation Program','1.2.5')
		@versions={
			'1.2.5'=>['gimp-1.2.5.tar.bz2']
		}
		join('graphics')
		needs('xfree86')
  end

end; #Pkg_Gimp.new()

#===============================================================================
class Pkg_Gnupg < Package
#===============================================================================

  def initialize()
		super('Gnu privacy guard, an OpenPGP implementation','1.2.3')
		@versions={
			'1.2.3'=>['gnupg-1.2.3.tar.bz2']
		}
		join('crypto')
  end

end; Pkg_Gnupg.new()

#===============================================================================
class Pkg_Grep < Package
#===============================================================================

  def initialize()
		super('Text file searching utility','2.5.1')
		@versions={'2.5.1'=>['grep-2.5.1.tar.bz2']}
		join('base')
		tools('texinfo')
		needs('pcre')
		override('busybox')
  end

end; Pkg_Grep.new()

#===============================================================================
class Pkg_Groff < Package
#===============================================================================

  def initialize()
		super('Document formatting utility','1.19')
		@versions={'1.19'=>['groff-1.19.tar.gz']}
		join('base')
		tools('gcc','sed') #Needs C++ compiler
  end

  def build()
		super('','-j1')
  end

end; Pkg_Groff.new()

#===============================================================================
class Pkg_Grub < Package
#===============================================================================

  def initialize()
		super('Grand unified boot loader','0.93')
		@versions={'0.93'=>['grub-0.93.tar.gz',['grub-0.93.patch',1]]}
		join('disk')
  end

  def build()
		ENV.delete('CFLAGS')
		ENV.delete('CXXFLAGS')
		super()
  end

end; Pkg_Grub.new()

#===============================================================================
class Pkg_Gzip < Package
#===============================================================================

  def initialize()
		super('File compression utility','1.3.5')
		@versions={'1.3.5'=>['gzip-1.3.5.tar.gz']}
		join('base')
		override('busybox')
  end

end; Pkg_Gzip.new()

#===============================================================================
class Pkg_Glibc < Package
#===============================================================================

	def extractTags(); extractCvsTags(path($root,SRCDIR,@name),'glibc/libc'); end
	def readTags(); readAnyTags(path($root,SRCDIR,@name)); end

  def initialize()
		super('Gnu C library','glibc-2_3_2','linuxthreads')
		@versions={
		           'glibc-2-3-1'=>['glibc',['glibc-2.3.1.patch',1]],
		           'glibc-2_3_2'=>['glibc',['glibc-2.3.1.patch',1]],
		           'HEAD'=>['glibc']
		}
		join('base')
		tools('sed','gawk','bison','perl','texinfo')
		needs('kernel-headers')
		override('netkit-base')
  end

  def build()
		checkout('glibc','libc',@select[0])
		'libc'.cd
		patch('glibc-2.3.1.patch') if ['glibc-2-3-1','glibc-2_3_2'].include?(@select[0])
		'../work'.mkdir.cd
		bash "../libc/configure #{stdconfig} --disable-profile --enable-add-ons=#{@select[1]} "+
			"--enable-kernel=2.4 --with-headers=#{path($root,$kernel_headers.incdir)} --without-cvs "+
			"--build="+$host.full
		bash "make -j#{$make_jobs}"
		bash "make -j#{$make_jobs} -k check" if $check
		bash "make -j#{$make_jobs} install_root=#{$root} install"
		bash "make -j#{$make_jobs} install_root=#{$root} localedata/install-locales" if $root=='/'
		path($root,etcdir).mkdir
		File.syscopy('../libc/nss/nsswitch.conf',path($root,etcdir,'nsswitch.conf'))
		path($root,etcdir,'resolv.conf').fwrite('nameserver 10.0.0.1','domain office','search office')
		#Set a default timezone
		configdir('localtime').rm
		'../share/zoneinfo/GMT'.link(configdir('localtime'))
  end

end; $glibc = Pkg_Glibc.new()

#===============================================================================
class Pkg_Acme < GnomePackage
#===============================================================================
	def initialize()
		super('Acme','2.4.0')
		@versions={
			'2.4.0'=>['acme-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('libgnomeui')
	end
end; Pkg_Acme.new()

#===============================================================================
class Pkg_Atk < GnomePackage
#===============================================================================
	def initialize()
		super('Atk','1.4.0')
		@versions={
			'1.4.0'=>['atk-1.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('glib')
	end
end; Pkg_Atk.new()

#===============================================================================
class Pkg_At_spi < GnomePackage
#===============================================================================
	def initialize()
		super('At_spi','1.3.7')
		@versions={
			'1.3.7'=>['at-spi-1.3.7.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('libbonobo','atk','gtkplus','gail')
	end
end; Pkg_At_spi.new()

#===============================================================================
class Pkg_Audiofile < Package
#===============================================================================
	def initialize()
		super('Audiofile','0.2.3')
		@versions={
			'0.2.3'=>['audiofile-0.2.3.tar.bz2']
		}
		needs('findutils')
	end
end; Pkg_Audiofile.new()

#===============================================================================
class Pkg_Bug_buddy < GnomePackage
#===============================================================================
	def initialize()
		super('Bug_buddy','2.4.0')
		@versions={
			'2.4.0'=>['bug-buddy-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','gnome-desktop','gnome-vfs','libgnome','libgnomecanvas','libgnomeui','libglade','libxml2','libbonobo')
	end
end; Pkg_Bug_buddy.new()

#===============================================================================
class Pkg_Control_center < GnomePackage
#===============================================================================
	def initialize()
		super('Control_center','2.4.0')
		@versions={
			'2.4.0'=>['control-center-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','gconf','libgnomeui','libglade','libbonobo','libbonoboui','libglade','gconf','gnome-desktop','nautilus')
	end
end; Pkg_Control_center.new()

#===============================================================================
class Pkg_Eel < GnomePackage
#===============================================================================
	def initialize()
		super('Eel','2.4.0')
		@versions={
			'2.4.0'=>['eel-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gconf','glib','gnome-vfs','gtkplus','gail','libgnome','libgnomeui','libxml2','libglade')
	end
end; Pkg_Eel.new()

#===============================================================================
class Pkg_Eog < GnomePackage
#===============================================================================
	def initialize()
		super('Eog','2.4.0')
		@versions={
			'2.4.0'=>['eog-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','gnome-vfs','libgnomeui','libbonoboui','libbonobo','eel','libexif','libgnomeprintui','gconf','libglade','libgnomecanvas','libart-lgpl')
	end
end; Pkg_Eog.new()

#===============================================================================
class Pkg_Epiphany < GnomePackage
#===============================================================================
	def initialize()
		super('Epiphany','1.0')
		@versions={
			'1.0'=>['epiphany-1.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','libxml2','libgnomeui','libglade','libbonoboui','orbit2','libglade','gnome-vfs','gconf') #'bonobo-activation'
	end
end; #Pkg_Epiphany.new() #Needs Mozilla

#===============================================================================
class Pkg_Esound < GnomePackage
#===============================================================================
	def initialize()
		super('Esound','0.2.32')
		@versions={
			'0.2.32'=>['esound-0.2.32.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
	end
end; Pkg_Esound.new()

#===============================================================================
class Pkg_File_roller < GnomePackage
#===============================================================================
	def initialize()
		super('File_roller','2.4.0.1')
		@versions={
			'2.4.0.1'=>['file-roller-2.4.0.1.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('glib','gtkplus','libgnome','libgnomeui','gnome-vfs','libglade') #'bonobo-activation'
	end
end; Pkg_File_roller.new()

#===============================================================================
class Pkg_Gail < GnomePackage
#===============================================================================
	def initialize()
		super('Gail','1.4.0')
		@versions={
			'1.4.0'=>['gail-1.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('atk','glib','gtkplus','pango','freetype2','libgnomecanvas','libart-lgpl')
	end
end; Pkg_Gail.new()

#===============================================================================
class Pkg_Gcalctool < GnomePackage
#===============================================================================
	def initialize()
		super('Gcalctool','4.3.3')
		@versions={
			'4.3.3'=>['gcalctool-4.3.3.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','libgnome','libgnomeui')
	end
end; Pkg_Gcalctool.new()

#===============================================================================
class Pkg_Gconf < GnomePackage
#===============================================================================
	def initialize()
		super('Gconf','2.4.0.1')
		@versions={
			'2.4.0.1'=>['GConf-2.4.0.1.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('glib','orbit2')
	end
	def build(); super('','-j1'); end
end; Pkg_Gconf.new()

#===============================================================================
class Pkg_Gconf_editor < GnomePackage
#===============================================================================
	def initialize()
		super('Gconf_editor','2.4.0')
		@versions={
			'2.4.0'=>['gconf-editor-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gconf','gtkplus')
	end
end; Pkg_Gconf_editor.new()

#===============================================================================
class Pkg_Gdm < GnomePackage
#===============================================================================
	def initialize()
		super('Gdm','2.4.4.0')
		@versions={
			'2.4.4.0'=>['gdm-2.4.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','libgnomeui','libglade')
	end
end; Pkg_Gdm.new()

#===============================================================================
class Pkg_Gedit < GnomePackage
#===============================================================================
	def initialize()
		super('Gedit','2.4.0')
		@versions={
			'2.4.0'=>['gedit-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('libgnomeui','libglade','eel','gtksourceview','libgnomeprintui')
	end
end; Pkg_Gedit.new()

#===============================================================================
class Pkg_Ggv < GnomePackage
#===============================================================================
	def initialize()
		super('Ggv','2.4.0.1')
		@versions={
			'2.4.0.1'=>['ggv-2.4.0.1.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('libgnomeui')
	end
end; Pkg_Ggv.new()

#===============================================================================
class Pkg_Glib < GnomePackage
#===============================================================================
	def initialize()
		super('Glib','2.2.3')
		@versions={
			'2.2.3'=>['glib-2.2.3.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
	end
end; Pkg_Glib.new()

#===============================================================================
class Pkg_Gnome2_user_docs < GnomePackage
#===============================================================================
	def initialize()
		super('Gnome2_user_docs','2.4.0')
		@versions={
			'2.4.0'=>['gnome2-user-docs-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('scrollkeeper')
	end
end; Pkg_Gnome2_user_docs.new()

#===============================================================================
class Pkg_Gnome_applets < GnomePackage
#===============================================================================
	def initialize()
		super('Gnome_applets','2.4.0')
		@versions={
			'2.4.0'=>['gnome-applets-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','gnome-panel')
		syncwith('gconf')
	end
end; Pkg_Gnome_applets.new()

#===============================================================================
class Pkg_Gnome_desktop < GnomePackage
#===============================================================================
	def initialize()
		super('Gnome_desktop','2.4.0')
		@versions={
			'2.4.0'=>['gnome-desktop-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('startup-notification','gtkplus','libgnomeui','gnome-vfs')
	end
end; Pkg_Gnome_desktop.new()

#===============================================================================
class Pkg_Gnome_games < GnomePackage
#===============================================================================
	def initialize()
		super('Gnome_games','2.4.0')
		@versions={
			'2.4.0'=>['gnome-games-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('libgnome','libgnomeui','gconf','gnome-vfs')
	end
end; Pkg_Gnome_games.new()

#===============================================================================
class Pkg_Gnome_icon_theme < GnomePackage
#===============================================================================
	def initialize()
		super('Gnome_icon_theme','1.0.9')
		@versions={
			'1.0.9'=>['gnome-icon-theme-1.0.9.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
	end
end; Pkg_Gnome_icon_theme.new()

#===============================================================================
class Pkg_Gnome_mag < GnomePackage
#===============================================================================
	def initialize()
		super('Gnome_mag','0.10.3')
		@versions={
			'0.10.3'=>['gnome-mag-0.10.3.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('libbonobo','orbit2','glib','gtkplus','at-spi')
	end
	def build(); super('','-j1'); end
end; Pkg_Gnome_mag.new()

#===============================================================================
class Pkg_Gnome_media < GnomePackage
#===============================================================================
	def initialize()
		super('Gnome_media','2.4.0')
		@versions={
			'2.4.0'=>['gnome-media-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('glib','libgnomeui','esound','gst-plugins')
	end
end; Pkg_Gnome_media.new()

#===============================================================================
class Pkg_Gnomemeeting < GnomePackage
#===============================================================================
	def initialize()
		super('Gnomemeeting','0.98.5')
		@versions={
			'0.98.5'=>['gnomemeeting-0.98.5.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','atk','glib','pango','esound','audiofile','gconf','orbit2','libxml2','libgnome','libgnomeui','gnome-vfs')
	end
end; #Pkg_Gnomemeeting.new() #What the hell is PTLibs?

#===============================================================================
class Pkg_Gnome_mime_data < GnomePackage
#===============================================================================
	def initialize()
		super('Gnome_mime_data','2.4.0')
		@versions={
			'2.4.0'=>['gnome-mime-data-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
	end
end; Pkg_Gnome_mime_data.new()

#===============================================================================
class Pkg_Gnome_panel < GnomePackage
#===============================================================================
	def initialize()
		super('Gnome_panel','2.4.0')
		@versions={
			'2.4.0'=>['gnome-panel-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('orbit2','gtkplus','libgnome','libgnomeui','gnome-desktop','gnome-vfs','libglade','gconf')
	end
	def build(); super('','-j1'); end
end; Pkg_Gnome_panel.new()

#===============================================================================
class Pkg_Gnome_session < GnomePackage
#===============================================================================
	def initialize()
		super('Gnome_session','2.4.0')
		@versions={
			'2.4.0'=>['gnome-session-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','libgnomeui')
	end
end; Pkg_Gnome_session.new()

#===============================================================================
class Pkg_Gnome_speech < GnomePackage
#===============================================================================
	def initialize()
		super('Gnome_speech','0.2.7')
		@versions={
			'0.2.7'=>['gnome-speech-0.2.7.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtk-doc','libbonobo','orbit2') #'bonobo-activation'
	end
end; Pkg_Gnome_speech.new()

#===============================================================================
class Pkg_Gnome_system_monitor < GnomePackage
#===============================================================================
	def initialize()
		super('Gnome_system_monitor','2.4.0')
		@versions={
			'2.4.0'=>['gnome-system-monitor-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('libgnome','libgnomeui','gconf','libgtop','libwnck','gtkplus')
	end
end; Pkg_Gnome_system_monitor.new()

#===============================================================================
class Pkg_Gnome_terminal < GnomePackage
#===============================================================================
	def initialize()
		super('Gnome_terminal','2.4.0.1')
		@versions={
			'2.4.0.1'=>['gnome-terminal-2.4.0.1.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','gconf','libglade','libgnomeui','startup-notification','vte')
	end
end; Pkg_Gnome_terminal.new()

#===============================================================================
class Pkg_Gnome_themes < GnomePackage
#===============================================================================
	def initialize()
		super('Gnome_themes','2.4.0')
		@versions={
			'2.4.0'=>['gnome-themes-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','gtk-engines','libgnomeui','libglade')
	end
end; Pkg_Gnome_themes.new()

#===============================================================================
class Pkg_Gnome_utils < GnomePackage
#===============================================================================
	def initialize()
		super('Gnome_utils','2.4.0')
		@versions={
			'2.4.0'=>['gnome-utils-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('libgnome','libgnomeui','gnome-desktop','gnome-panel')
	end
end; Pkg_Gnome_utils.new()

#===============================================================================
class Pkg_Gnome_vfs < GnomePackage
#===============================================================================
	def initialize()
		super('Gnome_vfs','2.4.0')
		@versions={
			'2.4.0'=>['gnome-vfs-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('glib','libxml2','gconf','libbonobo','orbit2','gnome-mime-data','fam','openssl')
	end
end; Pkg_Gnome_vfs.new()

#===============================================================================
class Pkg_Gnopernicus < GnomePackage
#===============================================================================
	def initialize()
		super('Gnopernicus','0.7.0')
		@versions={
			'0.7.0'=>['gnopernicus-0.7.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gconf','glib','libgnome','libgnomeui','libxml2')
	end
end; Pkg_Gnopernicus.new()

#===============================================================================
class Pkg_Gok < GnomePackage
#===============================================================================
	def initialize()
		super('Gok','0.8.1')
		@versions={
			'0.8.1'=>['gok-0.8.1.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('scrollkeeper','libgnomeui','at-spi','libbonobo','atk','gtkplus','gail','libwnck','esound')
	end
end; Pkg_Gok.new()

#===============================================================================
class Pkg_Gpdf < GnomePackage
#===============================================================================
	def initialize()
		super('Gpdf','0.110')
		@versions={
			'0.110'=>['gpdf-0.110.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('libgnomeui','libbonoboui','libbonobo','gnome-vfs','libgnomeprint','libgnomeprintui','libglade')
	end
end; Pkg_Gpdf.new()

#===============================================================================
class Pkg_Gst_plugins < GnomePackage
#===============================================================================
	def initialize()
		super('Gst_plugins','0.6.4')
		@versions={
			'0.6.3'=>['gst-plugins-0.6.3.tar.bz2'],
			'0.6.4'=>['gst-plugins-0.6.4.tar.bz2'],
			'0.7.1'=>['gst-plugins-0.7.1.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gconf','gstreamer')
	end
	def build(); super('','-j1'); end
end; Pkg_Gst_plugins.new()

#===============================================================================
class Pkg_Gstreamer < GnomePackage
#===============================================================================
	def initialize()
		super('Gstreamer','0.6.4')
		@versions={
			'0.6.3'=>['gstreamer-0.6.3.tar.bz2'],
			'0.6.4'=>['gstreamer-0.6.4.tar.bz2'],
			'0.7.1'=>['gstreamer-0.7.1.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('glib','libgnomeui')
	end
end; Pkg_Gstreamer.new()

#===============================================================================
class Pkg_Gtkplus < GnomePackage
#===============================================================================
	def initialize()
		super('Gtk+','2.2.4')
		@versions={
			'2.2.4'=>['gtk+-2.2.4.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('glib','atk','pango')
	end
	def build()
		super
		prefix('usr/gnome/etc/gtk-2.0').mkdirs
		bash(prefix('usr/gnome/bin/gdk-pixbuf-query-loaders')+' > '+prefix('usr/gnome/etc/gtk-2.0/gdk-pixbuf.loaders'),ASROOT)
		bash(prefix('usr/gnome/bin/gtk-query-immodules-2.0') +' > '+prefix('usr/gnome/etc/gtk-2.0/gtk.immodules'),ASROOT)
	end
end; Pkg_Gtkplus.new()

#===============================================================================
class Pkg_Gtk_doc < GnomePackage
#===============================================================================
	def initialize()
		super('Gtk_doc','1.1')
		@versions={
			'1.1'=>['gtk-doc-1.1.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
	end
end; Pkg_Gtk_doc.new()

#===============================================================================
class Pkg_Gtk_engines < GnomePackage
#===============================================================================
	def initialize()
		super('Gtk_engines','2.2.0')
		@versions={
			'2.2.0'=>['gtk-engines-2.2.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus')
	end
end; Pkg_Gtk_engines.new()

#===============================================================================
class Pkg_Gtksourceview < GnomePackage
#===============================================================================
	def initialize()
		super('Gtksourceview','0.6.0')
		@versions={
			'0.6.0'=>['gtksourceview-0.6.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','libxml2','libgnomeprintui','gnome-vfs')
	end
end; Pkg_Gtksourceview.new()

#===============================================================================
class Pkg_Gucharmap < GnomePackage
#===============================================================================
	def initialize()
		super('Gucharmap','1.0.0')
		@versions={
			'1.0.0'=>['gucharmap-1.0.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('intltool','libgnome','libgnomeui')
		syncwith('gtkplus')
	end
	def build()
		User.asroot {
			Link.find('gtkplus').prefix('usr/gnome/etc/gtk-2.0/gtk.immodules').chmod(0666)
		}
		super
		User.asroot {
			Link.find('gtkplus').prefix('usr/gnome/etc/gtk-2.0/gtk.immodules').chmod(0644)
		}
	end
end; Pkg_Gucharmap.new()

#===============================================================================
class Pkg_Intltool < GnomePackage
#===============================================================================
	def initialize()
		super('Intltool','0.27.2')
		@versions={
			'0.27.2'=>['intltool-0.27.2.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
	end
end; Pkg_Intltool.new()

#===============================================================================
class Pkg_Libart_lgpl < Package
#===============================================================================
	def initialize()
		super('2D graphics library also used by Kde','2.3.16')
		@versions={
			'2.3.11'=>['libart_lgpl-2.3.11.tar.bz2'],
			'2.3.16'=>['libart_lgpl-2.3.16.tar.bz2']
		}
	end
end; Pkg_Libart_lgpl.new()

#===============================================================================
class Pkg_Libbonobo < GnomePackage
#===============================================================================
	def initialize()
		super('Libbonobo','2.4.0')
		@versions={
			'2.4.0'=>['libbonobo-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('orbit2','glib','glib')
	end
end; Pkg_Libbonobo.new()

#===============================================================================
class Pkg_Libbonoboui < GnomePackage
#===============================================================================
	def initialize()
		super('Libbonoboui','2.4.0')
		@versions={
			'2.4.0'=>['libbonoboui-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('libgnomecanvas','libbonobo','libgnome','libxml2','gconf','gtkplus') #'bonobo-activation'
	end
end; Pkg_Libbonoboui.new()

#===============================================================================
class Pkg_Libcroco < GnomePackage
#===============================================================================
  def initialize()
		super('A generic Cascading Style Sheet (CSS) parsing and manipulation toolkit used by GNOME applications','0.3.0')
		@versions={
			'0.3.0'=>['libcroco-0.3.0.tar.bz2']
		}
		needs('glib','pango')
  end
end; Pkg_Libcroco.new()

#===============================================================================
class Pkg_Libgsf < GnomePackage
#===============================================================================
  def initialize()
		super('GNOME Structured File Library','1.8.2')
		@versions={
			'1.8.2'=>['libgsf-1.8.2.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('libbonobo','gnome-vfs')
  end
end; Pkg_Libgsf.new()

#===============================================================================
class Pkg_Libgail_gnome < GnomePackage
#===============================================================================
	def initialize()
		super('Libgail_gnome','1.0.2')
		@versions={
			'1.0.2'=>['libgail-gnome-1.0.2.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('atk','gtkplus','libbonobo','libbonoboui','libgnomeui','at-spi')
	end
end; Pkg_Libgail_gnome.new()

#===============================================================================
class Pkg_Libglade < GnomePackage
#===============================================================================
	def initialize()
		super('Libglade','2.0.1')
		@versions={
			'2.0.1'=>['libglade-2.0.1.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('libxml2','atk','gtkplus')
	end
end; Pkg_Libglade.new()

#===============================================================================
class Pkg_Libgnome < GnomePackage
#===============================================================================
	def initialize()
		super('Libgnome','2.4.0')
		@versions={
			'2.4.0'=>['libgnome-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('glib','gnome-vfs','libbonobo','gconf')
	end
end; Pkg_Libgnome.new()

#===============================================================================
class Pkg_Libgnomecanvas < GnomePackage
#===============================================================================
	def initialize()
		super('Libgnomecanvas','2.4.0')
		@versions={
			'2.4.0'=>['libgnomecanvas-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','libart-lgpl','pango','libglade')
	end
end; Pkg_Libgnomecanvas.new()

#===============================================================================
class Pkg_Libgnomeprint < GnomePackage
#===============================================================================
	def initialize()
		super('Libgnomeprint','2.3.1')
		@versions={
			'2.3.1'=>['libgnomeprint-2.3.1.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('glib','pango','libxml2','fontconfig')
		wants('cups')
	end
end; Pkg_Libgnomeprint.new()

#===============================================================================
class Pkg_Libgnomeprintui < GnomePackage
#===============================================================================
	def initialize()
		super('Libgnomeprintui','2.3.1')
		@versions={
			'2.3.1'=>['libgnomeprintui-2.3.1.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('libgnomeprint','libgnomecanvas')
	end
end; Pkg_Libgnomeprintui.new()

#===============================================================================
class Pkg_Libgnomeui < GnomePackage
#===============================================================================
	def initialize()
		super('Libgnomeui','2.4.0.1')
		@versions={
			'2.4.0.1'=>['libgnomeui-2.4.0.1.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('libgnome','libgnomecanvas','libbonoboui','gconf','pango')
	end
end; Pkg_Libgnomeui.new()

#===============================================================================
class Pkg_Libgtkhtml < GnomePackage
#===============================================================================
	def initialize()
		super('Libgtkhtml','2.4.0')
		@versions={
			'2.4.0'=>['libgtkhtml-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','gail','libxml2')
	end
	def build(); super('','-j1'); end
end; Pkg_Libgtkhtml.new()

#===============================================================================
class Pkg_Libgtop < GnomePackage
#===============================================================================
	def initialize()
		super('Libgtop','2.0.5')
		@versions={
			'2.0.5'=>['libgtop-2.0.5.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('glib')
	end
end; Pkg_Libgtop.new()

#===============================================================================
class Pkg_Libidl < GnomePackage
#===============================================================================
	def initialize()
		super('Libidl','0.8.2')
		@versions={
			'0.8.2'=>['libIDL-0.8.2.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('glib')
	end
end; Pkg_Libidl.new()

#===============================================================================
class Pkg_Librsvg < GnomePackage
#===============================================================================
	def initialize()
		super('Librsvg','2.4.0')
		@versions={
			'2.4.0'=>['librsvg-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','glib','libxml2','pango','libgsf','libcroco')
		#wants('gimp')
	end
end; Pkg_Librsvg.new()

#===============================================================================
class Pkg_Libwnck < GnomePackage
#===============================================================================
	def initialize()
		super('Libwnck','2.4.0.1')
		@versions={
			'2.4.0.1'=>['libwnck-2.4.0.1.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus')
	end
end; Pkg_Libwnck.new()

#===============================================================================
class Pkg_Libxml2 < Package
#===============================================================================
	def initialize()
		super('XML C parser, also used by Kde','2.5.11')
		@versions={
			'2.5.8'=>['libxml2-2.5.8.tar.gz'],
			'2.5.11'=>['libxml2-2.5.11.tar.bz2'],
			'2.6.0'=>['libxml2-2.6.0.tar.gz']
		}
	end
end; Pkg_Libxml2.new()

#===============================================================================
class Pkg_Libxslt < Package
#===============================================================================
	def initialize()
		super('XSLT C library also used by Kde','1.0.33')
		@versions={
			'1.0.31'=>['libxslt-1.0.31.tar.gz'],
			'1.0.32'=>['libxslt-1.0.32.tar.bz2'],
			'1.0.33'=>['libxslt-1.0.33.tar.gz']
		}
		needs('libxml2')
	end
end; Pkg_Libxslt.new()

#===============================================================================
class Pkg_Metacity < GnomePackage
#===============================================================================
	def initialize()
		super('Metacity','2.6.1')
		@versions={
			'2.6.1'=>['metacity-2.6.1.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','pango','gconf','startup-notification')
	end
end; Pkg_Metacity.new()

#===============================================================================
class Pkg_Nautilus < GnomePackage
#===============================================================================
	def initialize()
		super('Nautilus','2.4.0')
		@versions={
			'2.4.0'=>['nautilus-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('startup-notification','esound','eel','glib','gnome-desktop','gnome-vfs','orbit2','pango','gtkplus','libbonobo',
		      'libbonoboui','libgnome','libgnomeui','librsvg','libxml2')
	end
end; Pkg_Nautilus.new()

#===============================================================================
class Pkg_Nautilus_cd_burner < GnomePackage
#===============================================================================
	def initialize()
		super('Nautilus_cd_burner','0.5.3')
		@versions={
			'0.5.3'=>['nautilus-cd-burner-0.5.3.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('glibc','libgnome','gtkplus','gnome-vfs','libglade','eel')
	end
end; Pkg_Nautilus_cd_burner.new()

#===============================================================================
class Pkg_Nautilus_media < GnomePackage
#===============================================================================
	def initialize()
		super('Nautilus_media','0.3.3.1')
		@versions={
			'0.3.3.1'=>['nautilus-media-0.3.3.1.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gst-plugins')
	end
end; Pkg_Nautilus_media.new()

#===============================================================================
class Pkg_Orbit2 < GnomePackage
#===============================================================================
	def initialize()
		super('Orbit2','2.8.1')
		@versions={
			'2.8.1'=>['ORBit2-2.8.1.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('glib','libidl')
	end
end; Pkg_Orbit2.new()

#===============================================================================
class Pkg_Pango < GnomePackage
#===============================================================================
	def initialize()
		super('Pango','1.2.5')
		@versions={
			'1.2.5'=>['pango-1.2.5.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('fontconfig','glib')
	end
end; Pkg_Pango.new()

#===============================================================================
class Pkg_Scrollkeeper < GnomePackage
#===============================================================================
	def initialize()
		super('Scrollkeeper','0.3.12')
		@versions={
			'0.3.12'=>['scrollkeeper-0.3.12.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('intltool')
	end
end; Pkg_Scrollkeeper.new()

#===============================================================================
class Pkg_Startup_notification < GnomePackage
#===============================================================================
	def initialize()
		super('Startup_notification','0.5')
		@versions={
			'0.5'=>['startup-notification-0.5.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
	end
end; Pkg_Startup_notification.new()

#===============================================================================
class Pkg_Vte < GnomePackage
#===============================================================================
	def initialize()
		super('Vte','0.11.10')
		@versions={
			'0.11.10'=>['vte-0.11.10.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('glib','gtkplus')
	end
end; Pkg_Vte.new()

#===============================================================================
class Pkg_Yelp < GnomePackage
#===============================================================================
	def initialize()
		super('Yelp','2.4.0')
		@versions={
			'2.4.0'=>['yelp-2.4.0.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gnome-vfs','libgnome','libgnomeui','libbonobo','libglade','gconf','libgtkhtml','orbit2','glib','libxslt')
	end
end; Pkg_Yelp.new()

#===============================================================================
class Pkg_Zenity < GnomePackage
#===============================================================================
	def initialize()
		super('Zenity','1.6')
		@versions={
			'1.6'=>['zenity-1.6.tar.bz2']
		}
		join('gnome-min','gnome','gnome-all')
		needs('gtkplus','libglade','gconf','libgnomecanvas')
	end
end; Pkg_Zenity.new()

#===============================================================================
class Pkg_Hdparm < Package
#===============================================================================

  def initialize()
		super('IDE parameter manipulation utility','5.4')
		@versions={'5.4'=>['hdparm-5.4.tar.gz']}
		join('disk')
		tools('coreutils') #Needs install command
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "make -j#{$make_jobs} binprefix=#{prefix} mandir=#{mandir}"
		File.makedirs(sbindir,mandir(8))
		bash "make install binprefix=#{prefix} mandir=#{mandir}"
  end

end; Pkg_Hdparm.new()

#===============================================================================
class Pkg_Hostap < Package
#===============================================================================

  def initialize()
		super('Alternative Prism II wireless driver with access point support','0.0.4')
		@versions={
			'0.0.3'=>['hostap-0.0.3.tar.gz'],
			'0.0.4'=>['hostap-0.0.4.tar.gz']
		}
		syncwith('pcmcia-cs')
		needs('wireless-tools')
		join('driver')
  end

  def build()
		unpack($pcmcia_cs.versions[$pcmcia_cs.select[0]][0],path(SRCDIR,'pcmcia-cs'))
		unpack(@versions[@select[0]][0])
		Dir.glob('hostap*')[0].cd
		ENV['PWD'] = Dir.getwd()
		ENV['_POSIX2_VERSION']='199209' #Make head -1 etc work
		'Makefile'.freplace('/sbin/depmod -ae','true')
		File.makedirs(path(prefix,'lib/modules',$linux.select[0][1..9]),path(prefix,'etc/pcmcia'))
		bash "make KERNEL_PATH=#{$linux.source} "+
			"PCMCIA_PATH=#{Dir.glob('../pcmcia*')[0]} -j#{$make_jobs} pccard"
		bash "make KERNEL_PATH=#{$linux.source} DESTDIR=#{prefix} install_pccard"
		bash "make KERNEL_PATH=#{$linux.source} -j#{$make_jobs} plx"
		bash "make KERNEL_PATH=#{$linux.source} DESTDIR=#{prefix} install_plx"
		bash "make KERNEL_PATH=#{$linux.source} -j#{$make_jobs} pci"
		bash "make KERNEL_PATH=#{$linux.source} DESTDIR=#{prefix} install_pci"
  end

end; Pkg_Hostap.new()

#===============================================================================
class Pkg_htmldoc < Package
#===============================================================================

  def initialize()
		super('description','1.8.23')
		@versions={
			'1.8.23'=>['htmldoc-1.8.23-source.tar.bz2']
		}
		needs('sgmltools-lite')
  end

  def build()
		super
		datadir('doc').mv(prefix('www'))
  end

end; Pkg_htmldoc.new()

#===============================================================================
class Pkg_Hylafax < Package
#===============================================================================

  def initialize()
		super('Fax server','4.1.7')
		@versions={
			'4.1.7'=>['hylafax-4.1.7.tar.gz']
		}
		needs('sharutils','libtiff','ghostscript','cups')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		'config.site'.fcat(
											 "HTML=yes",
											 "DIR_BIN=\"#{bindir}\"",
											 "DIR_LIB=\"#{libdir}\"",
											 "DIR_LIBDATA=\"#{configdir}\"",
											 "DIR_LIBEXEC=\"#{sbindir}\"",
											 "DIR_MAN=\"#{mandir}\"",
											 "DIR_SPOOL=\"#{statedir}\"",
											 "DIR_SBIN=\"#{sbindir}\"",
											 "DIR_LOCKS=\"/var/lock\"",
											 "FONTMAP=\"/fonts/ghostscript\"",
											 "#PAGESIZE=\"North American Letter\"",
											 "PATH_GETTY=\"/sbin/agetty\"",
											 "PATH_SENDMAIL=\"/bin/sendmail\"",
											 "LIBTIFF=\"-L/lib -ltiff\"",
											 "TIFFINC=\"/include\"",
											 "TIFFBIN=\"/bin\"",
											 "LIBZ=\"-L/lib -lz\"",
											 "ZLIBINC=\"-I/include\"",
											 "LIBDB=\" \"",
											 "DBLIBINC=\"/include\"",
											 "DIR_HTML=\"#{wwwdir}\"",
											 "DIR_CGI=\"#{wwwdir('cgi-bin')}\"",
											 "HTMLPATH=\"/hylafax/\"",
											 "CGIPATH=\"/hylafax/cgi-bin/\"",
											 "SYSGID=\"users\"",
											 "SYSUID=\"rubyx\"",
											 "CHGRP=\"/bin/chgrp\"",
											 "CHMOD=\"/bin/chmod\"",
											 "CHOWN=\"/bin/chown\""
											 )
		ENV['LD_LIBRARY_PATH'] = $glibc.configdir('ld.so.conf').fread.join(':')
		ENV['_POSIX2_VERSION']='199209' #Make head -1 etc work
		bash "env"
		File.makedirs(libdir,wwwdir('cgi-bin'))
		bash "./configure --target=#{$host.full} --nointeractive"
		bash "make" #4.1.7 doesn't like parallel make
		bash "make install"
		bash "sh root.sh",ASROOT
		User.asroot {
			statedir('etc/FaxDispatch').fwrite('FILETYPE=tif;','SENDTO=FaxMaster;',
																				 'MIMENCODE=bin/uuencode_it;')
			statedir('bin/uuencode_it').fwrite('#!/bin/sh',
																				 'uuencode -m $1 $1 | grep -E -v "^begin|^====$" 2>/dev/null')
			statedir('bin/uuencode_it').chmod(0755)
		}
		configdir('hylafax-enabled').ftouch("# yes/on/no/off","no")
  end

end; Pkg_Hylafax.new()

#===============================================================================
class Pkg_Ibod < Package
#===============================================================================

  def initialize()
		super('ISDN bandwidth on demand','1.4')
		@versions={
			'1.4'=>['ibod-1.4-src.tar.gz']
		}
		join('isdn')
  end

  def build()
		unpack(@versions[@select[0]][0])
		bash "chmod +w *"
		globaledit('/etc/ppp',statedir)
		globaledit('/dev/isdn','/dev/isdn/isdn')
		'ibod.h'.freplace('/etc/ppp',statedir) #Put in state as init creates this file
		bash "make"
		File.makedirs(bindir,statedir,mandir(1),mandir(4))
		File.install('ibod',bindir,0755)
		File.install('ibod.1',mandir(1),0644)
		File.install('ibod.cf.4',mandir(4),0644)
		configdir('ibod-enabled').ftouch("# yes/no/on/off","no")
  end

end; Pkg_Ibod.new()

#===============================================================================
class Pkg_Isdn4k_Utils < Package
#===============================================================================

  def initialize()
		super('Isdn utilities','3.2p1')
		@versions={
			'3.2p1'=>['isdn4k-utils.v3.2p1.tar.bz2','isdn4k-utils.v3.2p1.patch']
		}
		join('isdn')
		needs('ibod')
		wants('xfree86')
		syncwith('linux')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		patch('isdn4k-utils.v3.2p1.patch')
		globaledit('/etc/ppp',statedir)
		'.config'.fwrite("# CONFIG_EXPERIMENTAL is not set",
										 "CONFIG_KERNELDIR='#{$linux.source}'",
										 "CONFIG_BINDIR='#{bindir}'",
										 "CONFIG_SBINDIR='#{sbindir}'",
										 "CONFIG_MANDIR='#{mandir}'",
										 "CONFIG_RUNDIR='/var/run'",
										 "CONFIG_LOCKDIR='/var/lock'",
										 "CONFIG_LOCKFILE='LCK..'",
										 "CONFIG_I4LCONFDIR='#{configdir}'",
										 "CONFIG_CONFFILE='isdn.conf'",
										 "CONFIG_CALLERIDFILE='callerid.conf'",
										 "CONFIG_USERCONFFILE='~/.isdn'",
										 "CONFIG_COUNTRYCODE='44'",
										 "CONFIG_AREACODE=''",
										 "CONFIG_COUNTRY_PREFIX='+'",
										 "CONFIG_AREA_PREFIX='0'",
										 "CONFIG_DATADIR='#{datadir}'",
										 "CONFIG_ISDNCTRL=y",
										 "CONFIG_ISDNCTRL_CONF=y",
										 "CONFIG_ISDNCTRL_TIMRU=y",
										 "CONFIG_IPROFD=y",
										 "# CONFIG_DIVERTCTRL is not set",
										 "CONFIG_HISAXCTRL=y",
										 "CONFIG_ICNCTRL=y",
										 "# CONFIG_ICNCTRL_DEBUG is not set",
										 "CONFIG_PCBITCTL=y",
										 "# CONFIG_AVMCAPICTRL is not set",
										 "CONFIG_ACTCTRL=y",
										 "CONFIG_EICONCTRL=y",
										 "CONFIG_IMON=y",
										 "CONFIG_IMONTTY=y",
										 "# CONFIG_ISDNLOG=y",
										 "# CONFIG_ISDNLOG_SERV_PORT=20011",
										 "# CONFIG_ISDNLOG_USERFILE='isdnlog.users'",
										 "# CONFIG_ISDNLOG_CHARGEFILE='charge.dat'",
										 "# CONFIG_ISDNLOG_LOGFILE='#{statedir}/isdn.log'",
										 "# CONFIG_ISDNLOG_RELOADCMD='reload'",
										 "# CONFIG_ISDNLOG_STOPCMD='stop'",
										 "# CONFIG_ISDNLOG_REBOOTCMD='/sbin/reboot'",
										 "# CONFIG_ISDNLOG_OLDI4LCONFDIR='/etc/isdnlog'",
										 "# CONFIG_ISDNLOG_OLDI4LCONFFILE='isdnlog.conf'",
										 "# CONFIG_ISDNLOG_POSTGRES is not set",
										 "# CONFIG_ISDNLOG_MYSQLDB is not set",
										 "# CONFIG_ISDNLOG_ORACLE is not set",
										 "# CONFIG_ISDN_LOG_DE=y",
										 "# CONFIG_ISDN_LOG_CC_DE=y",
										 "# CONFIG_ISDN_LOG_DEST_DE=y",
										 "# CONFIG_ISDN_LOG_DEST_AT is not set",
										 "# CONFIG_ISDN_LOG_DEST_NL is not set",
										 "# CONFIG_ISDN_LOG_DEST_CH is not set",
										 "CONFIG_IPPPSTATS=y",
										 "# CONFIG_VBOX is not set",
										 "CONFIG_IPPPD=y",
										 "# CONFIG_IPPPD_MSCHAP is not set",
										 "# CONFIG_IPPPD_RADIUS is not set",
										 "# CONFIG_RADIUS_WTMP_LOGGING is not set",
										 "RADIUS_CLIENT_CONFIG_FILE=''",
										 "CONFIG_GENMAN=y",
										 "# CONFIG_FAQ is not set"
										 )
		# The X stuff tries to install in an X directory, 
		# so disable until I have time to fix it
		#'.config'.fcat(
		#							 "CONFIG_BUILDX11=y","CONFIG_XISDNLOAD=y","CONFIG_XMONISDN=y"
		#							 ) if Link.find('xfree86').home

		'Makefile'.freplace(/install: rootperm/,'install:')
		'Makefile'.freplace(/sh scripts\/makedev\.sh/,'echo')
		'imontty/Makefile'.freplace(/rootperm install-man/,'install-man')
		'imontty/Makefile'.freplace(/-o 0 -g 0/,'')
		'isdnlog/Makefile.in'.freplace(/installdirs: rootperm/,'installdirs:')
		'isdnlog/Makefile.in'.freplace(/install: all rootperm/,'install: all')
		(
		 %w{ act2000 areacode avmb1 divertctrl doc eicon hisax icn imon ipppd}+
		 %w{ ipppstats iprofd isdnctrl isdnlog isdnlog/tools/dest isdnlog/tools/zone}+
		 %w{ isdnlog/tools/telrate lib loop pcbit	}
		 ).each { |dir| (dir+'/Makefile.in').freplace(/-o 0 -g 0/,'') }

		[sbindir,configdir].each { |d| d.mkdir }
		bash "make subconfig"
		bash "make -j#{$make_jobs}"
		bash "make install"
		configdir('isdn-enabled').ftouch("# yes/on/no/off","no")
		configdir('local-number').ftouch('#Local ISDN number')
		configdir('username').ftouch('#Your username')
		configdir('password').ftouch('#Your password')
		configdir('remote-number').ftouch('#Your ISPs ISDN access number')
		configdir('ip-address').ftouch('#Your static IP, or blank if dynamically allocated')
		configdir('permanent-channels').ftouch('#Number of channels to hold open','0')
		configdir('total-channels').ftouch('#Total number of channels','2')
		configdir('on-demand-threshold').ftouch('#Demand threshold in bytes/second','7000')
		configdir('hangup-delay').ftouch('#Minimum time a channel will stay open in seconds','60')
		statedir('ip-down').ftouch('#!/bin/ruby',
																'system(\'/bin/logger -t ISDN "All channels down"\')',
																'system("/sbin/route add default metric 1 ippp0")',
																'if ENV[\'PERMANENT\'].to_i>0',
																'  system(\'/bin/logger -t ISDN "Dialing"\')',
																'  system(\'/sbin/isdnctrl dial ippp0\')',
																'end')
		statedir('ip-down').chmod(0755)
		statedir('ip-up').ftouch('#!/bin/ruby',
															'system(\'/bin/logger -t ISDN "Channel up"\')',
															'(ENV[\'PERMANENT\'].to_i - 1).times {',
															'  system(\'/bin/logger -t ISDN "Adding permanent channel"\')',
															'  system(\'/sbin/isdnctrl addlink ippp0\') }')
		statedir('ip-up').chmod(0755)
		statedir('ioptions').ftouch()
		statedir('pap-secrets').fcat('# Secrets for authentication using PAP',
																	'# client  server  secret  IP addresses',
																	'# "username * password *" will usually suffice')
		statedir('pap-secrets').chmod(0600)
		'pap-secrets'.link(statedir('chap-secrets'))		
  end

end; Pkg_Isdn4k_Utils.new()

#===============================================================================
class Pkg_Kernel_headers < Package
#===============================================================================

  def initialize()
		super('System kernel headers','v2.4.20')
		@versions={'v2.4.20'=>[]}
		tools('bitkeeper')
		join('base')
  end

  def build()
		$linux.bkexport(@select[0]).cd
		bash "make mrproper"
		bash "yes \"\" | make ARCH=#{$host.generic} config"
		path($root,incdir).mkdir
		bash "make include/linux/version.h"
		'include/linux'.rcp(path($root,incdir,'linux'))
		"include/asm-#{$host.generic}".rcp(path($root,incdir,"asm-#{$host.generic}"))
		File.symlink("asm-#{$host.generic}",path($root,incdir,'asm'))
  end

end; $kernel_headers = Pkg_Kernel_headers.new()

#===============================================================================
class Pkg_Netfilter < Package
#===============================================================================

  def initialize()
		super('Netfilter: Firewalling, NAT and packet mangling tools','1.2.8')
		@versions={'1.2.8'=>['iptables-1.2.8.tar.bz2']}
		join('net', 'server')
		syncwith('linux')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "make KERNEL_DIR=#{$linux.source} LIBDIR=/lib"
		bash "make KERNEL_DIR=#{$linux.source} LIBDIR=#{libdir} BINDIR=#{bindir} MANDIR=#{mandir} install"
		configdir('netfilter-enabled').ftouch("# yes/no/on/off","no")
		configdir('firewall').ftouch('#Interfaces to firewall (one per line)','#eth0')
		configdir('nat').ftouch('#Interfaces with Network Address Translation','#ppp0 -s 10.0/16')
  end

end; Pkg_Netfilter.new()

#===============================================================================
class Pkg_Nforce < Package
#===============================================================================

  def initialize()
		super('NVidia nforce chipset drivers','1.0-0261')
		@versions={'1.0-0261'=>['NVIDIA_nforce-1.0-0261.tar.gz']}
		syncwith('linux')
		join('driver')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "make -j#{$make_jobs} KERNSRC="+$linux.source
		bash "make INSTROOT=#{prefix} install"
		configdir('nforce-net-enabled').ftouch("# yes/on/no/off","yes")
		configdir('nforce-net-options').ftouch("#optimization=1|2 1=cpu,2=throughput(default)",
																					 "#speed=0|1|2  0=auto(default),1=10Mbps,2=100Mbps",
																					 "#duplex=0|1|2 0=auto(default),1=half,2=full")
		configdir('nforce-audio-enabled').ftouch("# yes/on/no/off","yes")
		configdir('nforce-audio-options').ftouch("#spdif_status=0|1 0=disabled,1=enabled(default)")
  end

end; Pkg_Nforce.new()

#===============================================================================
class Pkg_Kbd < Package
#===============================================================================

  def initialize()
		super('Keyboard utilities','1.08')
		@versions={'1.08'=>['kbd-1.08.tar.bz2']}
		join('base')
		tools('bison','flex')
		override('busybox')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "./configure --prefix=#{prefix} --datadir=/share/kbd"
		'src/Makefile'.freplace('-o root','')
		bash "make -j#{$make_jobs}"
		bash "make install"
  end

end; Pkg_Kbd.new()

#===============================================================================
class Pkg_Arts < KdePackage
#===============================================================================
  def initialize()
		super('The aRts sound server','1.1.4')
		@versions={
			'1.1.3'=>['arts-1.1.3.tar.bz2'],
			'1.1.4'=>['arts-1.1.4.tar.bz2']
		}
		join('kde-min','kde','kde-all')
  end
end; Pkg_Arts.new()

#===============================================================================
class Pkg_Kde_i18n < KdePackage
#===============================================================================
  def initialize()
		super('Multi-language support','3.1.4')
		@versions={
			'3.1.3'=>['kde-i18n-3.1.3.tar.bz2'],
			'3.1.4'=>['kde-i18n-3.1.4.tar.bz2']
		}
		needs('kdelibs')
		join('kde-all')
  end
end; Pkg_Kde_i18n.new()

#===============================================================================
class Pkg_Kdeaddons < KdePackage
#===============================================================================
  def initialize()
		super('Various plugins for Kate, Kicker, KNewsTicker, Konqueror and Noatun','3.1.4')
		@versions={
			'3.1.3'=>['kdeaddons-3.1.3.tar.bz2'],
			'3.1.4'=>['kdeaddons-3.1.4.tar.bz2']
		}
		needs('kdelibs','kdebase')
		wants('kdegames','kdemultimedia')
		join('kde','kde-all')
  end
end; Pkg_Kdeaddons.new()

#===============================================================================
class Pkg_Kdeadmin < KdePackage
#===============================================================================
  def initialize()
		super('System administration tools','3.1.4')
		@versions={
			'3.1.3'=>['kdeadmin-3.1.3.tar.bz2'],
			'3.1.4'=>['kdeadmin-3.1.4.tar.bz2']
		}
		needs('kdelibs')
		join('kde','kde-all')
  end
end; Pkg_Kdeadmin.new()

#===============================================================================
class Pkg_Kdeartwork < KdePackage
#===============================================================================
  def initialize()
		super('Additional wallpapers, themes, styles, sounds ...','3.1.4')
		@versions={
			'3.1.3'=>['kdeartwork-3.1.3.tar.bz2'],
			'3.1.4'=>['kdeartwork-3.1.4.tar.bz2']
		}
		needs('kdelibs','kdebase')
		join('kde','kde-all')
  end
end; Pkg_Kdeartwork.new()

#===============================================================================
class Pkg_Kdebase < KdePackage
#===============================================================================
  def initialize()
		super('The base applications that form the core of the K Desktop Environment','3.1.4')
		@versions={
			'3.1.3'=>['kdebase-3.1.3.tar.bz2'],
			'3.1.4'=>['kdebase-3.1.4.tar.bz2']
		}
		needs('kdelibs')
		join('kde-min','kde','kde-all')
  end
end; Pkg_Kdebase.new()

#===============================================================================
class Pkg_Kdebindings < KdePackage
#===============================================================================
  def initialize()
		super('Various bindings for other languages, including Java?, Perl, Python, ...','3.1.4')
		@versions={
			'3.1.3'=>['kdebindings-3.1.3.tar.bz2'],
			'3.1.4'=>['kdebindings-3.1.4.tar.bz2']
		}
		needs('kdelibs','kdebase')
		join('kde-all')
  end
end; #Pkg_Kdebindings.new()

#===============================================================================
class Pkg_Kdeedu < KdePackage
#===============================================================================
  def initialize()
		super('Educational and entertaining applications for KDE\'s younger users','3.1.4')
		@versions={
			'3.1.3'=>['kdeedu-3.1.3.tar.bz2'],
			'3.1.4'=>['kdeedu-3.1.4.tar.bz2']
		}
		needs('kdelibs')
		join('kde-all')
  end
end; Pkg_Kdeedu.new()

#===============================================================================
class Pkg_Kdegames < KdePackage
#===============================================================================
  def initialize()
		super('Various games like KMahjongg, KSnake, KAsteroids, and KPatience','3.1.4')
		@versions={
			'3.1.3'=>['kdegames-3.1.3.tar.bz2'],
			'3.1.4'=>['kdegames-3.1.4.tar.bz2']
		}
		needs('kdelibs')
		join('kde-all')
  end
end; Pkg_Kdegames.new()

#===============================================================================
class Pkg_Kdegraphics < KdePackage
#===============================================================================
  def initialize()
		super('Various applications like the PostScript? previewer, DVI previewer, and a drawing program.','3.1.4')
		@versions={
			'3.1.3'=>['kdegraphics-3.1.3.tar.bz2'],
			'3.1.4'=>['kdegraphics-3.1.4.tar.bz2']
		}
		needs('kdelibs')
		join('kde','kde-all')
  end
end; Pkg_Kdegraphics.new()

#===============================================================================
class Pkg_Kdelibs < KdePackage
#===============================================================================
  def initialize()
		super('Basic libs required to run kde apps','3.1.4')
		@versions={
			'3.1.3'=>['kdelibs-3.1.3.tar.bz2'],
			'3.1.4'=>['kdelibs-3.1.4.tar.bz2']
		}
		needs('arts','libart-lgpl')
		wants('cups')
		join('kde-min','kde','kde-all')
  end
end; Pkg_Kdelibs.new()

#===============================================================================
class Pkg_Kdemultimedia < KdePackage
#===============================================================================
  def initialize()
		super('Multimedia applications','3.1.4')
		@versions={
			'3.1.3'=>['kdemultimedia-3.1.3.tar.bz2'],
			'3.1.4'=>['kdemultimedia-3.1.4.tar.bz2']
		}
		needs('kdelibs','ogg-vorbis','cdparanoia')
		join('kde','kde-all')
  end
end; Pkg_Kdemultimedia.new()

#===============================================================================
class Pkg_Kdenetwork < KdePackage
#===============================================================================
  def initialize()
		super('Network apps, including KMail','3.1.4')
		@versions={
			'3.1.3'=>['kdenetwork-3.1.3.tar.bz2'],
			'3.1.4'=>['kdenetwork-3.1.4.tar.bz2']
		}
		needs('kdelibs')
		join('kde','kde-all')
  end
end; Pkg_Kdenetwork.new()

#===============================================================================
class Pkg_Kdepim < KdePackage
#===============================================================================
  def initialize()
		super('Personal Information Manager','3.1.4')
		@versions={
			'3.1.3'=>['kdepim-3.1.3.tar.bz2'],
			'3.1.4'=>['kdepim-3.1.4.tar.bz2']
		}
		needs('kdelibs')
		join('kde','kde-all')
  end
end; Pkg_Kdepim.new()

#===============================================================================
class Pkg_Kdesdk < KdePackage
#===============================================================================
  def initialize()
		super('Software development kit','3.1.4')
		@versions={
			'3.1.3'=>['kdesdk-3.1.3.tar.bz2'],
			'3.1.4'=>['kdesdk-3.1.4.tar.bz2']
		}
		needs('kdelibs')
		join('kde-all')
  end
end; Pkg_Kdesdk.new()

#===============================================================================
class Pkg_Kdetoys < KdePackage
#===============================================================================
  def initialize()
		super('Toys!','3.1.4')
		@versions={
			'3.1.3'=>['kdetoys-3.1.3.tar.bz2'],
			'3.1.4'=>['kdetoys-3.1.4.tar.bz2']
		}
		needs('kdelibs')
		join('kde','kde-all')
  end
end; Pkg_Kdetoys.new()

#===============================================================================
class Pkg_Kdeutils < KdePackage
#===============================================================================
  def initialize()
		super('Various desktop tools like a calculator, an editor and other nifty stuff.','3.1.4')
		@versions={
			'3.1.3'=>['kdeutils-3.1.3.tar.bz2'],
			'3.1.4'=>['kdeutils-3.1.4.tar.bz2']
		}
		needs('kdelibs')
		join('kde','kde-all')
  end
end; Pkg_Kdeutils.new()

#===============================================================================
class Pkg_Quanta < KdePackage
#===============================================================================
  def initialize()
		super('Quanta HTML authoring application','3.1.4')
		@versions={
			'3.1.3'=>['quanta-3.1.3.tar.bz2'],
			'3.1.4'=>['quanta-3.1.4.tar.bz2']
		}
		needs('kdelibs')
  end
end; Pkg_Quanta.new()

#===============================================================================
class Pkg_Koffice < KdePackage
#===============================================================================
  def initialize()
		super('Kde Office applications','1.2.1')
		@versions={'1.2.1'=>['koffice-1.2.1.tar.bz2']}
		needs('kdelibs')
  end
end; #Pkg_Koffice.new()

#===============================================================================
class Pkg_Less < Package
#===============================================================================

  def initialize()
		super('Text file paging tool','381')
		@versions={'381'=>['less-381.tar.gz']}
		join('base')
		tools('sed')
		needs('pcre','ncurses')
  end

  def build()
		super("--with-regex=pcre --with-editor=/bin/e")
  end

end; Pkg_Less.new()

#===============================================================================
class Pkg_Lesstif < Package
#===============================================================================

  def initialize()
		super('OSF/Motif compatible library','0.93.46')
		@versions={'0.93.46'=>['lesstif-0.93.46.tar.bz2']}
		needs('xfree86')
  end

end; Pkg_Lesstif.new()

#===============================================================================
class Pkg_Libao < Package
#===============================================================================

  def initialize()
		super('A component of Ogg Vorbis','0.8.3')
		@versions={'0.8.3'=>['libao-0.8.3.tar.gz']}
		join('ogg-vorbis')
		wants('arts')
		#wants('alsa') #Enable this once alsa is available in rubyx
  end

end; Pkg_Libao.new()

#===============================================================================
class Pkg_Libexif < Package
#===============================================================================

  def initialize()
		super('description','0.5.12')
		@versions={
			'0.5.12'=>['libexif-0.5.12.tar.gz']
		}
  end

end; Pkg_Libexif.new()

#===============================================================================
class Pkg_Libogg < Package
#===============================================================================

  def initialize()
		super('A component of Ogg Vorbis','1.0')
		@versions={'1.0'=>['libogg-1.0.tar.gz']}
		join('ogg-vorbis')
  end

end; Pkg_Libogg.new()

#===============================================================================
class Pkg_Libpcap < Package
#===============================================================================

  def initialize()
		super('Packet capture library (used by tcpdump)','2003.09.15')
		@versions={'2003.09.15'=>['libpcap-2003.09.15.tar.gz']}
  end

end; Pkg_Libpcap.new()

#===============================================================================
class Pkg_Libvorbis < Package
#===============================================================================

  def initialize()
		super('A component of Ogg Vorbis','1.0')
		@versions={'1.0'=>['libvorbis-1.0.tar.gz']}
		join('ogg-vorbis')
		needs('libogg')
  end

end; Pkg_Libvorbis.new()

#===============================================================================
class Pkg_Lynx < Package
#===============================================================================

  def initialize()
		super('Text web browser','2.8.4')
		@versions={'2.8.4'=>['lynx2.8.4.tar.bz2']}
  end

end; Pkg_Lynx.new()

#===============================================================================
class Pkg_Vorbis_tools < Package
#===============================================================================

  def initialize()
		super('A component of Ogg Vorbis','1.0')
		@versions={'1.0'=>['vorbis-tools-1.0.tar.gz']}
		join('ogg-vorbis')
		needs('libao','libogg','libvorbis','curl')
  end

end; Pkg_Vorbis_tools.new()

#===============================================================================
class Pkg_Libjpeg < Package
#===============================================================================

  def initialize()
		super('jpeg image compression library','6b')
		@versions={'6b'=>['jpegsrc.v6b.tar.gz']}
  end

  def build()
		File.makedirs(incdir,bindir,libdir,mandir(1))
		super("--enable-shared --enable-static")
  end

end; $libjpeg = Pkg_Libjpeg.new()

#===============================================================================
class Pkg_Libmcrypt < Package
#===============================================================================

  def initialize()
		super('Encryption library','2.5.7')
		@versions={'2.5.7'=>['libmcrypt-2.5.7.tar.gz']}
		tools('gawk')
  end

end; Pkg_Libmcrypt.new()

#===============================================================================
class Pkg_Libmng < Package
#===============================================================================

  def initialize()
		super('Multiple Image Network Graphics animation library','1.0.5')
		@versions={'1.0.5'=>['libmng-1.0.5.tar.gz']}
		needs('libjpeg','zlib')
  end

end; Pkg_Libmng.new()

#===============================================================================
class Pkg_Libpng < Package
#===============================================================================

  def initialize()
		super('Graphics file format library','1.2.5')
		@versions={'1.2.5'=>['libpng-1.2.5.tar.gz']}
		needs('zlib')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		'scripts/makefile.linux'.cp('makefile')
		bash "make -j#{$make_jobs} test"
		File.makedirs(incdir,libdir,mandir)
		bash "make prefix=#{prefix} BINPATH=#{bindir} LIBPATH=#{libdir} MANPATH=#{mandir} INCPATH=#{incdir} install"
  end

end; $libpng = Pkg_Libpng.new()

#===============================================================================
class Pkg_Libtiff < Package
#===============================================================================

  def initialize()
		super('Tiff image format library','3.6.0-beta2')
		@versions={'3.6.0-beta2'=>['tiff-v3.6.0-beta2.tar.gz']}
		needs('libjpeg','gzip','zlib')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		'config.site'.fcat('DSO=auto','JPEG=yes','ZIP=yes','HTML=no',
											 "DIR_BIN=#{bindir}",
											 "DIR_LIB=#{libdir}",
											 "DIR_INC=#{incdir}",
											 "DIR_MAN=#{mandir}",
											 'DIRS_LIBINC=/include',
											 'DIR_JPEGLIB=/lib',
											 'DIR_GZLIB=/lib')
		bash "./configure --target=#{$host.full} --noninteractive"
		bash "make -j#{$make_jobs}"
		File.makedirs(bindir,incdir,libdir,mandir)
		bash "make install"
  end

end; Pkg_Libtiff.new()

#===============================================================================
class Pkg_Libtool < Package
#===============================================================================

  def initialize()
    super('Tools for manipulating libraries and shared objects','1.5')
		@versions={'1.5'=>['libtool-1.5.tar.gz']}
    join('base')
    tools('tar','sed')
  end

end; Pkg_Libtool.new()

#===============================================================================
class Pkg_Linux < Package
#===============================================================================

	def extractTags()
		extractBkTags(path($root,SRCDIR,'linux'),@versions[@select[0]][0])
	end

	def readTags(); readAnyTags(path($root,SRCDIR,'linux')); end

	def source(); return prefix('linux-'+select[0][1..9]); end

	def bkexport(version) #example version="v2.4.22"
		dir = 'linux-'+version[1..9]
		bash "bk export -r#{version} #{path($root,SRCDIR,'linux','linux-'+version[1..3])} #{dir}"
		return dir
	end

  def initialize()
		super('The linux kernel','v2.4.22')
		#Setup a couple dummy tags (one must match default above)
		@versions={'v2.4.22'=>['linux-2.4'],'v2.5.60'=>['linux-2.5']}
		join('base')
		tools('bitkeeper','coreutils','bash','modutils')
  end

  def build()
		prefix.cd
		bkexport(@select[0]).cd
		bash "make mrproper"
		File.open('.config','w') { |f| $kconfig.each { |l| f<<l } }
		# Fixup problem with gcc install dirs and the kernels use of -nostdinc and -iwithprefix
		# by defining GCC_EXEC_PREFIX
		ENV['GCC_EXEC_PREFIX']=$gcc.libdir('gcc-lib')+'/'
		bash "env"
		bash "make ARCH=#{$host.generic} -j#{$make_jobs} oldconfig"
		bash "make ARCH=#{$host.generic} -j#{$make_jobs} dep"
		bash "make ARCH=#{$host.generic} -j#{$make_jobs} bzImage"
		bash "make ARCH=#{$host.generic} -j#{$make_jobs} modules"
		bash "make ARCH=#{$host.generic} INSTALL_MOD_PATH=#{prefix} modules_install",ASROOT
		prefix('kernel').mkdir
		prefix('linux-'+@select[0][1..9],'arch',$host.generic,'boot/bzImage').link(prefix('kernel/bzImage'))
  end

end; $linux = Pkg_Linux.new()

#===============================================================================
class Pkg_Linux_atm < Package
#===============================================================================

  def initialize()
		super('ATM userland tools','2.4.1')
		@versions={'2.4.1'=>['linux-atm-2.4.1.tar.gz']}
		tools('flex')
  end

end; Pkg_Linux_atm.new()

#===============================================================================
class Pkg_Maildrop < Package
#===============================================================================

  def initialize()
		super('Mail delivery agent and filter','1.6.1')
		@versions={
			'1.6.1'=>['maildrop-1.6.1.tar.bz2']
		}
		join('mail')
  end

end; Pkg_Maildrop.new()

#===============================================================================
class Pkg_Make < Package
#===============================================================================

  def initialize()
		super('Programming utility to automate compile and link process','3.80')
		@versions={'3.80'=>['make-3.80.tar.bz2']}
		join('base')
  end

	def build
		super('',"DESTDIR=#{$root}")
	end

end; Pkg_Make.new()

#===============================================================================
class Pkg_Man < Package
#===============================================================================

  def initialize()
		super('Man page utilities','1.5m2')
		@versions={
			'1.5m1'=>['man-1.5m1.tar.bz2'],
			'1.5m2'=>['man-1.5m2.tar.bz2']
		}
		join('base')
		tools('groff','coreutils')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		File.makedirs(bindir,sbindir,configdir)
		popen('./configure -ask',("\n"*19)+"#{bindir}\n#{sbindir}\n/man\n#{configdir}"+("\n"*16))
		bash "make"
		bash "make mandir=#{mandir} bindir=#{bindir} install"
		envdir('MANPATH').fwrite('/man')
  end

end; Pkg_Man.new()

#===============================================================================
class Pkg_Man_pages < Package
#===============================================================================

  def initialize()
		super('Basic manual pages','1.58')
		@versions={'1.58'=>['man-pages-1.58.tar.bz2']}
		join('base')
		tools('coreutils')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "make MANDIR=#{mandir} install"
  end

end; Pkg_Man_pages.new()

#===============================================================================
class Pkg_Mcrypt < Package
#===============================================================================

  def initialize()
		super('Encryption program replacing old unix crypt(1)','2.6.4')
		@versions={'2.6.4'=>['mcrypt-2.6.4.tar.gz']}
		needs('mhash')
  end

end; Pkg_Mcrypt.new()

#===============================================================================
class Pkg_Metalog < Package
#===============================================================================

  def initialize()
		super('Modern syslog replacement','0.7')
		@versions={'0.7'=>['metalog-0.7.tar.gz']}
		join('base')
		needs('pcre')
  end

  def build()
		super()
		configdir('metalog-enabled').ftouch("# yes/no/on/off","yes")
		File.syscopy('metalog.conf',configdir)
		User.asroot { '/var/log/lastlog'.ftouch() }
		configdir('options').ftouch("# metalog runtime options - see man metalog",
																"# DO NOT use --daemonize (init takes care of that)",
																"--async")
		sbindir('log').fwrite(
			'#! /bin/ruby -w',
			'begin',
			"system('killall -USR1 metalog')",
			"system('logger \"Disabled metalog caching\"')",
			"system('tail -n50 -f /var/log/everything/current')",
			'ensure',
			"system('logger \"Enabled metalog caching\"')",
			"system('killall -USR2 metalog')",
			'end'
		).chmod(0750)
  end

end; Pkg_Metalog.new()

#===============================================================================
class Pkg_Mhash < Package
#===============================================================================

  def initialize()
		super('Library of hash algorithms','0.8.18')
		@versions={'0.8.18'=>['mhash-0.8.18.tar.gz']}
		tools("gawk")
  end

end; Pkg_Mhash.new()

#===============================================================================
class Pkg_Mktemp < Package
#===============================================================================

  def initialize()
		super('Utility for maing temporary files and directories','1.5')
		@versions={'1.5'=>['mktemp-1.5.tar.gz']}
		join('base')
		override('busybox')
  end

end; Pkg_Mktemp.new()

#===============================================================================
class Pkg_Modutils < Package
#===============================================================================

  def initialize()
		super('Kernel module tools','2.4.25')
		@versions={'2.4.25'=>['modutils-2.4.25.tar.bz2']}
		join('base')
		tools('bison','flex')
		override('busybox')
  end

end; Pkg_Modutils.new()

#===============================================================================
class Pkg_Mutt < Package
#===============================================================================

  def initialize()
		super('Mail client','1.4.1i')
		@versions={
			'1.4i'=>['mutt-1.4i.tar.gz'],
			'1.4.1i'=>['mutt-1.4.1i.tar.gz']
		}
		wants('openssl')
  end

  def build()
		super("--enable-pop --enable-imap")
		configdir('Muttrc').freplace('# set mbox="~/mbox"','set mbox="~/Mail/mbox"')
		prefix('www').mkdir
		docdir('mutt/html').mv(wwwdir)
  end

end; Pkg_Mutt.new()

#===============================================================================
class Pkg_M4 < Package
#===============================================================================

  def initialize()
		super('Macro language processor','1.4ppre2')
		@versions={'1.4ppre2'=>['m4-1.4ppre2.tar.gz']}
		join('base')
		tools('tar')
  end

  def build()
		super("--with-modules")
  end

end; Pkg_M4.new()

#===============================================================================
class Pkg_Ncurses < Package
#===============================================================================

  def initialize()
		super('Terminal text formatting library','5.3')
		@versions={'5.3'=>['ncurses-5.3.tar.gz',['ncurses-5.3.patch',1]]}
		join('base')
		tools('gawk','coreutils') #Needs C++ compiler in gcc
		override('busybox')
  end

  def build()
		ENV['LD_LIBRARY_PATH']=libdir
		bash "env"
		super("--with-shared --enable-symlinks","-j1")
		bash "chmod 755 #{libdir}/*.so*"
		bash "ln -sf libncurses.a #{libdir}/libcurses.a"
  end

end; Pkg_Ncurses.new()

#===============================================================================
class Pkg_Netkit_base < Package
#===============================================================================

  def initialize()
		super('Fundamental network tools','0.17')
		@versions={'0.17'=>['netkit-base-0.17.tar.gz','port-numbers']}
		join('net', 'server')
		tools('coreutils')
		override('busybox')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		File.makedirs(etcdir,bindir,sbindir,mandir(8))
		bash "./configure --exec-prefix=#{prefix} --prefix=#{prefix}"
		'ping/Makefile'.freplace('-o root','')
		bash "make -j#{$make_jobs}"
		bash "make install"
		%w{hosts host.conf inetd.conf networks protocols}.each { |fn|
			File.copy('etc.sample/'+fn,etcdir) }
		File.copy(path($root,SRCDIR,@name,'port-numbers'),path(etcdir,'services'))
		path(etcdir,'services').fedit { |line|
			line.gsub!("\C-M","")
			if line =~ /(^\S+)\s+(\d+)\/(\S+)\s+(\S+|$)/
				sname,sport,sencap,sdesc = $1,$2,$3,$4
				line.replace "#{$1.ljust(20)} #{$2.rjust(5)}/#{$3.ljust(6)}##{$4}\n"
			else
				line.replace("#"+line) unless line[0]==?#
			end
		}
  end
	
end; Pkg_Netkit_base.new()

#===============================================================================
class Pkg_Netkit_ftp < Package
#===============================================================================

  def initialize()
		super('Ftp client','0.17')
		@versions={'0.17'=>['netkit-ftp-0.17.tar.gz']}
		join('net', 'server')
		needs('ncurses')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		File.makedirs(bindir,mandir(1),mandir(5))
		bash "./configure --exec-prefix=#{prefix} --prefix=#{prefix}"
		bash "make -j#{$make_jobs}"
		bash "make MANDIR=#{mandir} install"
  end

end; Pkg_Netkit_ftp.new()

#===============================================================================
class Pkg_Netkit_telnet < Package
#===============================================================================

  def initialize()
		super('Telnet client and daemon','0.17')
		@versions={'0.17'=>['netkit-telnet-0.17.tar.gz',['netkit-telnet-0.17.patch',1]]}
		join('net', 'server')
		needs('ncurses')
		override('busybox')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		patch('netkit-telnet-0.17.patch')
		File.makedirs(bindir,sbindir,mandir(1),mandir(5),mandir(8))
		bash "./configure --exec-prefix=#{prefix} --prefix=#{prefix} --with-c++-compiler=g++"
		bash "make -j#{$make_jobs} MANDIR=#{mandir}"
		bash "make MANDIR=#{mandir} install"
		File.mv(path(sbindir,'in.telnetd'),path(sbindir,'telnetd'))
		File.delete(path(mandir(8),'telnetd.8'))
		File.mv(path(mandir(8),"in.telnetd.8"),path(mandir(8),"telnetd.8"))
  end

end; Pkg_Netkit_telnet.new()

#===============================================================================
class Pkg_Net_tools < Package
	#Patch for gcc3.3 fixes deprecated line-wrapped strings
	#Patch for 2.5 fixes changes in 2.5 X25 header
#===============================================================================

  def initialize()
		super('Fundamental network tools','1.60')
		@versions={'1.60'=>['net-tools-1.60.tar.bz2',['net-tools-1.60-gcc3.3.patch',1],
				['net-tools-1.60-linux-2.5.patch',1]]
			}
		join('net', 'server')
		tools('bash')
		override('coreutils')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		patch('net-tools-1.60-gcc3.3.patch')
		patch('net-tools-1.60-linux-2.5.patch') if $linux.select[0][0..2] == '2.5'
		popen('make config','yyyynnnnnynnnynyyynnnnnynynnnnnnyyy'.gsub(/(\S)/,'\1'+"\n"))
		bash "make"
		bash "make BASEDIR=#{prefix} install"
		bash "mv #{prefix('usr/share')} #{prefix}"
		bash "mv #{prefix('share/man')} #{prefix}"
		Dir.delete(prefix('usr'))
		configdir('network-enabled').ftouch("# yes/no/on/off","yes")
		configdir('rp-filter').ftouch("# Enable rogue packet filter, yes/on/no/off", "yes")
		configdir('forwarding').ftouch("# Enable forwarding, yes/on/no/off", "no")
		configdir('local-domains').ftouch("# Your domain name eg microsoft.com")
		configdir('search-domains').ftouch("# Domains to search for unqualified names")
		configdir('name-servers').ftouch("# 10.0.0.1 or ns1.mydomain.com")
		configdir('interfaces').ftouch("#Interface ip-address netmask broadcast [gateway [priority]]",
																	 "#or",
																	 "#Interface dhcp",
																	 "#lo     127.0.0.1  255.0.0.0   127.255.255.255",
																	 "#dummy  172.16.0.1 255.255.0.0 172.16.255.255",
																	 "#eth0   dhcp",
																	 "#eth1   10.0.2.1   255.255.0.0 10.0.255.255   10.0.0.1",
																	 "#eth1:0 10.0.2.2   255.255.0.0 10.0.255.255")

  end

end; Pkg_Net_tools.new()

#===============================================================================
class Pkg_Ntp < Package
#===============================================================================

  def initialize()
		super('Network time protocol tools','4.1.1')
		@versions={'4.1.1'=>['ntp-4.1.1.tar.gz']}
  end

  def build()
		super()
		File.makedirs(configdir,statedir,wwwdir)
		'html'.rcp(wwwdir)
		wwwdir('index.htm').link(wwwdir('index.html'))
		configdir('ntp-enabled').ftouch("# yes/no/on/off","yes")
		configdir('servers').ftouch("# One or more ntp servers. None to disable",
																"# See http://www.eecis.udel.edu/~mills/ntp/servers.html")
		configdir('ntpd-options').ftouch("# Ntpd startup options")
  end

end; Pkg_Ntp.new()

#===============================================================================
class Pkg_Nut < Package
#===============================================================================

  def initialize()
		super('Network UPS tools','1.4.0')
		@versions={'1.4.0'=>['nut-1.4.0.tar.gz']}
  end

  def build()
		super("--with-drvpath=#{prefix('drivers')} --with-statepath=#{statedir} --with-user=ups")
		configdir('nut-enabled').ftouch("# yes/on/no/off","no")
		configdir('upsdrvctl-options').ftouch("#Upsdrvctl commandline options. See man upsdrvctld", "-v")
		configdir('upsd-options').ftouch("#Upsd commandline options. see man upsd")
		umask0 { statedir.mkdir(0700) }
		bash "chown -R ups:daemon #{configdir} #{statedir}",ASROOT
  end

end; Pkg_Nut.new()

#===============================================================================
class Pkg_Nvidia < Package
#===============================================================================

  def initialize()
		super('Nvidia display drivers','1.0-4363')
		@versions={'1.0-4363'=>['NVIDIA-Linux-x86-1.0-4363.run']}
  end

end; #Pkg_Nvidia.new()

#===============================================================================
class Pkg_Openjade < Package
#===============================================================================

  def initialize()
		super('James Clark\'s implementation of DSSSL','1.3.2')
		@versions={
			'1.3.2'=>['openjade-1.3.2.tar.gz']
		}
		needs('opensp')
		wants('tetex')
		join('docbook')
  end

	def build()
		super
		File.makedirs(wwwdir)
		'jadedoc'.rcp(wwwdir)
		'dsssl'.rcp(datadir)
		datadir('README.jadetex').rm
		envdir('SGML_CATALOG_FILES').fcat(datadir('catalog'))
	end

end; Pkg_Openjade.new()

#===============================================================================
class Pkg_Jadetex < Package
#===============================================================================

  def initialize()
		super('TeX macros implementing the TeX output from the Jade/OpenJade DSSSL processor','3.13')
		@versions={
			'3.13'=>['jadetex-3.13.tar.gz']
		}
		needs('openjade')
		syncwith('tetex')
		join('docbook')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "make DESTDIR=#{prefix} install"
		bindir.mkdir
		'/bin/tex'.link(bindir('jadetex'))
		'/bin/pdftex'.link(bindir('pdfjadetex'))
		bash "mktexlsr",ASROOT
  end

end; Pkg_Jadetex.new()

#===============================================================================
class Pkg_Opensp < Package
#===============================================================================

  def initialize()
		super('James Clark\'s implementation od DSSSL','1.5')
		@versions={
			'1.5'=>['OpenSP-1.5.tar.gz',['opensp-1.5-reorder-class.patch',1]]
		}
		join('docbook')
  end

  def build()
		super()
		envdir('SGML_CATALOG_FILES').fcat(datadir('OpenSP/catalog'))
		docdir.mv(prefix('www'))
  end

end; Pkg_Opensp.new()

#===============================================================================
class Pkg_Openssh < Package
#===============================================================================

  def initialize()
		super('Secure shell - remote access utilities','3.7p1')
		@versions={
			'3.6.1p2'=>['openssh-3.6.1p2.tar.gz'],
			'3.7p1'=>['openssh-3.7p1.tar.gz']
		}
		tools('gcc')
		needs('openssl','zlib')
  end

  def build()
		super("--with-mantype=man")
		configdir.mkdir
		configdir('openssh-enabled').ftouch("# yes/on/no/off","no")
		
  end

end; Pkg_Openssh.new()

#===============================================================================
class Pkg_Openssl < Package
#===============================================================================

  def initialize()
		super('Open implementation of the SSL and TLS protocols','0.9.7c')
		@versions={
			'0.9.7b'=>['openssl-0.9.7b.tar.gz'],
			'0.9.7c'=>['openssl-0.9.7c.tar.gz']
		}
		join('base')
		tools('perl','zlib') #Needs real ar from binutils
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "./config --prefix=#{prefix} --openssldir=#{configdir} threads shared zlib-dynamic"
		bash "make -j1"
		bash "make MANDIR=#{mandir} install"
		File.mv(path(prefix,"include"),incdir)
  end

end; Pkg_Openssl.new()

#===============================================================================
class Pkg_Pkgconfig < Package
#===============================================================================

  def initialize()
		super('Compile/link flags management tool','0.15.0')
		@versions={
			'0.15.0'=>['pkgconfig-0.15.0.tar.gz']
		}
  end
	
	def build()
		super()
		envdir('PKG_CONFIG_PATH').fwrite('/lib/pkgconfig')
	end

end; Pkg_Pkgconfig.new()

#===============================================================================
class Pkg_Patch < Package
#===============================================================================

  def initialize()
		super('Utility for patching source files','2.5.8')
		@versions={'2.5.8'=>['patch-2.5.8.tar.gz']}
		join('base')
		override('busybox')
  end

end; Pkg_Patch.new()

#===============================================================================
# Pcmcia-cs
# Do not enable pcmcia in kernel if you want to use this packages drivers.
# Make sure kernel IS configured with network devices/wireless lan or the orinocco
# drivers are not built
#
class Pkg_Pcmcia_cs < Package
#===============================================================================

  def initialize()
		super('Pcmcia card services','3.2.4')
		@versions={'3.2.4'=>['pcmcia-cs-3.2.4.tar.gz']}
		wants('xfree86')
		syncwith('linux')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		User.asroot {
			'debug-tools/Makefile'.freplace('usr/share','share')
			'debug-tools/lspnp.c'.freplace('/usr/share',datadir)
		}
		bash "./Configure -n --notrust --pnp --cardbus --srctree --kernel="+$linux.source
		bash "make -j#{$make_jobs} all"
		bash "make PREFIX=#{prefix} MANDIR=#{mandir} install"
		path(etcdir,'rc.d').rrm
		configdir.mkdir
		configdir('pcmcia-enabled').ftouch("# Enable pcmcia yes/on/no/off","no")
		configdir('pcic').ftouch("# Should be i82365 or tcic","i82365")
		configdir('pcic-opts').ftouch("# Put socket driver timing parameters here")
		configdir('core-opts').ftouch("# Put pcmcia_core options here")
		configdir('cardmgr-opts').ftouch("# Put cardmgr options here")
		configdir('scheme').ftouch("# Set the PCMCIA scheme")
  end

end; $pcmcia_cs = Pkg_Pcmcia_cs.new()


#===============================================================================
class Pkg_Pcre < Package
#===============================================================================

  def initialize()
		super('Perl compatible regular expressions','3.9')
		@versions={'3.9'=>['pcre-3.9.tar.bz2']}
		join('base')
		tools('sed')
  end

end; Pkg_Pcre.new()

#===============================================================================
class Pkg_Pciutils < Package
#===============================================================================

  def initialize()
		super('Pci bus utilities','2.1.11')
		@versions={'2.1.11'=>['pciutils-2.1.11.tar.gz']}
		join('base')
		tools('coreutils')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		#bash "make PREFIX=/usr SHAREDIR=/usr/share"
		bash "make PREFIX=#{prefix} MANDIR=#{mandir} SHAREDIR=#{datadir}"
		bash "make PREFIX=#{prefix} MANDIR=#{mandir} SHAREDIR=#{datadir} install"
  end

end; Pkg_Pciutils.new()

#===============================================================================
class Pkg_Perl < Package
#===============================================================================

  def initialize()
		super('Interpreted programming language','5.8.1')
		@versions={
			'5.8.0'=>['perl-5.8.0.tar.gz'],
			'5.8.1'=>['perl-5.8.1.tar.gz']
		}
		join('base')
		tools('gawk','coreutils')
		needs('berkeleydb') #So that db_file module gets built
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "./Configure -Dprefix=#{prefix}/ -Dman1dir=#{mandir('1')} "+
			"-Dman3dir=#{mandir('3')} -Dccflags=\"#{ENV['CFLAGS']}\" -Darchname=#{$host.full} "+
			"-Dprivlib=#{libdir('perl5',@select[0])} -Darchlib=#{libdir('perl5',@select[0],$host.full)} "+
			"-Dsitelib=#{libdir('perl5/site_perl',@select[0])} "+
			"-Dsitearch=#{libdir('perl5/site_perl',@select[0],$host.full)} -des"
		bash "make"
		bash "make install"
		envdir('PERL5LIB').fwrite("/lib/perl5/#{@select[0]}",
															"/lib/perl5/#{@select[0]}/#{$host.full}",
															"/lib/perl5/site_perl/#{@select[0]}",
															"/lib/perl5/site_perl/#{@select[0]}/#{$host.full}")

  end

end; $perl=Pkg_Perl.new()

#===============================================================================
class Pkg_PM_Timer_HiRes < PerlModule
#===============================================================================

  def initialize()
		super('High resolution timer/alarm','1.50')
		@versions={'1.50'=>['Time-HiRes-1.50.tar.gz']}
  end

end; #Pkg_PM_Timer_HiRes.new() #Think this is included in perl


#===============================================================================
class Pkg_PM_XML_Parser < PerlModule
#===============================================================================

  def initialize()
		super('XML Parser','2.34')
		@versions={'2.34'=>['XML-Parser-2.34.tar.gz']}
		needs('expat')
  end

end; Pkg_PM_XML_Parser.new()

#===============================================================================
class Pkg_PM_Libxml < PerlModule
#===============================================================================

  def initialize()
		super('A PerlSAX parser','0.07')
		@versions={'0.07'=>['libxml-perl-0.07.tar.gz']}
		needs('pm-xml-parser')
  end

end; Pkg_PM_Libxml.new()

#===============================================================================
class Pkg_PM_SGMLS < PerlModule
#===============================================================================

  def initialize()
		super('Class for postprocessing the output from the sgmls and nsgmls parsers.','1.03')
		@versions={'1.03'=>['SGMLSpm-1.03ii.tar.gz']}
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		File.makedirs(bindir,libdir('perl5/site_perl',$perl.select[0],$host.full))
		bash "make PERL=/bin/perl BINDIR=#{bindir} "+
			"PERL5DIR=#{libdir('perl5/site_perl',$perl.select[0],$host.full)} install"
	end

end; Pkg_PM_SGMLS.new()

#===============================================================================
class Pkg_Popt < Package
#===============================================================================

  def initialize()
		super('Commandline evaluation library','1.7')
		@versions={'1.7'=>['popt-1.7.tar.gz']}
  end

end; Pkg_Popt.new()

#===============================================================================
class Pkg_Ppp < Package
#===============================================================================

  def initialize()
		super('PPP daemon with atm support','2.4.0b2')
		@versions={'2.4.0b2'=>['ppp-2.4.0b2.tar.gz',['ppp-2.4.0b2-atm.patch',1]]}
		needs('linux-atm')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		patch('ppp-2.4.0b2-atm.patch')
		bash "chmod -R u+w scripts/ppp-on"
		globaledit('/etc/ppp',configdir)
		bash "./configure"
		bash "make BINDIR=#{bindir} MANDIR=#{mandir} ETCDIR=#{configdir} LIBDIR=#{libdir} -j#{$make_jobs}"
		bash "make BINDIR=#{bindir} MANDIR=#{mandir} ETCDIR=#{configdir} LIBDIR=#{libdir} INSTALL=install install"
		configdir('options').fwrite('debug','noauth','noipdefault','kdebug 1',
																'nopcomp','noccp','novj','persist','usepeerdns',
																'defaultroute','maxfail 0','lock',
																'plugin /lib/ppp/pppoatm.so 0.38',
																'user username@yourisp.com')
		configdir('pap-secrets').fcat('username@yourisp.com * nopassword *')
		'pap-secrets'.link(configdir('chap-secrets'))
		configdir('ppp-enabled').ftouch("# Enable ppp, yes/no","no")
  end

end; Pkg_Ppp.new()

#===============================================================================
class Pkg_Procinfo < Package
#===============================================================================

  def initialize()
		super('Utilities for displaying proc directory information','18')
		@versions={'18'=>['procinfo-18.tar.gz']}
		join('base')
		needs('ncurses')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "make -j#{$make_jobs} LDLIBS=-lncurses"
		bash "make prefix=#{prefix} install"
  end

end; Pkg_Procinfo.new()

#===============================================================================
class Pkg_Procps < Package
#===============================================================================

  def initialize()
		super('Process management utilities','3.1.9')
		@versions={'3.1.9'=>['procps-3.1.9.tar.gz']}
		join('base')
		needs('ncurses')
		override('busybox','coreutils')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "make DESTDIR=#{prefix} usr/bin=#{bindir}/ usr/proc/bin=#{bindir}/ "+
			"man1=#{mandir(1)}/ man5=#{mandir(5)}/ man8=#{mandir(8)}/ "+
			"usr/lib=#{libdir}/ usr/include=#{incdir}/ "+
			"install='install -D' ldconfig='' -j#{$make_jobs} install"
  end

end; Pkg_Procps.new()

#===============================================================================
class Pkg_Psmisc < Package
#===============================================================================

  def initialize()
		super('Process management utilities','21.3')
		@versions={'21.3'=>['psmisc-21.3.tar.gz']}
		join('base')
		tools('sed')
		needs('ncurses')
		override('busybox')
  end

  def build()
		ENV["_POSIX2_VERSION"]="199209" # Allow old sort -n +2 syntax
		super()
		File.symlink("killall",path(bindir,"pidof"))
  end

end; Pkg_Psmisc.new()

#===============================================================================
class Pkg_Pure_ftpd < Package
#===============================================================================

  def initialize()
		super('Simple secure ftp daemon','1.0.16a')
		@versions={
			'1.0.15'=>['pure-ftpd-1.0.15.tar.bz2'],
			'1.0.16a'=>['pure-ftpd-1.0.16a.tar.bz2']
		}
  end

  def build()
		super('--with-everything')
		configdir.mkdir
		configdir('pure-ftpd-enabled').ftouch('# yes/on/no/off','no')
		configdir('options').ftouch('#pure-ftpd commandline options. see man pure-ftpd',
																'--chrooteveryone','maxclientsnumber 10',
																'maxclientsperip 4','#--anonymousonly',
																'--anonymouscantupload','--createhomedir',
																'--dontresolve')
		docdir.mkdir
		%w{FAQ INSTALL NEWS README.*}.each { |t| Dir.glob(t).each { |f| File.syscopy(f,docdir) } }
  end

end; Pkg_Pure_ftpd.new()

#===============================================================================
class Pkg_Python < Package
#===============================================================================

  def initialize()
		super('Programming language','2.3')
		@versions={
			'2.3'=>['Python-2.3.tgz']
		}
  end

end; Pkg_Python.new()

#===============================================================================
class Pkg_Qmail < Package
#===============================================================================

  def initialize()
		super('A mail transport agent','1.03')
		@versions={'1.03'=>['qmail-1.03.tar.gz',['qmail-1.03.patch',1],
				['qmailqueue-patch',1],['qmail-0.0.0.0.patch',1],['sendmail-flagf.patch',0],
				'checkpassword-0.90.tar.gz',['checkpassword-0.90.patch',1]]
			}
		needs('ucspi-tcp')
		override('mutt')
  end

  def build()
		configdir.mkdir
		configdir('qmail-enabled').ftouch("# yes/on/no/off","yes")
		configdir('qmail-relay-enabled').ftouch("# yes/on/no/off","no")
		configdir('qmail-pop-enabled').ftouch("# yes/on/no/off","no")
		configdir('startup-cmd').ftouch("#qmail-start [default delivery] [logger [arg]]\n",
																		"# Using splogger to send the log through syslog.",
																		"# Using qmail-local to deliver messages to ~/Mail/Maildir by default.",
																		"qmail-start ./Mail/Maildir/ splogger qmail"
																		)
		configdir('allow-relay').ftouch('# Specify ip ranges which are allowed to relay',
																		'# Leave blank to disable relaying',
																		'#192.168.0.23','#192.168.10.','#10.')
		
		%w{qmaild qmaill qmailp qmailq qmailr qmails}.each { |user|
			bash 'usermod -d '+prefix+' '+user,ASROOT }
		bash 'usermod -d '+prefix+'/alias alias',ASROOT

		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		@versions[@select[0]][1..4].each { |p| patch(p[0],p[1]) }
		'conf-qmail'.fwrite(prefix)
		bash "make -j#{$make_jobs}"
		bash "make setup check",ASROOT
		bash "rm -rf /pkg/qmail/man/cat*",ASROOT
		bash "cp config config-fast #{bindir}",ASROOT
		User.aseuid(`id -u alias`.strip,`id -g alias`.strip) {
			prefix('alias','.qmail-postmaster').fwrite('alias')
			prefix('alias','.qmail-mailer-daemon').fwrite('alias')
			prefix('alias','.qmail-root').fwrite('alias')
			prefix('alias','Mail').mkdir
			system 'maildirmake '+prefix('alias/Mail/Maildir')
		}
		bash(bindir('maildirmake')+' /etc/skel/Mail/Maildir',ASROOT) unless '/etc/skel/Mail/Maildir'.directory?
		User.asroot {
			'/etc/skel/.qmail'.ftouch('./Mail/Maildir/')
			'/etc/skel/.qmail-default'.ftouch('./Mail/Maildir/')
		}

		unpack(@versions[@select[0]][5])
		Dir.glob('checkpassword*')[0].cd
		patch(@versions[@select[0]][6][0],@versions[@select[0]][6][1])
		'conf-home'.fwrite(prefix)
		bash "make -j#{$make_jobs}"
		bash "make setup check",ASROOT
  end

end; $qmail = Pkg_Qmail.new()

#===============================================================================
class Pkg_Qmail_Scanner < Package
#===============================================================================

  def initialize()
		super('Content scanner for Qmail','1.20rc3')
		@versions={
			'1.20rc3'=>['qmail-scanner-1.20rc3.tgz']
		}
		join('mail')
		tools()
		needs('qmail','maildrop') #,'pm-timer-hires') #,'pm-db-file')
		wants('clamav','perl','berkeleydb')
		syncwith()
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		File.makedirs(bindir,statedir)
		bash "yes | ./configure --qmaildir #{$qmail.prefix} --spooldir #{statedir} "+
			"--bindir #{bindir} --domain localhost --notify sender,nmladm --install",ASROOT
		User.asroot { bindir('qmail-scanner-queue.pl').freplace('#!/bin/perl -T',
													"#!/bin/perl -T\nuse lib \"#{ENV['PERL5LIB']}\";") }
  end

end; Pkg_Qmail_Scanner.new()

#===============================================================================
class Pkg_Qt < Package
#===============================================================================

  def initialize()
		super('Multiplatform C++ application framework','3.2.0')
		@versions={'3.2.0'=>['qt-x11-free-3.2.0.tar.bz2']}
		needs('xfree86','libpng','libmng','libjpeg')
		wants('cups')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		ENV['QTDIR'] = Dir.getwd
		ENV['PATH'] = ENV['PATH']+':'+Dir.getwd+'/bin'
		ENV['LD_LIBRARY_PATH'] = Dir.getwd+'/lib'
		popen "./configure -prefix #{prefix} -system-zlib -thread -system-libpng "+
			"-system-libjpeg -system-libmng -qt-gif -plugin-imgfmt-mng -no-stl -no-g++-exceptions "+
			"#{Link.find('cups').home ? '-cups' : ''} -v", "yes\n"
		bash "make -j#{$make_jobs}"
		bash "make install"
		prefix('usr').mkdir
		prefix.link(prefix('usr/qt'))
		prefix('doc').mv(prefix('www'))
		prefix('www/html').mv(wwwdir)
		envdir('QTDIR').fwrite('/usr/qt')

  end

end; Pkg_Qt.new()

#===============================================================================
class Pkg_RDesktop < Package
#===============================================================================

  def initialize()
		super('Windows Terminal Services client','1.2.0')
		@versions={
			'1.2.0'=>['rdesktop-1.2.0.tar.gz']
		}
		join('workstation')
		needs('xfree86','openssl')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "./configure --prefix=#{prefix}"
		bash "make -j#{$make_jobs}"
		bash "make install"
  end

end; Pkg_RDesktop.new()

#===============================================================================
class Pkg_RM_Rdoc < RubyModule
#===============================================================================

  def initialize()
		super('Code documentation tool','0.9.0')
		@versions={
			'0.9.0'=>['rdoc-0.9.0.tgz']
		}
  end

end; Pkg_RM_Rdoc.new()

#===============================================================================
class Pkg_RM_Ri < RubyModule
#===============================================================================

  def initialize()
		super('Interactive reference','0.8a')
		@versions={
			'0.8a'=>['ri-0.8a.tgz']
		}
  end

end; Pkg_RM_Ri.new()

#===============================================================================
class Pkg_RM_Text_Highlight < RubyModule
#===============================================================================

  def initialize()
		super('Interactive reference','1.0.2')
		@versions={
			'1.0.2'=>['text-highlight-1.0.2.tar.gz']
		}
  end

end; Pkg_RM_Text_Highlight.new()

#===============================================================================
class Pkg_Readline < Package
#===============================================================================

  def initialize()
		super('GNU readline library','4.3')
		@versions={'4.3'=>['readline-4.3.tar.gz']}
		join('base')
  end

  def build()
		super("--enable-shared")
		getdata(etcdir,'inputrc',0644)
  end

end; Pkg_Readline.new()

#===============================================================================
class Pkg_Reiserfsprogs < Package
#===============================================================================

  def initialize()
		super('ReiserFS tools','3.6.11')
		@versions={
			'3.6.11'=>['reiserfsprogs-3.6.11.tar.gz']
		}
		join('disk','server')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "./configure #{stdconfig}"
		bash "make -j#{$make_jobs}"
		bash "make install"
  end

end; Pkg_Reiserfsprogs.new()

#===============================================================================
class Pkg_Rsync < Package
#===============================================================================

  def initialize()
		super('File download and mirroring tool','2.5.6')
		@versions={'2.5.6'=>['rsync-2.5.6.tar.gz',['rsync-2.5.6.patch',1]]}
		join('base')
		tools('patch')
  end

  def build()
		super() { 
			'rsync.h'.freplace(/\/etc\/rsyncd.conf/,configdir('rsyncd.conf'))
		}
		configdir('rsyncd.conf').fwrite('#See man rsyncd.conf',
		                                'use chroot = yes',
		                                'max connections = 10',
		                                '[rubyx]',
		                                '  path = /home/rubyx/src',
		                                '  read only = yes',
		                                '  comment = Rubyx package sources')
		configdir('rsyncd.secrets').fwrite('#See man rsyncd.conf',
		                                "#Multiple lines containing username:password")
		configdir('rsyncd.secrets').chmod(0600)
		configdir('rsync-enabled').ftouch('# yes/on/no/off','no')
		configdir('rsync-options').ftouch('#extra rsync --daemon  options. see man rsync')
  end

end; Pkg_Rsync.new()

#===============================================================================
class Pkg_Ruby < Package
#===============================================================================

  def initialize()
		super('Object oriented interpreted programming language','1.8.0')
		@versions={'1.8.0'=>['ruby-1.8.0.tar.gz']}
		join('base')
		tools('sed','grep')
		needs('readline')
  end

  def build()
		User.asroot { File.makedirs('/lib/ruby/site_ruby/1.8/i686-linux') }
		super('--with-sitedir=/lib/ruby/site_ruby')
  end

end; Pkg_Ruby.new()


#===============================================================================
class Pkg_Rubyx < Package
#===============================================================================

	def extractTags(); extractBkTags(path($root,SRCDIR,'rubyx'),'rubyx'); end
	def readTags(); readAnyTags(path($root,SRCDIR,'rubyx')); end

  def initialize()
		super('Rubyx master control program','head')
		@versions={'head'=>['rubyx']}
		join('base')
		tools('bitkeeper')
  end

  def build()
		prefix.cd
		bash 'bk clone '+path($root,SRCDIR,@name,'rubyx')
		'rubyx'.cd {
			bash 'bk parent bk://ftp.rubyx.org/rubyx'
			bash 'bk co'
		}
		File.makedirs(sbindir,etcdir,configdir,libdir('ruby/site_ruby'))
		prefix('rubyx/rubyx').link(sbindir('rubyx'))
		prefix('rubyx/init').link(sbindir('init'))
		prefix('rubyx/strfile.rb').link(libdir('ruby/site_ruby/strfile.rb'))
		prefix('rubyx/init').link(sbindir('shutdown'))
		prefix('rubyx/init').link(sbindir('reboot'))
		prefix('rubyx/init').link(sbindir('die'))
		prefix('rubyx/init').link(sbindir('force-fsck'))
		prefix('rubyx/init').link(sbindir('start'))
		prefix('rubyx/init').link(sbindir('stop'))
		prefix('rubyx/init').link(sbindir('restart'))
		prefix('rubyx/init').link(sbindir('reload'))
		File.symlink(configdir('hostname'),etcdir('hostname'))
		configdir('hostname').ftouch('PleaseNameMe')
		configdir('keymap').ftouch('uk')
		configdir('hwclock').ftouch('# utc or localtime','utc')
		configdir('consolefont').ftouch('# default8x16')
		configdir('consoletrans').ftouch()
		configdir('consoles').ftouch('#agetty 9600 tty1','agetty 9600 tty2',
																 'agetty 9600 tty3','agetty 9600 tty4',
																 '#agetty 115200 ttyS0','#faxgetty ttyS1')
		configdir('fundamental-enabled').ftouch("# yes/no/on/off","yes")
	end

end; Pkg_Rubyx.new()

#===============================================================================
class Pkg_Samba < Package
#===============================================================================

  def initialize()
		super('File and print services for SMB/CIFS clients','3.0.0')
		@versions={
			'3.0.0'=>['samba-3.0.0.tar.bz2']
		}
		join('server')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		prefix('www').mkdir
		'docs'.rcp(wwwdir)
		File.makedirs(configdir('spool'))
		'examples/smb.conf.default'.cp(configdir('smb.conf'))
		'examples'.rcp(configdir('examples'))
		configdir('smb.conf').freplace('/usr/local/samba',statedir)
		configdir('smb.conf').freplace('/usr/spool/samba',statedir('spool'))
		configdir('smb.conf').freplace('/usr/','/')
		configdir('smb.conf').fcat('smb passwd file = /pkg/samba.1/config/smbpasswd')
		configdir('samba-enabled').ftouch("# yes/on/no/off","no")
		configdir('swat-enabled').ftouch("# yes/on/no/off","no")
		configdir('swat-ip').ftouch("# IP address to listen on","127.0.0.1")
		configdir('swat-port').ftouch("# TCP port number to listen on","901")
		configdir('swat-options').ftouch("#Swat options (see man swat)","#-a")
		Dir.glob('source')[0].cd
		bash "./configure #{stdconfig} --with-configdir=#{configdir}"
		bash "make"
		bash "make install"
  end

end; Pkg_Samba.new()

#===============================================================================
class Pkg_Sed < Package
#===============================================================================

  def initialize()
		super('Stream editor','4.0.7')
		@versions={'4.0.7'=>['sed-4.0.7.tar.gz',['sed-4.0.7.patch',1]]}
		join('base')
		tools('patch')
		override('busybox')
  end

end; Pkg_Sed.new()

#===============================================================================
class Pkg_sgmltools_lite < Package
#===============================================================================

  def initialize()
		super('A Python interface to SGML software specificially in a DocBook/OpenJade environment','3.0.3')
		@versions={
			'3.0.3'=>['sgmltools-lite-3.0.3.tar.gz']
		}
		needs('docbook-dsssl','python','openjade')
		join('docbook')
  end

  def build()
		super('--with-etcsgml='+configdir)
		envdir('SGML_CATALOG_FILES').fwrite(datadir("sgml/stylesheets/sgmltools/sgmltools.cat"),
		                                    datadir("sgml/dtd/sgmltools/catalog"))
  end

end; Pkg_sgmltools_lite.new()

#===============================================================================
class Pkg_Shadow < Package
#===============================================================================

  def initialize()
		super('Password hiding utility','4.0.3')
		@versions={'4.0.3'=>['shadow-4.0.3.tar.bz2']}
		join('base')
		override('busybox','coreutils')
  end

  def build()
		super("--prefix=#{prefix} --without-libcrack --enable-static")
		etcdir.mkdir
		'etc/limits'.cp(etcdir)
		'etc/login.access'.cp(etcdir)
		'etc/login.defs.linux'.freplace(/^MAIL_DIR/,'#MAIL_DIR')
		'etc/login.defs.linux'.freplace(/^#MAIL_FILE.*$/,'MAIL_FILE Mail/Maildir')		
		'etc/login.defs.linux'.cp(etcdir('login.defs'))
  end

end; Pkg_Shadow.new()

#===============================================================================
class Pkg_Sharutils < Package
#===============================================================================

  def initialize()
		super('Mime encoding/decoding tools','4.2.1')
		@versions={ '4.2.1'=>['sharutils-4.2.1.tar.gz',['sharutils-4.2.1.patch',0]] }
		join('base')
		override('busybox')
		tools('patch','sed','gettext')
  end

end; Pkg_Sharutils.new()

#===============================================================================
class Pkg_SodiPodi < Package
#===============================================================================

  def initialize()
		super('Vector Line drawing application using xml','default-version')
		@versions={
			'0.32'=>['sodipodi-0.32.tar.gz']
		}
		join('graphics','www')
		tools()
		needs('gtkplus','glib','libxml2','libart-lgpl','libpng','zlib')
		wants('popt','libgnomeprint','libgnomeprintui','Xft2')
		syncwith()
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "./configure #{stdconfig}"
		bash "make -j#{$make_jobs}"
		bash "make install"
  end

end; #Pkg_.new()  #REMEMBER TO FILL AND UNCOMMENT THIS DECLARATION

#===============================================================================
class Pkg_Sudo < Package
#===============================================================================

  def initialize()
		super('Utility which allows users to execute commands as root','1.6.7p5')
		@versions={'1.6.7p5'=>['sudo-1.6.7p5.tar.gz']}
		join('base')
		tools('tar')
  end

  def build()
		super('--with-editor=/bin/e','install_uid=rubyx install_gid=users')
		bindir('sudo').chmod(04755)
		configdir('sudoers').chmod(0440)
  end

end; Pkg_Sudo.new()

#===============================================================================
class Pkg_Tar < Package
#===============================================================================

  def initialize()
		super('Archiving utility','1.13.25')
		@versions={'1.13.25'=>['tar-1.13.25.tar.gz']}
		join('base')
		needs('bzip2')
		override('busybox')
  end

end; Pkg_Tar.new()

#===============================================================================
class Pkg_Tcl < Package
#===============================================================================

  def initialize()
		super('Tool command language','8.4.4')
		@versions={
			'8.4.2'=>['tcl8.4.2-src.tar.gz'],
			'8.4.4'=>['tcl8.4.4-src.tar.gz']
		}
		join('base')
		tools('sed')
  end

  def configure() #Needed by Expect and tk
		unpack(@versions[@select[0]][0])
		Dir.glob('tcl*/unix')[0].cd
		bash "./configure #{stdconfig}"
  end

  def build()
		configure
		bash "make -j#{$make_jobs}"
		bash "make -j#{$make_jobs} test" if $check
		bash "make install"
  end

end; Pkg_Tcl.new()

#===============================================================================
class Pkg_Tk < Package
#===============================================================================

  def initialize()
		super('An X11 toolkit implemented with the Tcl scripting language','8.4.4')
		@versions={
			'8.4.4'=>['tk8.4.4-src.tar.gz']
		}
		needs('xfree86')
		syncwith('tcl')
  end

  def configure() #Needed by Expect
		unpack(@versions[@select[0]][0])
		Dir.glob('tk*/unix')[0].cd
		bash "./configure #{stdconfig}"
  end

  def build()
		Package.find('tcl').configure
		'../..'.cd		
		configure
		bash "make -j#{$make_jobs}"
		bash "make -j#{$make_jobs} test" if $check
		bash "make install"
  end

end; Pkg_Tk.new()

#===============================================================================
class Pkg_Tcpdump < Package
#===============================================================================

  def initialize()
		#Release version 3.7.2 wont build with linux-2.4.21
		super('Tcp packet dumping utility','2003.09.15')
		@versions={'2003.09.15'=>['tcpdump-2003.09.15.tar.gz']}
		needs('libpcap')
  end

end; Pkg_Tcpdump.new()

#===============================================================================
class Pkg_Tetex < Package
#===============================================================================

  def initialize()
		super('description','2.0.2')
		@versions={
			'2.0.2'=>['tetex-src-2.0.2.tar.gz','tetex-texmf-2.0.2.tar.gz']
		}
		tools('ed') #Yes - really!
  end

  def build()
		File.makedirs(mandir,infodir,prefix('texmf'),bindir)
		prefix('texmf').mkdir.cd { unpack(@versions[@select[0]][1]) }
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "./configure --prefix=#{prefix} --disable-multiplatform"
		bash "make -j#{$make_jobs} all"
		bash "make install"
  end

end; Pkg_Tetex.new()

#===============================================================================
class Pkg_Texinfo < Package
#===============================================================================

  def initialize()
		super('Info manual page utility','4.6')
		@versions={'4.6'=>['texinfo-4.6.tar.bz2']}
		join('base')
		needs('ncurses')
  end

	def build()
		super
		envdir('INFOPATH').fwrite('/info')
	end

end; Pkg_Texinfo.new()

#===============================================================================
class Pkg_Tmda < Package
#===============================================================================

  def initialize()
		super('Tagged Message Delivery Agent; SPAM filter','0.85')
		@versions={ '0.85'=>['tmda-0.85.tgz'] }
		tools()
		needs('python')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].rcp(prefix)
		prefix.cd
		bash "./compileall"
		'etc'.mkdir
		'contrib/sample.config'.cp('etc/tmdarc')
  end

end; Pkg_Tmda.new()

#===============================================================================
class Pkg_Tnef < Package
#===============================================================================

  def initialize()
		super('Tool for unpacking Microsoft MS-TNEF MIME attachments','1.2.1')
		@versions={
			'1.2.1'=>['tnef-1.2.1.tar.gz']
		}
  end

end; #Pkg_Tnef.new()

#===============================================================================
class Pkg_Toolchain < Package
#===============================================================================

  def initialize()
		super('Cross-compile toolchain','amd64-1')
		@versions = { 'i386-1'=>[], 'amd64-1'=>[] }
		@subvers = { 
			'i386-1'=>['i386','binutils-2_14-branch','gcc_3_2_3_release','v2.4.20','glibc-2-3-1'],
			'amd64-1'=>['opteron','binutils-2_14-branch','gcc_3_2_3_release','v2.4.20','glibc-2-3-1']
		}
		needs('glibc','gcc','binutils','linux')
  end

  def build()
		cpu,binutilsVersion,gccVersion,linuxVersion,glibcVersion=@subvers[@select[0]]
		@target = Host.find(cpu)
		ENV['_POSIX2_VERSION']='199209'
		ENV['PATH'] = ENV['PATH']+':'+prefix('opt','bin')

		ENV.delete('CFLAGS')
		$binutils.checkout('sources.redhat','binutils',binutilsVersion)
		'work'.mkdir.cd {
			bash "env"
			bash "../src/configure --prefix=#{prefix('opt')} --target=#{@target.full}"
			bash "make -j#{$make_jobs}"
			bash "make install"
		}
		'src'.rrm
		'work'.rrm

		ENV['CFLAGS']='-Dinhibit_libc'
		$gcc.checkout('gcc','gcc',gccVersion)
		'work'.mkdir.cd {
			bash "env"
			bash "../gcc/configure --prefix=#{prefix('opt')} --target=#{@target.full} "+
				"--enable-languages=c --disable-shared --disable-multilib --enable-threads=single"
			bash "make -j#{$make_jobs}"
			bash "make install"
		}
		'gcc'.rrm
		'work'.rrm

		ENV.delete('CFLAGS')
		$linux.bkexport(linuxVersion).cd {
			bash "env"
			bash "make mrproper"
			bash "yes \"\" | make ARCH=#{@target.generic} config"
			bash "make include/linux/version.h"
			File.makedirs(prefix('opt',@target.full,'include'))
			'include/linux'.rcp(prefix('opt',@target.full,'include/linux'))
			('include/asm-'+@target.generic).rcp(prefix('opt',@target.full,'include/asm-'+@target.generic))
			File.symlink('asm-'+@target.generic,prefix('opt',@target.full,'include/asm'))
		}
		Dir.glob('linux-*')[0].rrm

		ENV.delete('CFLAGS')
		$glibc.checkout('glibc','libc',glibcVersion)
		'libc'.cd { $glibc.patch('glibc-2.3.1.patch') } if @select[0]=='amd64-1'
		'work'.mkdir.cd
		'configparms'.fwrite('BUILD_CC=gcc',"CC=#{@target.full}-gcc")
		bash "env"
		bash "../libc/configure --prefix=#{prefix('opt',@target.full)} --build=#{$host.full} "+
			"--host=#{@target.full} --without-cvs --enable-add-ons --disable-profile "+
			"--with-headers=#{prefix('opt',@target.full,'include')} --enable-kernel=2.4 "
		bash "make -j#{$make_jobs}"
		bash "make install"

		prefix('opt',@target.full,'bin').link(prefix('opt/bin',@target.full))
		path('opt/bin',$host)
  end

end; Pkg_Toolchain.new()

#===============================================================================
class Pkg_Unzip < Package
#===============================================================================

  def initialize()
		super('Decompression utility','550')
		@versions={'550'=>['unzip550.tar.gz']}
		join('base')
		override('busybox')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "make -j#{$make_jobs} -f unix/Makefile linux"
		bash "make -f unix/Makefile BINDIR=#{bindir} MANDIR=#{mandir}/man1 install"
  end

end; Pkg_Unzip.new()

#===============================================================================
class Pkg_Ucspi_tcp < Package
#===============================================================================

  def initialize()
		super('Unix Client Server Programming Interface using TCP','0.88')
		@versions={'0.88'=>['ucspi-tcp-0.88.tar.gz',['ucspi-tcp-0.88.patch',1],
				'ucspi-tcp-0.88-man.tar.gz']
			}
		tools('patch')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		@versions[@select[0]][1..99].each { |p|
			break unless p.class == Array
			patch(p[0],p[1])
		}
		bash "echo #{prefix} > conf-home"
		bash "make -j#{$make_jobs}"
		bash "make setup check"
		unpack(@versions[@select[0]][2])
		Dir.glob("*-man")[0].cd
		File.makedirs(mandir(1))
		bash "gzip *.1"
		bash "cp *.1.gz #{mandir(1)}"
  end

end; Pkg_Ucspi_tcp.new()

#===============================================================================
class Pkg_Util_linux < Package
#===============================================================================

  def initialize()
		super('Various fundamental tools','2.11z')
		@versions={'2.11z'=>['util-linux-2.11z.tar.bz2']}
		join('base')
		needs('kernel-headers')
		tools('coreutils')
		override('busybox')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		#Patch mount/unmount to use configdir('mtab') instead of /etc/mtab
		"MCONFIG".fedit { |line|
			line.gsub!("-o root","")
			line.gsub!(/CPU=.*/,"CPU=#{$host.generic}")
			line.gsub!(/ARCH=.*/,"ARCH=intel")
			line.gsub!(/ONLY_LISTED_SHELLS=yes/,"ONLY_LISTED_SHELLS=no")
			line.gsub!(/HAVE_SYSVINIT_UTILS=yes/,"HAVE_SYSVINIT_UTILS=no")
			line.gsub!(/USE_TTY_GROUP=yes/,"USE_TTY_GROUP=no")
			line.gsub!(/HAVE_KILL=no/,"HAVE_KILL=yes")
			line.gsub!(/HAVE_SLN=no/,"HAVE_SLN=yes")
			line.gsub!(/ETC_DIR=.*/,"ETC_DIR=#{etcdir}")
			line.gsub!(/SBIN_DIR=.*/,"SBIN_DIR=#{sbindir}")
			line.gsub!(/USRSBIN_DIR=.*/,"USRSBIN_DIR=#{sbindir}")
			line.gsub!(/^BIN_DIR=.*/,"BIN_DIR=#{bindir}")
			line.gsub!(/USRBIN_DIR=.*/,"USRBIN_DIR=#{bindir}")
			line.gsub!(/MAN_DIR=.*/,"MAN_DIR=#{mandir}")
			line.gsub!(/INFO_DIR=.*/,"INFO_DIR=#{infodir}")
			line.gsub!(/USRSHAREMISC_DIR=.*/,"USRSHAREMISC_DIR=#{datadir('misc')}")
			line.gsub!(/LOCALE_DIR=.*/,"LOCALE_DIR=#{datadir('locale')}")
		}
		bash "./configure"
		bash "make -j#{$make_jobs}"
		bash "make install"
		File.symlink("agetty",path(sbindir,"getty"))
		getdata(etcdir,'fstab',0644)
  end

end; Pkg_Util_linux.new()

#===============================================================================
class Pkg_Uucp < Package
#===============================================================================

  def initialize()
		super('UUCP tools','1.07')
		@versions={ '1.07'=>['uucp-1.07.tar.gz']}
		join('base')
  end

end; Pkg_Uucp.new()

#===============================================================================
class Pkg_Vim < Package
#===============================================================================

  def initialize()
		super('Improved VI editor','6.1.405')
		@versions={'6.1.405'=>['vim-6.1.405.tar.bz2']}
		wants('xfree86')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('vim*/src')[0].cd
		bash "./configure #{stdconfig}"
		bash "make -j#{$make_jobs} CONF_ARGS=\"#{stdconfig}\""
		bash "make install"
  end

end; Pkg_Vim.new()

#===============================================================================
class Pkg_Wget < Package
#===============================================================================

  def initialize()
		super('File download utility','1.8.2')
		@versions={'1.8.2'=>['wget-1.8.2.tar.gz']}
		override('busybox')
  end

end; Pkg_Wget.new()

#===============================================================================
class Pkg_Wireless_tools < Package
#===============================================================================

  def initialize()
		super('Wireless network tools','25')
		@versions={'25'=>['wireless_tools.25.tar.gz']}
		tools('coreutils')
		syncwith('linux')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "make -j#{$make_jobs} PREFIX=/ KERNEL_SRC=#{$linux.source} BUILD_SHARED=y"
		bash "make PREFIX=#{prefix} INSTALL_MAN=#{mandir} INSTALL_INC=#{incdir} install"
  end

end; Pkg_Wireless_tools.new()

#===============================================================================
class Pkg_Xemacs_code < Package
#===============================================================================

  def initialize()
		super('Editor - forked version of emacs','21.4.14')
		@versions={
			'21.4.13'=>['xemacs-21.4.13.tar.gz'],
			'21.4.14'=>['xemacs-21.4.14.tar.gz']
		}
		join('xemacs')
		needs('readline','ncurses')
		wants('xfree86')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		bash "./configure --prefix=#{prefix} --infodir=#{infodir} --mandir=#{mandir(1)} "+
			"--cflags=\"#{ENV['CFLAGS']}\" --with-gcc --with-ncurses"
		bash "make"
		bash "make install"
		'xemacs'.link(path(bindir,'e'))
  end

end; $xemacs_code = Pkg_Xemacs_code.new()

#===============================================================================
class Pkg_Xemacs_base < Package
#===============================================================================

  def initialize()
		super('Base packages for xemacs','1.81')
		@versions={
			'1.78'=>['xemacs-base-1.78-pkg.tar.gz'],
			'1.81'=>['xemacs-base-1.81-pkg.tar.gz']
		}
		join('xemacs')
		override('xemacs-code')
		syncwith('xemacs-code')
  end

  def build()
		File.makedirs(prefix($xemacs_code.libdir('xemacs/xemacs-packages')))
		bash "tar --directory #{prefix($xemacs_code.libdir('xemacs/xemacs-packages'))} "+
			"-xzf "+path($root,SRCDIR,@name,@versions[@select[0]][0])
  end

end; Pkg_Xemacs_base.new()

#===============================================================================
class Pkg_Xemacs_sumo < Package
#===============================================================================

  def initialize()
		super('All available xemacs packages','2003-08-31')
		@versions={
			'2003-06-29'=>['xemacs-sumo-2003-06-29.tar.bz2'],
			'2003-08-31'=>['xemacs-sumo-2003-08-31.tar.bz2']
		}
		needs('xemacs-code')
		override('xemacs-code','xemacs-base')
		syncwith('xemacs-code')
  end

  def build()
		File.makedirs(prefix($xemacs_code.libdir('xemacs')))
		bash "tar --directory #{prefix($xemacs_code.libdir('xemacs'))} "+
			"-xjf "+path($root,SRCDIR,@name,@versions[@select[0]][0])
  end

end; Pkg_Xemacs_sumo.new()

#===============================================================================
class Pkg_Xfree86 < Package
#===============================================================================

  def initialize()
		super('X windows','xf-4_3-branch')
		@versions={ 'xf-4_3-branch'=>['xfree86'] }
		tools('bison','flex')
		needs('libpng','fontconfig','freetype')
  end

  def build()
		ENV['LD_LIBRARY_PATH'] = $glibc.configdir('ld.so.conf').fread.join(':')
		checkout("xfree86","xc",@select[0])
		'xc'.cd
		'config/cf/host.def'.ftouch('#define CppCmd cpp',
																"#define DefaultGcc2i386Opt #{ENV['CFLAGS']}",
																"#define MakeCmd make",
																"#define ProjectRoot #{prefix}",
																"#define VarDirectory #{statedir}",
																"#define ManDirectoryRoot /man",
																"#define IncRoot /include",
																"#define HasZlib YES",
																"#define LinkGLToUsrInclude	NO",
																"#define LinkGLToUsrLib NO",
																"#define BuildFontServer NO",
																"#define HasFreetype2 YES",
																"#define BuildFreetype2Library NO",
																"#define HasFontconfig YES",
																"#define BuildFontconfigLibrary NO"
																)
		bash "make World"
		bash "make DESTDIR=#{prefix} install install.man"
		prefix('usr').mkdir
		prefix.link(prefix('usr/X11R6'))
		[bindir,libdir,statedir].each { |d| d.rrm; prefix(d).mv(d) }
		statedir('log').mkdir
		prefix('pkg').rrm
  end

end; Pkg_Xfree86.new()

#===============================================================================
class Pkg_Xine < Package
#===============================================================================

  def initialize()
		super('Multimedia player','1-beta12')
		@versions={'1-beta12'=>['xine-lib-1-beta12.tar.gz']}
		needs('ogg-vorbis')
  end

end; Pkg_Xine.new()

#===============================================================================
class Pkg_Xmms < Package
#===============================================================================

  def initialize()
		super('X multimedia system','1.2.7')
		@versions={'1.2.7'=>['xmms-1.2.7.tar.bz2']}
		needs('xfree86','libogg','libvorbis')
  end

end; #Pkg_Xmms.new()

#===============================================================================
class Pkg_Zlib < Package
#===============================================================================

  def initialize()
		super('The standard unix compression library','1.1.4')
		@versions={'1.1.4'=>['zlib-1.1.4.tar.bz2']}
		join('base')
		tools('gzip','sed')
		override('xfree86')
  end

  def build()
		unpack(@versions[@select[0]][0])
		Dir.glob('*')[0].cd
		File.makedirs(incdir,path(mandir,"man3"))
		bash "./configure --prefix=#{prefix}"
		bash "make -j#{$make_jobs}"
		bash "make install"
		ENV['LIBRARY_PATH']=libdir
		bash "./configure --prefix=#{prefix} --shared"
		bash "make -j#{$make_jobs}"
		bash "make install"
		File.cp("zlib.3",path(mandir,"man3"))
  end

end; $zlib = Pkg_Zlib.new()

############################################################################
#                                                                          #
#                           End Of Packages                                #
#                                                                          #
############################################################################

#-------------------------------------------------------------------------------
def makedev  #Make the device nodes
#-------------------------------------------------------------------------------
  User.asroot {
		path($root,'dev').cd
		%w{ shm pts input rd usb isdn cpu cpu/0 cpu/1 i2o net watchdogs dri }.each { |d| d.mkdir(0755) }

		data('devices') { |line|
			next unless line =~ /(\S+)\s+(\S+)\s+(\S+)\s+(\d+)\s+(\S)\s+(\d+)\s+(\d+)/
			raise 'makedev' unless $1.exists? or system("mknod --mode #{$4} #{$1} #{$5} #{$6} #{$7}")
			raise 'makedev' unless system("chown #{$users[$2]}:#{$groups[$3]} #{$1}")
		}
		
		{ '/proc/self/fd'=>'fd','fd/0'=>'stdin','fd/1'=>'stdout','fd/2'=>'stderr',
			'/proc/kcore'=>'core','ram0'=>'ramdisk', 'video0'=>'bttv0',
			'isdnctrl0'=>'isdn/isdnctrl','radio0'=>'radio'
		}.each { |s,d| File.symlink(s,d) unless d.exists? }
  }
end

#-------------------------------------------------------------------------------
def download(pkgs,task)  #Download requested packages
#-------------------------------------------------------------------------------

	if $nodownload
		puts "Download disabled at users request. Assuming sources exist..."
	else
		puts "Check and download required sources..."
		fa = Array.new
		Link.orderJobs(pkgs,task).each { |b|
			b.each { |pkg,task|
				pkg.versions[pkg.select[0]].each { |file|
					fa.push([pkg,file.class==Array ? file[0] : file])
				}
			}
		}

		failures = Array.new
		children = Hash.new
		fa.each { |pkg,file|
			dir = pkg.to_s
			ver = pkg.select[0]
			fn = path(dir,file)
			puts(dir+' '+('-'*(25-dir.size))+'> '+ver+' '+('-'*(20-ver.size))+'> '+file)
			if !$pretend
				path($root,SRCDIR,dir).mkdir
				if system("RSYNC_PASSWORD='#{$bkPassword}' rsync -az --delete --progress "+
			            "rsync://#{$BkUser}@ftp.rubyx.org/rubyx/#{fn} "+
				          "#{path($root,SRCDIR,dir)}/")
					if pkg.respond_to?(:extractTags)
						pid = fork { begin; pkg.extractTags(); rescue Interrupt; exit 1; end }
						children[pid] = pkg.to_s
					end
				elsif ($?>>8)==20
					Process.kill('SIGINT',0)
				else
					puts "*** #{fn} FAILED!"
					failures.push(fn)
				end
			end
		}
		puts "\n"
		puts "Waiting for tag extraction processes to complete:" unless children.empty?
		while !children.empty?
			puts "  "+children.values.join(' ')
			children.delete(Process.wait)
		end
		puts "Reloading version tags"
		fa.each { |pkg,file| pkg.readTags() if pkg.respond_to?(:readTags) }
		unless failures.empty?
			raise "\n*** THESE DOWNLOADS FAILED:\n\t"+failures.join("\n\t")
		end
	end
end

#-------------------------------------------------------------------------------
FORCE=true
def install(names,task,phase=nil)
#-------------------------------------------------------------------------------
  
  batches = Link.orderJobs(names,task)
  numBatches = batches.size
  
  if $pretend
		(1..numBatches).each { |b|
			puts((phase ? "Phase #{phase}, " : '')+"Batch #{b}/#{numBatches}") 
			batches[b-1].each { |pkg,task|
				puts '  '+(task==Link::TASK_UNDO ? '-' : '+')+pkg.to_s
			}
		}
  else
		docs=false
		begin	
			trap('INT','IGNORE')
			(1..numBatches).each { |b|
				puts("\n"+(phase ? "Phase #{phase}, " : '')+"Batch #{b}/#{numBatches}\n") 
				jobs = Hash.new
				ipkgs,fpkgs = Hash.new,Array.new
				batches[b-1].each { |pkg,task|
					if jobs.size==$build_jobs.to_i
						pid,code = Process.wait2
						fPkg,fTask = jobs.delete(pid)
						if (code>>8)==0 then ipkgs[fPkg]=fTask; else fpkgs.push(fPkg); end
						puts "*** FAILED: #{fPkg} (code=#{code>>8})" unless (code>>8)==0
						break if (code>>8)==20 #Don't start more jobs if Ctrl-C was trapped
					end
					pid = path($root,'var/log/build',pkg.to_s).logfork {
						trap('INT','DEFAULT')
						if task==Link::TASK_DO
							workdir="/tmp/#{pkg.to_s}.#{$$}.#{Time.now.to_i}"
							oldPkgDir=pkg.home()
							pkgdir=pkg.newhome()
							begin
								User.asroot { umask0 { path($root,pkgdir).mkdir } }
								workdir.mkdir.cd
								puts("Building #{pkg.to_s}: #{pkg.select.join(' , ')}")
								puts(SOLID+"Build Environment:\n"+DOTTED)
								User.aseuid { system("env") }
								set_trace_func proc { |event,file,line,id,binding,classname|
									puts(SOLID+THIS_FILE[line-1].strip,DOTTED) if event=='line' and classname==pkg.class }
								pkg.build
								set_trace_func nil
								User.asroot {
									path($root,pkg.infodir('dir')).rm
									path($root,pkgdir).chmod(0755)
									path($root,pkgdir).lsd { |fn|
										if !fn.symlink? and fn.stat(true).uid == $users['rubyx']
											mode = fn.stat(true).mode
											fn.chown(0,0).chmod(mode) #Chown clears setuid/setguid bits, so reinstate
										end
									}
									path($root,pkgdir,'version').fwrite(*pkg.select)
									if oldPkgDir and $keep
										%w{ etc config state }.each { |dir|
											oldDir=path($root,oldPkgDir,dir)
											newDir=path($root,pkgdir,dir)
											File.mv(newDir,newDir+'.new') if newDir.directory?
											File.mv(oldDir,newDir) if oldDir.directory?
										}
									end
								}
								puts SOLID+"Build successful"
							rescue Exception
								puts $!
								puts $!.backtrace.join("\n")
								User.asroot {
									File.rename(workdir,workdir+".FAILED")
									path($root,pkgdir).rrm
								}
								raise #Reraise exception
							ensure
								workdir.rrm
							end
						else #TASK_UNDO
							while pkg.home
								puts("Deleting "+pkg.home)
								User.asroot { path($root,pkg.home).rrm }
							end
						end
					}
					jobs[pid] = [pkg,task]
					ps=""; jobs.values.each { |p,t|
						ps<<(t==Link::TASK_DO ? '+' : '-')<<p.to_s<<" " }
					puts '  '+ps
				}
				
				while !jobs.empty?
					pid,code = Process.wait2
					pkg,task = jobs.delete(pid)
					if (code>>8)==0 then ipkgs[pkg]=task; else fpkgs.push(pkg); end
					puts "*** FAILED: "+pkg.to_s unless (code>>8)==0
					ps=""; jobs.values.each { |p,t|
						ps<<(t==Link::TASK_DO ? '+' : '-')<<p.to_s<<" " }
					puts '  '+ps unless jobs.empty?
				end

				if ipkgs.size>0
					#Get a package array sorted on ipri
					spa = Link.all.sort { |i,j| i[1].ipri<=>j[1].ipri }

					User.asroot {
						if $glibc.home
							puts "Update ld.so.cache..."
							libpath = []
							spa.each { |p| #p[0]=name, p[1]=object
								next unless (ph = p[1].home)
								libpath.push(path(ph,'lib')) if path($root,ph,'lib').directory?
								libpath.push(path(ph,'usr/lib')) if path($root,ph,'usr/lib').directory?
								p[1].libdirs.each { |ldt|
									Dir.glob(path($root,ph,ldt)).each { |ld| libpath.push(ld.slice(/\/pkg\/.*/)) }
								}
							}
							path($root,$glibc.configdir,'ld.so.conf').fwrite(*libpath)
							system("ldconfig -r #{$root} -f #{$glibc.configdir('ld.so.conf')} -C #{$glibc.configdir('ld.so.cache')}")
						end

						puts "Link files into standard locations..."
						hard = ($root!='/')
						fileList=Hash.new
						spa.each { |p| #p[0]=name, p[1]=object
							ph = p[1].home
							next unless ph
							ignore = path($root,ph).size
							StandardLocations.each { |dir|
								path($root,ph,dir).lsd { |fn|
									dn = path($root,fn[ignore..9999])
									if ipkgs[p[1]]
										if fn.directory?
											puts('  '+dn+'/') if $verbose
											dn.mkdir
										elsif fileList.include?(dn)
											fileList[dn].push(p[0])
											puts('  !! '+fileList[dn].join(', ')) if $verbose
										else
											puts('    '+dn+' => '+fn) if $verbose
											fn.link(dn,hard)
											fileList[dn]=[fn]
										end
									elsif !fn.directory?
										if fileList.include?(dn)
											fileList[dn].push(p[0])
										else
											fileList[dn]=[fn]
										end
									end
								}
							}
						}
						
						puts "Mark old versions for removal at next reboot..."
						spa.each { |p| #p[0]=name, p[1]=object
							Dir.glob(path($root,'pkg',p[0]+'.*')).each { |e|
								if e != path($root,p[1].home)
									puts("  Old: "+e) if $verbose
									path($root,'pkg/.old').fcat(e)
								end
							}
						}

						if $root=='/'
							puts "Installing info files..."
							'/info/dir'.rm
							Dir.glob('/info/*.info').each { |i| system("install-info --quiet #{i} /info/dir > /dev/null 2>&1") }
							puts "Making 'whatis' database..."
							system("makewhatis /man")
						end

						puts 'Collate environment variables...'
						evars={'PATH'=>['/bin','/sbin']}
						spa.each { |name,pkg|
							next unless pkg.home
							evars['PATH'].push(pkg.cmddir) if path($root,pkg.cmddir).directory?
							pkg.envdir.cd {
								Dir.glob('*').each { |ev| 
									parts = ev.fread()
									evars[ev] = [] unless evars[ev]
									evars[ev].concat(parts)
								}
							} if pkg.envdir.directory?
						}
						path($root,'etc/environment').rm
						evars.each { |label,parts|
							parts.uniq!
							path($root,'etc/environment').fcat("export #{label}="+parts.join(':'))
							ENV[label]=parts.join(':') if $root=='/'
						}

						puts('Post-installation jobs...')
						begin
						ipkgs.each { |pkg,task|
							next unless task==Link::TASK_DO and pkg.respond_to?(:post)
							pid = path($root,'var/log/build',pkg.to_s).logfork('a') {
								trap('INT','DEFAULT')
								begin
									puts(SOLID,"Post installation for #{pkg.to_s}: #{pkg.select.join(' , ')}",DOTTED)
									puts(SOLID,"Environment:",DOTTED)
									User.aseuid { system("env") }
									set_trace_func proc { |event,file,line,id,binding,classname|
										puts(SOLID,THIS_FILE[line-1].strip,DOTTED) if event=='line' and classname==pkg.class }
									pkg.home.cd { pkg.post }
									set_trace_func nil
									puts SOLID+"Post-install successful"
								rescue Exception
									puts $!,$!.backtrace.join("\n")
									raise #Reraise exception
								end
							}
							jobs[pid] = pkg
							puts '  '+jobs.values.join(' ')
						}
						rescue
							puts $!,$!.backtrace.join("\n")
							raise #Reraise exception
						end

						while !jobs.empty?
							pid,code = Process.wait2
							pkg = jobs.delete(pid)
							puts "*** WARNING - Post installation failed for "+pkg.to_s unless (code>>8)==0
							puts "  "+jobs.values.join(" ") unless jobs.empty?
						end

					}
				end

				raise "***THESE JOBS FAILED: "+fpkgs.join(" ") if fpkgs.length>0
			}
		ensure
			trap('INT','DEFAULT')
		end
  end
end

#-------------------------------------------------------------------------------
def chroot(dir)
#-------------------------------------------------------------------------------
  puts("Changing root to "+dir)
	User.asroot {
		raise "mount proc failed" unless system("mount -n -t proc proc "+path(dir,'proc'))

		begin
			trap('INT','IGNORE')
			pid = Process.fork {
				begin
					dir.cd #MUST cd before chroot - see Dir.chroot docs
					Dir.chroot(dir)
					#Reset the rubyx UID/GID which may be different here
					User.set($users['rubyx'],$groups['users'])
					$root = '/'
				  #ENV.delete_if { |key,val| key!='TERM' }
					'/etc/environment'.fread.each { |v| v =~ /export (.*)=(.*)/; ENV[$1]=$2 }
					ENV['HOME'] = '/home/root'
					yield
				rescue Exception
					puts $!
				end
			}
			Process.waitpid(pid)
		ensure
			system('umount -ln '+path(dir,'proc'))
			trap('INT','DEFAULT')
		end
	}
end

################################################################################
################################################################################
################################################################################
################################################################################
###                                                                          ###
###                          Start Of Execution                              ###
###                                                                          ###
################################################################################
################################################################################
################################################################################
################################################################################

class Host
	@@hosts=Hash.new
	def Host.cpus(); return @@hosts.keys; end
	def Host.find(cpu); return @@hosts[cpu]; end 
	def initialize(cpu,generic,full,march)
		@cpu,@generic,@full,@march=cpu,generic,full,march
		@@hosts[cpu]=self
	end
	attr_reader :cpu, :generic, :full, :march
end

# Supported platforms
Host.new('i386',        'i386',  'i386-pc-linux-gnu','i386')
Host.new('i486',        'i386',  'i486-pc-linux-gnu','i486')
Host.new('i586',        'i386',  'i586-pc-linux-gnu','i586')
Host.new('i686',        'i386',  'i686-pc-linux-gnu','i686')
Host.new('pentium',     'i386',  'i586-pc-linux-gnu','pentium')
Host.new('pentium-mmx', 'i386',  'i586-pc-linux-gnu','pentium-mmx')
Host.new('pentiumpro',  'i386',  'i586-pc-linux-gnu','pentiumpro')
Host.new('pentium2',    'i386',  'i586-pc-linux-gnu','pentium2')
Host.new('pentium3',    'i386',  'i686-pc-linux-gnu','pentium3')
Host.new('pentium4',    'i386',  'i686-pc-linux-gnu','pentium4')
Host.new('k6',          'i386',  'i586-pc-linux-gnu','k6')
Host.new('k6-2',        'i386',  'i586-pc-linux-gnu','k6-2')
Host.new('k6-3',        'i386',  'i586-pc-linux-gnu','k6-3')
Host.new('athlon',      'i386',  'i686-pc-linux-gnu','athlon')
Host.new('athlon-tbird','i386',  'i686-pc-linux-gnu','athlon-tbird')
Host.new('athlon4',     'i386',  'i686-pc-linux-gnu','athlon4')
Host.new('opteron',     'x86_64','x86_64-pc-linux-gnu',nil) #march ky isn't in gcc yet
Host.new('athlon64',    'x86_64','x86_64-pc-linux-gnu',nil)

begin  #We are going to catch exceptions at the end
	$bindsrc=false

  # Must be run as root
  if Process.uid() != 0 then puts "You must run rubyx as root"; exit 1; end

  Link.fixup # Connect-up all the giver/taker links
	Package.CalculateInstallPriorities
	  
  # Gives default file creation of 0755
  File.umask(0022)

	#Read users and groups for a rubyx system
	$users = Hash.new
	data('passwd') { |line|
		next unless line =~ /([^:]+):[^:]*:(\d+).*/
		$users[$1]=$2.to_i
	}
	
	$groups = Hash.new
	data('group') { |line|
		next unless line =~ /([^:]+):[^:]*:(\d+).*/
		$groups[$1]=$2.to_i
	}

  # Chop the commandline into command,[args] chunks
	tokens = ARGV.dup
	cmds = Hash.new
	while tokens.first
		tok = tokens.delete_at(0)
		raise "Invalid parameter: "+tok unless tok[0,2] == '--'
		tok = tok[2..99]
		if tok=='read'
			lines = cmds['read'].fread()
			raise "Invalid command file!" unless lines.size>0
			lines.each { |l| tokens = tokens + l.split }
		end
		cmds[tok]=Array.new
		while tokens.first and tokens.first[0,2] != '--'
			cmds[tok].push(tokens.delete_at(0))
		end
	end

	if cmds['help']
		puts "\nRubyx v#{RUBYX_VERSION}\n"+
			"    --help                             I guess you know about this\n"+
			"\nENVIRONMENT:\n"+
			"    --read      <file>                 Read options from a file\n"+
			"    --select    <pkg> <version> <...>  List or specify package version\n"+
			"    --kernel-config  <file>            Supply kernel .config file\n"+
			"    --cpu       <cpu>                  List or set target cpu\n"+
			"    --cflags    options                Specify default c flags\n"+
			"    --cxxflags  options                Specify default c++ flags\n"+
			"    --bj        jobs                   Set maximum parallel build jobs\n"+
			"    --mj        jobs                   Set maximum parallel make jobs\n"+
			"    --root      path                   Select root directory\n"+
			"\nQUERY:\n"+
			"    --config                           Show build settings\n"+
			"    --group     <pattern>              List matching groups\n"+
			"    --package   <pattern>              List matching packages\n"+
			"\nCOMMANDS:\n"+
			"    --download  grp|pkg ...            Download selected packages/groups\n"+
			"    --install   grp|pkg ...            Build and install packages\n"+
			"    --upgrade   grp|pkg ...            Upgrade packages\n"+
			"    --uninstall grp|pkg ...            Uninstall packages\n"+
			"    --makedev                          Recreate any missing device nodes\n"+
			"    --distro    <grp|pkg ...>          Build a complete distro\n"+
			"    --chroot    <command>              Chroot into distro, optional command\n"+
			"    --backup    dest directory         Backup configuration ans state files\n"+
			"    --clean                            Remove old package versions\n"+
			"\nMODIFIERS:\n"+
			"    --bindsrc          Use existing sources\n"+
			"    --nodownload       Assume sources exist\n"+
			"    --check            Do 'make check' or equivalents\n"+
			"    --distcc           Use distcc to speed things up\n"+
			"    --force            Force reinstall\n"+
			"    --pretend          To see what would happen...\n"+
			"    --pull             Update repositories\n"+
			"    --strip            Strip binaries\n"+
			"    --keep             Keep any original config and state\n"+
			"    --verbose          Display more information\n"+
			"\nUSEFUL STUFF:\n"+
			"    --select glibc     takes extra parameter nptl or linuxthreads\n"+
			"    --select gcc       takes required languages as extra parameters\n"+
			"    gcc languages:     ada f77 java objc (c and c++ are implied)\n"+
			"    thread libraries:  linuxthreads nptl\n"+
			"    Tag examples:      v2.4.21-rc7  date:yesterday  date:2003-01-24\n"+
			"\nImportant! The build machine must be capable of running the generated code,\n"+
			"For example;\n"+
			" You need a pentium4 build machine to use --cpu pentium4\n"+
			" You need an athlon64/opteron build machine to use --cpu opteron\n"+
			" (but its ok to build 64 bit distro from operton running 32bit os\n"+
			"  as long as kernel is 64bit)\n"
		exit 0
	end

	# This is a pain but necessary and makes automatic upgrades of bitkeeper possible
	raise "You must register to download Bitkeeper at\n"+
		"http://www.bitkeeper.com/Products.Downloads.html\n"+
		"Bitmover will send you an email with a username and password\n"+
		"from which you should create an authority file like this:\n"+
		"echo -e 'username\\npassword' > "+BK_AUTHORITY unless BK_AUTHORITY.exists?

	#Read bk username and password
	$BkUser, $bkPassword = BK_AUTHORITY.fread('BK_USERNAME','BK_PASSWORD')

  '/dev/null'.logfork { raise unless system("bk version") }
  raise "Sorry - You need to install Bitkeeper!" unless Process.wait2[1]==0

  '/dev/null'.logfork { raise unless system("cvs --version") }
  raise "Sorry - You need to install Cvs!" unless Process.wait2[1]==0

  '/dev/null'.logfork { raise unless system("rsync --version") }
  raise "Sorry - You need to install Rsync!" unless Process.wait2[1]==0

	# Get root directory
	if cmds['root']
		raise "Invalid --root parameter" if cmds['root'].length != 1
		$root = path(File.expand_path(cmds['root'][0]))
		raise "--root parameter is not a directory" unless $root.directory?
		cmds.delete('root')
	else
		#We should only work in $root=/ if this is a rubyx distro
		raise "Hmmm. --root might be sensible..." unless '/.cpu'.exists?
		$root = '/'
	end

  # Now we know $root, we can get these variables (or set defaults)
	$host=Host.find('.cpu'.fread('i386')[0])
	$default_cflags='.cflags'.fread('-O2').join(' ')
	$default_cxxflags='.cxxflags'.fread('-O2').join(' ')
	$build_jobs='.build_jobs'.fread('2')[0]
	$make_jobs='.make_jobs'.fread('2')[0]

	#Read tags and get installed software versions
	Link.each { |name,obj|
		obj.readTags() if obj.respond_to?(:readTags)
		h = obj.home
		obj.installed = path($root,h,'version').fread() if h
	}

  #Parse the commandline - Override above variables if specified
  
	$kconfig,$distcc,$check,$strip,$upgrade,$force,$pull,$pretend,$verbose,$keep,$nodownload = nil
  
  cmds.delete_if { |cmd,args|
		case cmd
		when 'select'
			raise "--select needs a package name" if args.length == 0
			pkg = Link.find(args[0])
			raise "No package named #{args[0]}" unless pkg
			if args.length==1
				puts "Available versions of "+args[0]+":\n  "+pkg.versions.keys.sort.join("\n  ")
			else
				raise "Version not supported" unless pkg.versions[args[1]]
				pkg.select = args[1..99]
			end
		when 'kernel-config'
			raise "--kernel-config takes 1 parameter" if args.length != 1
			raise "Can't access kernel config file "+args[0] unless args[0].exists?
			$kconfig = IO.readlines(args[0])
		when 'cpu'
			case args.length
			when 0 then puts "Supported cpus:\n  "+Host.cpus.sort.join("\n  ")
			when 1
				$host = Host.find(args[0])
				raise "Unkown cpu" unless $host
			else raise "--cpu only takes 1 parameter" if args.length > 1
			end
		when 'cflags'
			$default_cflags   = args.join(' ')
		when 'cxxflags'
			$default_cxxflags = args.join(' ')
		when 'bj'
			raise "--bj takes one parameter" unless args.length==1
			$build_jobs = args[0]
		when 'mj'
			raise "--mj takes one parameter" unless args.length==1
			$make_jobs = args[0]
		when 'bindsrc'
			raise "Invalid --bindsrc parameter" unless args.empty?
			raise "Can't bind source directory - must specify root directory" if $root=='/'
			puts "Binding local source directory"
			$bindsrc = system("mount -n -o bind /home/rubyx/src "+path($root,'/home/rubyx/src'))
			raise "Binding local source directory FAILED!" unless $bindsrc
		when 'nodownload'
			if args.empty?; $nodownload=true; else raise "Invalid --download parameter"; end
		when 'check'
			if args.empty?; $check=true; else; raise "Invalid --check parameter"; end
		when 'distcc'
			if args.empty?; $distcc=true; else; raise "Invalid --distcc parameter"; end
		when 'force'
			if args.empty?; $force=true; else; raise "Invalid --force parameter"; end
		when 'pretend'
			if args.empty?; $pretend=true; else; raise "Invalid --pretend parameter"; end
		when 'pull'
			if args.empty?; $pull=true; else; raise "Invalid --pull parameter"; end
		when 'strip'
			if args.empty?; $strip=true; else; raise "Invalid --strip parameter"; end
		when 'upgrade'
			cmds['install']=args
			$upgrade=true;
		when 'verbose'
			if args.empty?; $verbose=true; else raise "Invalid --verbose parameter"; end
		when 'keep'
			if args.empty?; $keep=true; else raise "Invalid --verbose parameter"; end
		when 'config', 'group', 'package', 'download', 'install', 'uninstall', 
				'makedev', 'distro','chroot', 'backup', 'clean'
			false
		else
			raise "Invalid parameter: --"+cmd
		end
  }

	#Set selected versions for any any packages not already selected
	Link.each { |name,obj|
		next if obj.select  #A version was manually selected on commandline
		if $upgrade or !obj.installed
			obj.select = obj.stable
		else
			obj.select = obj.installed
		end
	}

	#Cd to root because cwd may be inaccessible to rubyx (eg root's home dir)
  $root.cd

	# Make sure all the standard files and directories are in place
	data('rootfs') { |line|
		next unless line =~ /(\S+)\s+(\d+)\s+(\S+)\s+(\S+)/
		umask0 { $1.mkdir($2.oct).chown($users[$3],$groups[$4]) }
	}
	%w{bin lib include}.each { |d|
		File.symlink('/'+d,'usr/'+d) unless ('usr/'+d).exists?(false)
	}
	getdata('etc','passwd',0644) unless 'etc/passwd'.exists?
	getdata('etc','group',0644) unless 'etc/group'.exists?
	getdata('etc','shells',0644) unless 'etc/shells'.exists?
	
	# Write out the config files (unless they already exist)
	'.cpu'.ftouch($host.cpu)
	'.cflags'.ftouch($default_cflags)
	'.cxxflags'.ftouch($default_cxxflags)
	'.build_jobs'.ftouch($build_jobs)
	'.make_jobs'.ftouch($make_jobs)

  # Create and become unprivileged rubyx user
  class Object; include User; end #Mix-in User module
  User.create('rubyx')
  User.aseuid

  # Setup our environment variables
	ENV['BK_LICENSE'] = 'ACCEPTED' #Otherwise bk asks interactive questions
	ENV["CFLAGS"]   = $default_cflags   + ($host.march ? " -march=#{$host.march}" : '')
	ENV["CXXFLAGS"] = $default_cxxflags + ($host.march ? " -march=#{$host.march}" : '')
	# Setup this path incase we have selected a cross-compiling toolchain
	ENV['PATH']="/opt/bin:/opt/bin/#{$host.full}:"+ENV['PATH']
	ENV['C_INCLUDE_PATH']="/pkg/toolchain.3/opt/x86_64-pc-linux-gnu/include"
	# Do a distcc masquerade if selected
	ENV['PATH']="/opt/distcc:"+ENV['PATH'] if $distcc

  # Parse the commandline - Execute our instructions
  begin
		startTime=Time.now  # Time it out of interest
		
		cmds.each { |cmd,args|

			case cmd

			when 'config' #------------------------------------------------------------------
				puts "\nBuild settings:"
				%w{ host.cpu host.generic host.full host.march default_cflags default_cxxflags build_jobs make_jobs }.each { |v|
					eval " puts '#{v}'.ljust(30)+' = '+$#{v}" }
				puts "\nInstalled packages:"
				pkgs=[]
				Link.each { |name,obj|
					if obj.installed
						line = name.ljust(25)+obj.installed.join(', ').ljust(25)
						line <<'('<<obj.stable.join(', ')<<')' if obj.installed != obj.stable
						pkgs.push(line)
					end
				}
				puts pkgs.sort.join("\n")

			when 'group' #----------------------------------------------------------------
				raise "Invalid --group parameter" if args.length > 1
				pattern = (args.length==1 ? args[0] : nil)
				puts "Matching groups: "+Link.findGrps(pattern).join(',')

			when 'package' #--------------------------------------------------------------
				raise "Invalid --package parameter" if args.length > 1
				pattern = (args.length==1 ? args[0] : nil)
				puts "Matching packages: "+Link.findPkgs(pattern).sort.join(',')

			when 'download' #-------------------------------------------------------------
				raise "Invalid --download parameter" if args.length < 1
				download(args,Link::TASK_DO_FORCED)

			when 'install' #--------------------------------------------------------------
				task = ($force ? Link::TASK_DO_FORCED : Link::TASK_DO)
				download(args,task)
				case $root
				when '/' then install(args,task)
				else
					User.asroot { File.syscopy('/etc/resolv.conf',path($root,$glibc.etcdir,'resolv.conf')) } if $distcc
					chroot($root) { User.aseuid { install(args,task) } }
				end

			when 'uninstall' #------------------------------------------------------------
				case $root
				when '/' then install(args,Link::TASK_UNDO)
				else chroot($root) { User.aseuid { install(args,Link::TASK_UNDO) } }
				end

			when 'makedev' #---------------------------------------------------------------
				makedev

			when 'distro' #---------------------------------------------------------------
				raise "You must specify a directory with --root" if $root=='/'
				raise "Sorry - you can't do a pretend distro" if $pretend
				raise "You must specify a kernel configuration file with --kernel-config" unless $kconfig
				makedev
				download(%w{base}+args,Link::TASK_DO_FORCED)
				install(%w{kernel-headers binutils gcc glibc make busybox},Link::TASK_DO,'1/3')
				chroot($root) {
					User.aseuid {
						install(%w{base},Link::TASK_DO,'2/3')
						install(args,$force ? Link::TASK_DO_FORCED : Link::TASK_DO,'3/3')
					}
				}
				
			when 'backup' #---------------------------------------------------------------
				raise "Invalid --backup parameter" if args.length != 1
				User.asroot {
					bakDir = File.expand_path(args[0])
					File.makedirs(bakDir)
					Link.each { |name,obj|
						if obj.home
							if obj.configdir.directory?
								File.makedirs(path(bakDir,name,config))
								path($root,obj.configdir).rcp(path(bakDir,name,config))
							end
							if obj.statedir.directory?
								File.makedirs(path(bakDir,name,state))
								path($root,obj.statedir).rcp(path(bakDir,name,state))
							end
						end
					}
				}

			when 'clean' #----------------------------------------------------------------
				if $root=='/' and '/pkg/.old'.exists?
					User.asroot {
						puts "Removing old packages..."
						'/pkg/.old'.fread().each { |dir|
							if dir.exists?; puts('  - '+dir); dir.rrm; end
						}
						'/pkg/.old'.rm
						puts "Removing broken links..."
						StandardLocations.each { |dir|
							dir.lsd { |s| 
								unless s.exists?(true)
									puts('  - '+s) if $verbose
									s.rm
								end
							}
						}
					}
				end

			when 'chroot' #---------------------------------------------------------------
				raise "Invalid --chroot command" if args.length != 0
				chroot($root) { Process.waitpid(Process.fork { exec "sh --login" }) }
				
			end
		}		
		elapsedTime = (Time.now - startTime).to_i
		hours = elapsedTime/3600
		elapsedTime = elapsedTime%3600
		minutes = elapsedTime/60
		seconds = elapsedTime%60
		puts "Elapsed time: #{hours}h #{minutes}m #{seconds}s"
		exit 0
  end

rescue RuntimeError
  puts "Error: "+$!
	#puts $!.backtrace.join("\n")
  exit 1
rescue Interrupt
  puts "Interrupted!"
	#puts $!.backtrace.join("\n")
  exit 1
rescue #This is for debugging
  puts; raise  
  exit 1
ensure
	User.asroot { system("umount -ln #{path($root,'/home/rubyx/src')}") } if $bindsrc
end

__END__

################################################################################
################################################################################
################################################################################
################################################################################
###                                                                          ###
###                               The Data                                   ###
###                                                                          ###
################################################################################
################################################################################
################################################################################
################################################################################

=begin rootfs ------------------------------------------------------------------
bin                 0755    root  root
bin/libexec         0755    root  root
dev                 0755    root  root
etc                 0755    root  root
etc/default         0755    root  root
etc/skel            0755    root  root
etc/skel/Mail       0755    root  root
fonts               0755    root  root
home                0755    root  root
home/bk             0700    bk    bk
home/public         1777    root  root
home/root           0700    root  root
home/rubyx          0755    rubyx users
home/rubyx/src      0777    rubyx users
kernel              0755    root  root
lib                 0755    root  root
mnt                 0755    root  root
opt                 0755    root  root
opt/bin             0755    root  root
pkg                 0755    root  root
proc                0755    root  root
sbin                0755    root  root
tmp                 1777    root  root
usr                 0755    root  root
var                 0755    root  root
var/empty           0755    root  root
var/init            0755    root  root
var/init/cmd        0755    root  root
var/init/log        0755    root  root
var/lock            0755    root  root
var/log             0755    root  root
var/log/build       0755    root  root
var/log/download    0755    root  root
var/mail            0755    root  root
var/run             0755    root  root
var/tmp             1777    root  root
=end ---------------------------------------------------------------------------

=begin devices -----------------------------------------------------------------
# Memory devices
mem          root kmem 0640 c   1   1  Physical memory access
kmem         root kmem 0640 c   1   2  Kernel virtual memory access
null         root root 0666 c   1   3  Null device
port         root kmem 0640 c   1   4  I/O port access
zero         root root 0666 c   1   5  Null byte source
#  core                                6  Obsolete and replaced by /proc/kcore
full         root root 0666 c   1   7  Returns ENOSPC on write
random       root root 0444 c   1   8  Nondeterministic random number gen.
urandom      root root 0444 c   1   9  Faster, less secure random number gen.
aio          root root 0666 c   1  10  Asyncronous I/O notification interface

# RAM disk
ram0         root disk 0660 b   1   0  1st ramdisk
ram1         root disk 0660 b   1   1  2nd ramdisk
ram2         root disk 0660 b   1   2  3rd ramdisk
ram3         root disk 0660 b   1   3  4th ramdisk
# ...
initrd       root disk 0660 b   1 250  Initial RAM disk in 2.6

# 2 char = Pseudo-TTY masters - We are using Unix98 pty's instead

# Floppy disks
fd0          root disk 0660 b   2   0  1st Floppy disk
fd1          root disk 0660 b   2   1  2nd floppy disk
# ...

# 3 char = Pseudo-TTY slaves
# We are using Unix98 pty's instead

# Primary IDE interface
hda          root disk 0660 b   3   0  Master, Whole disk
hda1         root disk 0660 b   3   1  Master, Partition 1
hda2         root disk 0660 b   3   2  Master, Partition 2
hda3         root disk 0660 b   3   3  Master, Partition 3
hda4         root disk 0660 b   3   4  Master, Partition 4
hda5         root disk 0660 b   3   5  Master, Partition 5
hda6         root disk 0660 b   3   6  Master, Partition 6
hda7         root disk 0660 b   3   7  Master, Partition 7
# ...
hdb          root disk 0660 b   3  64  Slave, Whole disk
hdb1         root disk 0660 b   3  65  Slave, Partition 1
hdb2         root disk 0660 b   3  66  Slave, Partition 2
hdb3         root disk 0660 b   3  67  Slave, Partition 3
hdb4         root disk 0660 b   3  68  Slave, Partition 4
hdb5         root disk 0660 b   3  69  Slave, Partition 5
hdb6         root disk 0660 b   3  70  Slave, Partition 6
hdb7         root disk 0660 b   3  71  Slave, Partition 7
# ...

# TTY devices
tty0         root tty  0666 c   4   0  Current virtual console
tty1         root tty  0666 c   4   1  First virtual console
tty2         root tty  0666 c   4   2   
tty3         root tty  0666 c   4   3
tty4         root tty  0666 c   4   4
tty5         root tty  0666 c   4   5
tty6         root tty  0666 c   4   6
tty7         root tty  0666 c   4   7
tty8         root tty  0666 c   4   8
tty9         root tty  0666 c   4   9
tty10        root tty  0666 c   4   10
tty11        root tty  0666 c   4   11
tty12        root tty  0666 c   4   12
tty13        root tty  0666 c   4   13
# ...
ttyS0        root tty  0666 c   4  64  1st UART serial port
ttyS1        root tty  0666 c   4  65  2nd UART serial port
# ...

# Alternate TTY devices
tty          root tty  0666 c   5   0  Current TTY device
console      root root 0666 c   5   1  System console
ptmx         root tty  0666 c   5   2  PTY master multiplex
cua0         root root 0666 c   5  64  Callout device for ttyS0
cua1         root root 0666 c   5  65  Callout device for ttyS1
# ...

# Parallel printer devices
lp0          root lp   0666 c   6   0  Parallel printer port 0
lp1          root lp   0666 c   6   1  Parallel printer port 1
# ...

# Virtual console capture devices
vcs          root tty  0666 c   7   0  Current vc text contents
vcs1         root tty  0666 c   7   1  tty1 text contents
vcs2         root tty  0666 c   7   2  tty2 text contents
vcs3         root tty  0666 c   7   3  tty3 text contents
vcs4         root tty  0666 c   7   4  tty4 text contents
vcs5         root tty  0666 c   7   5  tty5 text contents
vcs6         root tty  0666 c   7   6  tty6 text contents
vcs7         root tty  0666 c   7   7  tty7 text contents
vcs8         root tty  0666 c   7   8  tty8 text contents
vcs9         root tty  0666 c   7   9  tty9 text contents
vcs10        root tty  0666 c   7   10 tty10 text contents
vcs11        root tty  0666 c   7   11 tty11 text contents
vcs12        root tty  0666 c   7   12 tty12 text contents

# Loopback devices
loop0        root root 0666 b   7   0
loop1        root root 0666 b   7   1
loop2        root root 0666 b   7   2
loop3        root root 0666 b   7   3

# SCSI disks
sda          root disk 0660 b   8   0  Disk 1 Whole disk
sda1         root disk 0660 b   8   1  Disk 1 Partition 1
sda2         root disk 0660 b   8   2  Disk 1 Partition 2
sda3         root disk 0660 b   8   3  Disk 1 Partition 3
sda4         root disk 0660 b   8   4  Disk 1 Partition 4
sda5         root disk 0660 b   8   5  Disk 1 Partition 5
sda6         root disk 0660 b   8   6  Disk 1 Partition 6
sda7         root disk 0660 b   8   7  Disk 1 Partition 7
# ...
sdb          root disk 0660 b   8  16  Disk 2 Whole disk
sdb1         root disk 0660 b   8  17  Disk 1 Partition 1
sdb2         root disk 0660 b   8  18  Disk 1 Partition 2
sdb3         root disk 0660 b   8  19  Disk 1 Partition 3
sdb4         root disk 0660 b   8  20  Disk 1 Partition 4
sdb5         root disk 0660 b   8  21  Disk 1 Partition 5
sdb6         root disk 0660 b   8  22  Disk 1 Partition 6
sdb7         root disk 0660 b   8  23  Disk 1 Partition 7
# ...

# Miscellaneous stuff
psaux        root root 0666 c  10   1 PS/2-style mouse port
smouse       root root 0666 c  10   8 Simple serial mouse driver
beep         root root 0666 c  10 128 Fancy beep device
modreq       root root 0666 c  10 129 Kernel module load request {2.6}
watchdog     root root 0666 c  10 130 Watchdog timer port
temperature  root root 0666 c  10 131 Machine internal temperature
hwtrap       root root 0666 c  10 132 Hardware fault trap
exttrp       root root 0666 c  10 133 External device trap
apm_bios     root root 0666 c  10 134 Advanced Power Management BIOS
rtc          root root 0666 c  10 135 Real Time Clock
msr          root root 0666 c  10 142 x86 model-specific registers {2.6}
pciconf      root root 0666 c  10 143 PCI configuration space
nvram        root root 0666 c  10 144 Non-volatile configuration RAM
hfmodem      root root 0666 c  10 145 Soundcard shortwave modem control {2.6}
graphics     root root 0666 c  10 146 Linux/SGI graphics device
opengl       root root 0666 c  10 147 Linux/SGI OpenGL pipe
gfx          root root 0666 c  10 148 Linux/SGI graphics effects device
led          root root 0666 c  10 151 Front panel LEDs
mergemem     root root 0666 c  10 153 Memory merge device
nwbutton     root root 0666 c  10 158 Netwinder external button
nwdebug      root root 0666 c  10 159 Netwinder debug interface
nwflash      root root 0666 c  10 160 Netwinder flash memory
userdma      root root 0666 c  10 161 User-space DMA access
smbus        root root 0666 c  10 162 System Management Bus
lik          root root 0666 c  10 163 Logitech Internet Keyboard
ipmo         root root 0666 c  10 164 Intel Intelligent Platform Management
i2o/ctl      root root 0666 c  10 166 I2O configuration manager
agpgart      root root 0666 c  10 175 AGP Graphics Address Remapping Table
perfctr      root root 0666 c  10 182 Performance-monitoring counters
intel_rng    root root 0666 c  10 183 Intel i8x0 random number generator
cpu/microcode root root 0666 c 10 184 CPU microcode update interface
net/tun      root root 0666 c  10 200 TAP/TUN network device
watchdogs/0  root root 0666 c  10 212 First watchdog device
watchdogs/1  root root 0666 c  10 213 Second watchdog device
watchdogs/2  root root 0666 c  10 214 Third watchdog device
watchdogs/3  root root 0666 c  10 215 Fourth watchdog device

# ...

#SCSI cdroms
scd0         root disk 0660 b  11   0  1st SCSI cdrom
scd1         root disk 0660 b  11   1  2nd SCSI cdrom
# ...

#Input core
input/js0    root root 0666 c  13   0  First joystick
# ...
input/mouse0 root root 0666 c  13  32  First mouse
# ...
input/mice   root root 0666 c  13  63  Unified mouse
input/event0 root root 0666 c  13  64  First event queue
input/event1 root root 0666 c  13  65  First event queue
# ...

# Open Sound System (OSS)
mixer        root root 0666 c  14   0	 Mixer control
sequencer    root root 0666 c  14		1  Audio sequencer
midi00       root root 0666 c  14		2  First MIDI port
dsp          root root 0666 c  14		3  Digital audio
audio        root root 0666 c  14		4  Sun-compatible digital audio
sndstat      root root 0666 c  14		6  Sound card status information {2.6}
audioctl     root root 0666 c  14		7  SPARC audio control device
sequencer2   root root 0666 c  14   8  Sequencer -- alternate device
mixer1       root root 0666 c  14	 16  Second soundcard mixer control
patmgr0      root root 0666 c  14	 17  Sequencer patch manager
midi01       root root 0666 c  14	 18  Second MIDI port
dsp1         root root 0666 c  14	 19  Second soundcard digital audio
audio1       root root 0666 c  14	 20  Second soundcard Sun digital audio
patmgr1      root root 0666 c  14	 33  Sequencer patch manager
midi02       root root 0666 c  14	 34  Third MIDI port
midi03       root root 0666 c  14	 50  Fourth MIDI port

# BIOS harddrive callback support {2.6}
dos_hda root root 0666 b 14		  0 First BIOS harddrive whole disk
dos_hdb root root 0666 b 14		 64 Second BIOS harddrive whole disk
dos_hdc root root 0666 b 14		128 Third BIOS harddrive whole disk
dos_hdd root root 0666 b 14		192 Fourth BIOS harddrive whole disk


#Joysticks (not input core)
js0          root root 0666 c  15   0  First anolog joystick
# ...
djs0         root root 0666 c  15 128  First digital joystick
# ...
	
#Secondary IDE interface
hdc          root disk 0660 b  22   0  Master, Whole disk
hdc1         root disk 0660 b  22   1  Master, Partition 1
hdc2         root disk 0660 b  22   2  Master, Partition 2
hdc3         root disk 0660 b  22   3  Master, Partition 3
hdc4         root disk 0660 b  22   4  Master, Partition 4
hdc5         root disk 0660 b  22   5  Master, Partition 5
# ...
hdd          root disk 0660 b  22  64  Slave, Whole disk
hdd1         root disk 0660 b  22  65  Slave, Partition 1
hdd2         root disk 0660 b  22  66  Slave, Partition 2
hdd3         root disk 0660 b  22  67  Slave, Partition 3
hdd4         root disk    0660 b  22  68  Slave, Partition 4
hdd5         root disk    0660 b  22  69  Slave, Partition 5
# ...

# Universal Frame buffers
fb0          root root    0666 c  29   0  First frame buffer
# ...

# ISDN
isdn/isdn0        root dialout 0660 c  45   0  1st virtual B channel
isdn/isdn1        root dialout 0660 c  45   1  2nd virtual B channel
# ...
isdn/isdnctrl0    root dialout 0660 c  45  64  1st channel control/debug
isdn/isdnctrl1    root dialout 0660 c  45  65  2nd channel control/debug
# ...
isdn/ippp0        root dialout 0660 c  45 128  1st SyncPPP device
isdn/ippp1        root dialout 0660 c  45 129  2nd SyncPPP device
# ...
isdn/isdninfo     root dialout 0660 c  45 255  ISDN monitor interface

# 1st Mylex DAC960 PCI RAID controller
rd/c0d0      root disk    0660 b  48   0  1st disk Whole disk
rd/c0d0p1    root disk    0660 b  48   1  1st disk Partition 1
rd/c0d0p2    root disk    0660 b  48   2  1st disk Partition 2
rd/c0d0p3    root disk    0660 b  48   3  1st disk Partition 3
rd/c0d0p4    root disk    0660 b  48   4  1st disk Partition 4
rd/c0d0p5    root disk    0660 b  48   5  1st disk Partition 5
rd/c0d0p6    root disk    0660 b  48   6  1st disk Partition 6
rd/c0d0p7    root disk    0660 b  48   7  1st disk Partition 7
# ...
rd/c0d1      root disk    0660 b  48   8  2nd disk Whole disk
rd/c0d1p1    root disk    0660 b  48   9  2nd disk Partition 1
rd/c0d1p2    root disk    0660 b  48  10  2nd disk Partition 2
rd/c0d1p3    root disk    0660 b  48  11  2nd disk Partition 3
rd/c0d1p4    root disk    0660 b  48  12  2nd disk Partition 4
rd/c0d1p5    root disk    0660 b  48  13  2nd disk Partition 5
rd/c0d1p6    root disk    0660 b  48  14  2nd disk Partition 6
rd/c0d1p7    root disk    0660 b  48  15  2nd disk Partition 7
# ...

ppp          root dialout 0660 c 108   0

# Encapsulated PPP
pppox0       root dialout 0660 c 144   0  First PPP over Ethernet
# ...

# USB devices
usb/lp0      root root    0666 c 180   0  1st USB printer
# ...
usb/mouse0   root root    0666 c 180  16  1st USB mouse
#...
usb/ez0      root root    0666 c 180  32  1st USB firmware loader
# ...
usb/scanner0 root root    0666 c 180  48  1st USB scanner
# ...

# Nvidia graphics cards
nvidia0      root root    0666 c 195   0  1st Nvidia card
nvidia1      root root    0666 c 195   1  2nd Nvidia card
nvidiactl    root root    0666 c 195 255  Nvidia card control device

# CPU model-specific registers
cpu/0/msr    root root    0660 c 202   0  Cpu 0 MSRs
cpu/1/msr    root root    0660 c 202   1  Cpu 1 MSRs
# ...

# CPU CPUID information
cpu/0/cpuid  root root    0660 c 203   0  Cpu 0 CPUID
cpu/1/cpuid  root root    0660 c 203   1  Cpu 1 CPUID
# ...

# Direct Rendering Infrastructure (DRI)
dri/card0 root root 0666 c 226 0		First graphics card
dri/card1 root root 0666 c 226 1		Second graphics card
# ...

# FIFO used by init
initctl      root root    0600 p
=end ---------------------------------------------------------------------------

=begin profile -----------------------------------------------------------------
source /etc/environment
export HOSTNAME=$(uname -n)
export CVS_RSH='ssh'
export PAGER='/bin/less -irs'
export EDITOR='/bin/e'
export MAIL="$HOME/Mail/Maildir"

umask 022

if [ "$SHELL" = '/bin/bash' ] || [ "$SHELL" = '/bin/sh' ]; then
	if ((EUID == 0)); then
		export PS1='\[\033[01;31m\]\u@\h \[\033[01;34m\]\W \$ \[\033[00m\]'
	else
		export PS1='\[\033[01;32m\]\u@\h \[\033[01;34m\]\W \$ \[\033[00m\]'
	fi
 eval `dircolors -b`
 alias l="ls --color"
 alias ll="ls --color -lh"
fi

if [ -z "$INPUTRC" -a ! -f "$HOME/.inputrc" ]; then
	export INPUTRC="/etc/inputrc"
fi
=end ---------------------------------------------------------------------------

=begin passwd ------------------------------------------------------------------
root::0:0::/home/root:/bin/bash
sshd:x:20:6::
exim:x:21:6::
named:x:22:6::
distcc:x:23:6::
ups:x:24:6::
uucp:x:30:30::
fax:x:30:30::

tinydns:x:80:19:::
axfrdns:x:81:19:::
dnscache:x:82:19:::

bk:x:83:83:bitkeeper user:/home/bk:/bin/bkd

alias:x:90:21::/pkg/qmail/alias:/bin/true
qmaild:x:91:21::/pkg/qmail:/bin/true
qmaill:x:92:21::/pkg/qmail:/bin/true
qmailp:x:93:21::/pkg/qmail:/bin/true
qmailq:x:94:20::/pkg/qmail:/bin/true
qmailr:x:95:20::/pkg/qmail:/bin/true
qmails:x:96:20::/pkg/qmail:/bin/true

clamav:x:97:97:::/bin/false
qscand:x:98:98:::/bin/false

ftp:x:100:100:anonymous ftp client:/home/ftp:/bin/true

rubyx:x:1000:100:rubyx:/home/rubyx:/bin/bash

nobody:x:65534:65534:nobody:/:/bin/true
=end ---------------------------------------------------------------------------

=begin group -------------------------------------------------------------------
root:x:0:
bin:x:1:
sys:x:2:
kmem:x:3:
tty:x:4:
tape:x:5:
daemon:x:6:
floppy:x:7:
disk:x:8:
lp:x:9:
dialout:x:10:root
audio:x:11:
wheel:x:12:

djbdns:x:19:
qmail:x:20:
nofiles:x:21:

uucp:x:30:

bk:x:83:

clamav:x:97:
qscand:x:98:

users:x:100:

nobody:x:65534:
=end ---------------------------------------------------------------------------

=begin shells ------------------------------------------------------------------
/bin/sh
/bin/bash
/bin/bkd
/bin/true
=end ---------------------------------------------------------------------------

=begin fstab -------------------------------------------------------------------
#<fs>               <mountpoint>    <type>   <opts>                                            <dump/pass>

# Typical setup
# /dev/hda1          /               ext3     noatime                                              0 1
# /dev/hda2          /mnt/root2      ext3     noauto,noatime                                       1 2
# /dev/hda3          none            swap     sw                                                   0 0
# /dev/hda4          /home           ext3     noatime                                              1 2
# /dev/cdroms/cdrom0 /mnt/cdrom      iso9660  noauto,ro                                            0 0
# nfs-host:/public   /mnt/public     nfs      rw,soft,intr,noauto,noatime,rsize=32768,wsize=32768  0 0
=end ---------------------------------------------------------------------------

=begin inputrc -----------------------------------------------------------------
#
# Eight bit compatible: Umlaute
#
set meta-flag on
set output-meta on
set convert-meta off
#
# VI line editing
#
$if mode=vi
set editing-mode vi
set keymap vi
$endif
#
# Common standard keypad and cursor
#
"\e[1~":	beginning-of-line
"\e[2~":	yank
"\e[3~":	delete-char
"\e[4~":	end-of-line
#"\e[5~":	previous-history
#"\e[6~":	next-history
"\e[5~":	history-search-backward
"\e[6~":	history-search-forward
"\e[C":		forward-char
"\e[D":		backward-char
"\e[A":		previous-history
"\e[B":		next-history
$if term=xterm
"\e[E":		re-read-init-file
$else
"\e[G":		re-read-init-file
$endif
#
# Avoid network problems
#   ... \177 (ASCII-DEL) and \010 (ASCII-BS)
#	   do `backward-delete-char'
# Note: `delete-char' is maped to \033[3~
#	   Therefore xterm's responce on pressing
#	   key Delete or KP-Delete should be
#	   \033[3~ ... NOT \177
#
"\C-?":		backward-delete-char
"\C-H":		backward-delete-char
#
# Home and End
#
$if term=xterm
#
# Normal keypad and cursor of xterm
#
"\e[1~":	history-search-backward
"\e[4~":	set-mark
"\e[H":		beginning-of-line
"\e[F":		end-of-line
# Home and End of application keypad and cursor of xterm
"\eOH":		beginning-of-line
"\eOF":		end-of-line
$else
#
# TERM=linux or console
#
"\e[1~":	beginning-of-line
"\e[4~":	end-of-line
$endif
#
# Fix Home and End for German users
#
$if term=xterm
"\e[7~":	beginning-of-line
"\e[8~":	end-of-line
$endif
#
# Application keypad and cursor of xterm
#
$if term=xterm
"\eOD":		backward-char
"\eOC":		forward-char
"\eOA":		previous-history
"\eOB":		next-history
"\eOE":		re-read-init-file
# DEC keyboard KP_F1 - KP_F4
"\eOP":		prefix-meta
"\eOQ":		undo
"\eOR":		""  
"\eOS":		kill-line
$endif
#
# Function keys F1 - F12
#
$if term=linux
#
# On console the first five function keys
#
"\e[[A":	""
"\e[[B":	""
"\e[[C":	""
"\e[[D":	""
"\e[[E":	""
$else
#
# The first five standard function keys
#
"\e[11~":	""
"\e[12~":	""
"\e[13~":	""
"\e[14~":	""
"\e[15~":	""
$endif
"\e[17~":	""
"\e[18~":	""
"\e[19~":	""
"\e[20~":	""
"\e[21~":	""
# Note: F11, F12 are identical with Shift_F1 and Shift_F2
"\e[23~":	""
"\e[24~":	""
#
# Shift Function keys F1  - F12
#	  identical with F11 - F22
#
#"\e[23~":	""
#"\e[24~":	""
"\e[25~":	""
"\e[26~":	""
# DEC keyboard: F15=\e[28~ is Help
"\e[28~":	""
# DEC keyboard: F16=\e[29~ is Menu
"\e[29~":	""
"\e[31~":	""
"\e[32~":	""
"\e[33~":	""
"\e[34~":	""
$if term=xterm
# Not common
"\e[35~":	""
"\e[36~":	""
$endif
#
$if term=xterm
#
# Application keypad and cursor of xterm
# with NumLock ON
#
# Operators
"\eOo":		"/"
"\eOj":		"*"
"\eOm":		"-"
"\eOk":		"+"
"\eOl":		"+"
"\eOM":		accept-line
# Colon and dot
# "\eOl":		","
"\eOn":		"."
# Numbers
"\eOp":		"0"
"\eOq":		"1"
"\eOr":		"2"
"\eOs":		"3"
"\eOt":		"4"
"\eOu":		"5"
"\eOv":		"6"
"\eOw":		"7"
"\eOx":		"8"
"\eOy":		"9"
$endif
#
#  EMACS line editing
#
$if mode=emacs
#
# ... xterm application cursor
#
$if term=xterm
"\e\eOD":	backward-word
"\e\eOC":	forward-word
"\e\eOA":	up-history
"\e\eOB":	down-history
"\C-\eOD":	backward-char
"\C-\eOC":	forward-char
"\C-\eOA":	up-history
"\C-\eOB":	down-history
$endif
#
# Standard cursor
#
"\e\e[D":	backward-word
"\e\e[C":	forward-word
"\e\e[A":	up-history
"\e\e[B":	down-history
"\C-\e[D":	backward-char
"\C-\e[C":	forward-char
"\C-\e[A":	up-history
"\C-\e[B":	down-history
$endif
#
=end ---------------------------------------------------------------------------

=begin distgcc -----------------------------------------------------------------
#!/bin/ruby
exec "distcc","gcc",*ARGV
=end ---------------------------------------------------------------------------

=begin distg++ -----------------------------------------------------------------
#!/bin/ruby
exec "distcc","g++",*ARGV
=end ---------------------------------------------------------------------------

=begin distmake ----------------------------------------------------------------
#!/bin/ruby
exec "make","CC=distgcc","CXX=distg++",*ARGV
=end ---------------------------------------------------------------------------

=begin dhcpd.conf --------------------------------------------------------------
# Notes:
#	Names like patiot.home are converted to IP's by DHCP server before being sent
#	to the client, as it doesn't have dns if it's booting. Use names for readability.

# Disable Dynamic DNS updating
ddns-update-style none;

# The name of the server the client is booting from (since it doesn't have dns yet)
server-name r2d2;


# If this DHCP server is the official DHCP server for the local
# network, the authoritative directive should be uncommented.
# Otherwise, we'll ignore clients we know nothing about
not authoritative;

# Use this to send dhcp log messages to a different log file (you also
# have to hack syslog.conf to complete the redirection).
#log-facility local7;

# Tell DHCP about our subnet(s). Optionally serve IPs with range statement

subnet 10.0.0.0 netmask 255.255.0.0 {
	option domain-name "office";
	option domain-name-servers r2d2.office;
	option subnet-mask 255.255.0.0;
	option broadcast-address 10.0.255.255;
	option routers r2d2.office;
	range 10.0.100.1 10.0.100.254;
}
=end ---------------------------------------------------------------------------

=begin sambafax ----------------------------------------------------------------
#!/bin/sh
# constants
SENDMAIL="/bin/sendmail"
PS2ASCII="/bin/ps2ascii"
AWK="/bin/awk"
SENDFAX="/bin/sendfax"
 
# make up a temporary file
FAXFILE=/tmp/sambafax.$$

# retrieve the username and hostname from the paramaters
Username=$2
 
# if the samba user is anonymous then send mail to the postmaster
if [ "$Username" = "nobody" ];
   then
    MailTo="postmaster"
   else
    MailTo=${Username}
fi
 
# now dump the to-be faxed data (PS format) to the temp file
cat >${FAXFILE}       # this comes from the pipe (local mission)
cat $6 >>${FAXFILE}   # or this comes from samba as a file

# retrieve the faxnumber from the printfile
# the silly three x's are added because some awk strugle with an immediate CR
# we use a PS to ascii pipe to strip (most of) the Postscript controls
FAXNUM=`${PS2ASCII} ${FAXFILE} | ${AWK} '{ IGNORECASE=1 } /FAX-Nr ?: ?[0-9-]*/ \
         {  $0=$0 "xxx"; \
            gsub(/-/,""); \
            anfang=match($0,/ ?: ?/); \
            anfang=anfang+match(substr($0,anfang),/[0-9]/)-1; \
            ende=match(substr($0,anfang),/[^0-9]/)-1; \
            printf ("%s",substr($0,anfang,ende)) \
         }' `
 
# if faxnumber is found fax the tempfile
# we do not check the validity of the faxnumber; let sendfax do this...
if [ "${FAXNUM}" = "" ] ; then
    (echo "To: ${MailTo}"
     echo "From: HylaFAX Service"
     echo "Subject: your facsimile request failed"
     echo ""
     echo "The faxnumber is not recognized in your fax of"
     echo `date`
     echo ""
     echo "The faxnumber is recognised via this text:"
     echo "   Fax-Nr : ddd-ddddddd"
     echo "No spaces or characters are allowed between the digits, just a -"
     echo ""
     echo "Please correct and retry"
    ) | 2>&1 ${SENDMAIL} -ffax -oi ${MailTo}
else
  ${SENDFAX} -n -D -f ${MailTo} -d ${FAXNUM} ${FAXFILE}
fi
 
# remove the temp file
rm -f ${FAXFILE}
=end ---------------------------------------------------------------------------

################################################################################
################################################################################
################################################################################
################################################################################
###                                                                          ###
###                          The End (Or is it?)                             ###
###                                                                          ###
################################################################################
################################################################################
################################################################################
################################################################################
